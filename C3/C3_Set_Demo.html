<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 í™˜ê²½ ëŒ€ì‹œë³´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <style>
    :root {
      --bg: #f5f5f5;
      --fg: #111827;
      --subtle: #6b7280;
      --muted: #9ca3af;
      --card-bg: #ffffff;
      --metric-bg: #fafafa;
      --shadow: 0 2px 6px rgba(0,0,0,0.08);
      --log-bg: #111827;
      --log-fg: #e5e7eb;
      --border-soft: rgba(0,0,0,0.06);
      --accent: #3b82f6;
      --alarm: #ef4444;
    }
    body[data-theme="dark"] {
      --bg: #020617;
      --fg: #e5e7eb;
      --subtle: #9ca3af;
      --muted: #6b7280;
      --card-bg: #020617;
      --metric-bg: #020617;
      --shadow: 0 2px 10px rgba(0,0,0,0.55);
      --log-bg: #020617;
      --log-fg: #e5e7eb;
      --border-soft: rgba(148,163,184,0.4);
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--fg);
      transition: background .25s,color .25s;
    }
    h1 { margin: 0 0 4px; font-size: 1.5rem; }
    .page-header {
      display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;
    }
    .card {
      background: var(--card-bg);
      border-radius:12px;
      padding:16px;
      box-shadow:var(--shadow);
      border:1px solid var(--border-soft);
      margin-bottom:16px;
    }
    .status-dot { width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;background:#9ca3af; }
    .status-ok { background:#22c55e;}
    .status-bad{ background:#ef4444;}
    .mqtt-lines{font-size:.9rem;line-height:1.4;}
    .mqtt-line-main{display:flex;align-items:center;gap:6px;margin-bottom:2px;}
    .mqtt-spacer{flex:1;}
    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:12px;
    }
    .metric {
      background:var(--metric-bg);
      border-radius:10px;
      padding:10px;
      text-align:center;
      border:1px solid var(--border-soft);
    }
    .metric-label{font-size:.8rem;color:var(--subtle);}
    .metric-value{font-size:1.3rem;font-weight:600;margin-top:4px;}

    .metric-alarmable{cursor:pointer;}
    .metric-alarmable:hover{border-color:rgba(59,130,246,0.6);}
    .metric-alarmable .metric-label::after{
      content:" â€¢ ì•ŒëŒ";
      font-size:.7rem;
      color:var(--muted);
    }
    .metric-alarm-value.alarm-active{
      color:var(--alarm);
      font-weight:700;
    }

    button{
      border:none;border-radius:999px;padding:8px 16px;font-size:.9rem;cursor:pointer;
      margin-right:8px;margin-top:8px;display:inline-flex;align-items:center;gap:4px;
      transition:transform .08s,box-shadow .12s,background .2s,color .2s;
    }
    button:active{transform:translateY(1px);box-shadow:none;}
    #btnOn{
      background:#22c55e;color:#fff;box-shadow:0 2px 6px rgba(34,197,94,.4);
    }
    #btnOff{
      background:#ef4444;color:#fff;box-shadow:0 2px 6px rgba(239,68,68,.4);
    }

    .theme-toggle{
      background:transparent;color:var(--subtle);border-radius:999px;border:1px solid var(--border-soft);
      padding:6px 10px;font-size:.8rem;box-shadow:none;display:inline-flex;align-items:center;justify-content:center;
    }
    .theme-toggle-icon{font-size:1.1rem;}

    .icon-button{
      padding:6px 10px;border-radius:999px;background:transparent;border:1px solid var(--border-soft);
      color:var(--subtle);font-size:.85rem;box-shadow:none;margin-top:0;
    }
    .icon-button.active{background:var(--accent);color:#fff;border-color:var(--accent);}
    .icon-button-small{padding:2px 8px;font-size:.7rem;margin-right:0;}

    #log{
      font-family:ui-monospace,Menlo,Consolas,"Courier New",monospace;
      font-size:.8rem;max-height:260px;overflow-y:auto;
      background:var(--log-bg);color:var(--log-fg);padding:8px;border-radius:8px;
      white-space:pre-wrap;border:1px solid var(--border-soft);
    }

    .toolbar{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;}
    .toolbar-left,.toolbar-right{display:flex;align-items:center;gap:8px;}

    .hidden{display:none!important;}
    .log-card{border:none;box-shadow:none;background:transparent;padding-top:0;}

    .led-card{padding:10px 16px 8px;}
    .led-card h2{margin:0 0 4px;font-size:1.05rem;}
    .led-row{display:flex;align-items:flex-end;gap:8px;flex-wrap:wrap;}
    .led-buttons{display:flex;gap:8px;}
    .cmd-status{font-size:.75rem;color:var(--subtle);min-height:1.2em;margin-top:8px;}

    .chart-grid{display:flex;flex-direction:column;gap:12px;}
    .chart-block{border-radius:10px;border:1px solid var(--border-soft);padding:8px 10px 10px;background:var(--metric-bg);}
    .chart-block h3{margin:0 0 4px;font-size:.9rem;color:var(--subtle);}
    .chart-wrapper{position:relative;width:100%;aspect-ratio:16/9;overflow:hidden;}
    .chart-wrapper canvas{position:absolute;inset:0;width:100%!important;height:100%!important;}

    .table-scroll{max-height:260px;overflow-y:auto;overflow-x:auto;}
    .history-table{width:100%;border-collapse:collapse;font-size:.75rem;table-layout:fixed;}
    .history-table thead{position:sticky;top:0;background:var(--card-bg);z-index:1;}
    .history-table th,.history-table td{
      padding:3px 4px;border-bottom:1px solid var(--border-soft);text-align:right;white-space:nowrap;
    }
    .history-table th{font-size:.72rem;line-height:1.25;}
    .history-table th .th-label{display:block;}
    .history-table th .th-unit{display:block;font-size:.65rem;color:var(--muted);}
    .history-table th:first-child,.history-table td:first-child{text-align:left;}
    .history-table td{font-size:.72rem;}

    .modal-backdrop{
      position:fixed;inset:0;background:rgba(15,23,42,.55);display:flex;align-items:center;justify-content:center;z-index:50;
    }
    .modal{
      background:var(--card-bg);color:var(--fg);border-radius:12px;padding:16px 18px 14px;
      width:min(360px,90vw);box-shadow:var(--shadow);border:1px solid var(--border-soft);
    }
    .modal-title{font-size:1rem;font-weight:600;margin:0 0 8px;}
    .modal-desc{font-size:.85rem;color:var(--subtle);margin-bottom:12px;}
    .field-row{display:flex;gap:8px;margin-bottom:8px;}
    .field{flex:1;}
    .field label{display:block;font-size:.75rem;color:var(--subtle);margin-bottom:2px;}
    .field input{
      width:100%;padding:6px 8px;border-radius:8px;border:1px solid var(--border-soft);
      background:var(--bg);color:var(--fg);font-size:.85rem;
    }
    .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:8px;}
    .btn-primary{background:var(--accent);color:#fff;box-shadow:0 2px 6px rgba(37,99,235,.4);}
    .btn-ghost{background:transparent;border:1px solid var(--border-soft);color:var(--subtle);box-shadow:none;}
  </style>
</head>
<body data-theme="dark">
<header class="page-header">
  <h1>ESP32 í™˜ê²½ ëŒ€ì‹œë³´ë“œ</h1>
  <button id="themeToggle" class="theme-toggle" type="button"><span class="theme-toggle-icon">ğŸŒ™</span></button>
</header>

<!-- MQTT/ì¥ë¹„ ìƒíƒœ -->
<div class="card">
  <div class="mqtt-lines">
    <div class="mqtt-line-main">
      <span id="mqttDot" class="status-dot"></span>
      <strong id="mqttState">MQTT ì—°ê²° ëŒ€ê¸° ì¤‘...</strong>
      <span class="mqtt-spacer"></span>
      <button id="btnSoftReset" class="icon-button icon-button-small" type="button">RESET</button>
    </div>
    <div style="font-size:.85rem;color:var(--subtle);">
      ì¥ë¹„ ìƒíƒœ: <span id="deviceState">ì•Œ ìˆ˜ ì—†ìŒ</span>
      &nbsp;&nbsp; RSSI: <span id="headerRssi">--</span> dBm
    </div>
    <div style="font-size:.85rem;color:var(--subtle);">
      ìˆ˜ì‹  ì‹œê°: <span id="lastUpdate">-</span>
    </div>
  </div>
</div>

<!-- ì„¼ì„œ ìƒíƒœ -->
<div class="card">
  <h2 style="font-size:1.1rem;margin:0 0 6px;">ì„¼ì„œ ìƒíƒœ (esp32c3/status)</h2>
  <div class="grid">
    <div class="metric metric-alarmable" data-key="temp" data-label="ì˜¨ë„" data-unit="Â°C">
      <div class="metric-label">ì˜¨ë„</div>
      <div class="metric-value"><span id="valTemp" class="metric-alarm-value">--</span> Â°C</div>
    </div>
    <div class="metric metric-alarmable" data-key="hum" data-label="ìŠµë„" data-unit="%">
      <div class="metric-label">ìŠµë„</div>
      <div class="metric-value"><span id="valHum" class="metric-alarm-value">--</span> %</div>
    </div>
    <div class="metric metric-alarmable" data-key="co2" data-label="COâ‚‚" data-unit="ppm">
      <div class="metric-label">COâ‚‚</div>
      <div class="metric-value"><span id="valCo2" class="metric-alarm-value">--</span> ppm</div>
    </div>
    <div class="metric metric-alarmable" data-key="solar" data-label="ì¼ì‚¬ëŸ‰" data-unit="W/mÂ²">
      <div class="metric-label">ì¼ì‚¬ëŸ‰</div>
      <div class="metric-value"><span id="valSolar" class="metric-alarm-value">--</span> W/mÂ²</div>
    </div>
    <div class="metric">
      <div class="metric-label">LED ìƒíƒœ</div>
      <div class="metric-value"><span id="valLed">--</span></div>
    </div>
    <div class="metric">
      <div class="metric-label">WiFi RSSI</div>
      <div class="metric-value"><span id="valRssi">--</span> dBm</div>
    </div>
  </div>
</div>

<!-- LED ì œì–´ -->
<div class="card led-card">
  <h2>LED ì œì–´ (esp32c3/led)</h2>
  <div class="led-row">
    <div class="led-buttons">
      <button id="btnOn">LED ON</button>
      <button id="btnOff">LED OFF</button>
    </div>
    <div id="cmdResult" class="cmd-status">ì „ì†¡ ìƒíƒœ: -</div>
  </div>
</div>

<!-- íˆ´ë°” -->
<div class="toolbar">
  <div class="toolbar-left">
    <button id="btnShowTable" class="icon-button" type="button">ğŸ“‹ í…Œì´ë¸”</button>
    <button id="btnShowChart" class="icon-button" type="button">ğŸ“Š ê·¸ë˜í”„</button>
  </div>
  <div class="toolbar-right">
    <button id="btnToggleLog" class="icon-button" type="button">ğŸ ë¡œê·¸</button>
  </div>
</div>

<!-- 1ë¶„ í‰ê·  í…Œì´ë¸” -->
<div class="card hidden" id="tableCard">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
    <h2 style="font-size:1.1rem;margin:0;">1ë¶„ í‰ê·  (ìµœê·¼ 60ë¶„)</h2>
  </div>
  <div class="table-scroll">
    <table class="history-table">
      <thead>
      <tr>
        <th><span class="th-label">ì‹œê°„</span><span class="th-unit">&nbsp;</span></th>
        <th><span class="th-label">ì˜¨ë„</span><span class="th-unit">(Â°C)</span></th>
        <th><span class="th-label">ìŠµë„</span><span class="th-unit">(%)</span></th>
        <th><span class="th-label">COâ‚‚</span><span class="th-unit">(ppm)</span></th>
        <th><span class="th-label">ì¼ì‚¬ëŸ‰</span><span class="th-unit">(W/mÂ²)</span></th>
        <th><span class="th-label">LED</span><span class="th-unit">(ìƒíƒœ)</span></th>
        <th><span class="th-label">RSSI</span><span class="th-unit">(dBm)</span></th>
      </tr>
      </thead>
      <tbody id="historyTableBody"></tbody>
    </table>
  </div>
</div>

<!-- ê·¸ë˜í”„ -->
<div class="card hidden" id="chartCard">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
    <div>
      <h2 style="font-size:1.1rem;margin:0;">ì˜¨ë„/ìŠµë„/COâ‚‚/ì¼ì‚¬ëŸ‰ ê·¸ë˜í”„</h2>
      <div style="font-size:.8rem;color:var(--subtle);">1ë¶„ í‰ê· , ìµœê·¼ 60ë¶„ (ESP32 íˆìŠ¤í† ë¦¬ ê¸°ì¤€)</div>
    </div>
  </div>
  <div class="chart-grid">
    <div class="chart-block">
      <h3>ì˜¨ë„ (Â°C)</h3>
      <div class="chart-wrapper"><canvas id="tempChart"></canvas></div>
    </div>
    <div class="chart-block">
      <h3>ìŠµë„ (%)</h3>
      <div class="chart-wrapper"><canvas id="humChart"></canvas></div>
    </div>
    <div class="chart-block">
      <h3>COâ‚‚ (ppm)</h3>
      <div class="chart-wrapper"><canvas id="co2Chart"></canvas></div>
    </div>
    <div class="chart-block">
      <h3>ì¼ì‚¬ëŸ‰ (W/mÂ²)</h3>
      <div class="chart-wrapper"><canvas id="solarChart"></canvas></div>
    </div>
  </div>
</div>

<!-- ë¡œê·¸ -->
<div class="card log-card hidden" id="logCard">
  <div id="log"></div>
</div>

<!-- ì•ŒëŒ ì„¤ì • ëª¨ë‹¬ -->
<div id="alarmModalBackdrop" class="modal-backdrop hidden">
  <div class="modal">
    <h3 class="modal-title"><span id="alarmMetricLabel">ì˜¨ë„</span> ì•ŒëŒ ì„¤ì •</h3>
    <p class="modal-desc">
      ìƒí•œ/í•˜í•œ ê°’ì„ ì„¤ì •í•˜ë©´ ë²”ìœ„ë¥¼ ë²—ì–´ë‚  ë•Œ ì„¼ì„œ ê°’ì´
      <span style="color:var(--alarm);font-weight:600;">ë¹¨ê°„ìƒ‰</span>ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
      ë¹ˆ ì¹¸ì€ ë¬´ì‹œë©ë‹ˆë‹¤.
    </p>
    <div class="field-row">
      <div class="field">
        <label for="alarmLow">í•˜í•œê°’</label>
        <input id="alarmLow" type="number" step="0.1" placeholder="ì˜ˆ: 18.0">
      </div>
      <div class="field">
        <label for="alarmHigh">ìƒí•œê°’</label>
        <input id="alarmHigh" type="number" step="0.1" placeholder="ì˜ˆ: 28.0">
      </div>
    </div>
    <div style="font-size:.8rem;color:var(--muted);margin-top:2px;">
      ë‹¨ìœ„: <span id="alarmUnitLabel">Â°C</span>
    </div>
    <div class="modal-actions">
      <button id="alarmCancel" type="button" class="btn-ghost">ì·¨ì†Œ</button>
      <button id="alarmSave" type="button" class="btn-primary">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
  const $ = (s)=>document.querySelector(s);

  // ==== í…Œë§ˆ ====
  const themeToggleBtn  = $("#themeToggle");
  const themeToggleIcon = themeToggleBtn.querySelector(".theme-toggle-icon");

  function applyTheme(theme){
    document.body.setAttribute("data-theme", theme);
    themeToggleIcon.textContent = theme==="dark" ? "ğŸŒ™" : "ğŸŒ";
  }
  (function initTheme(){
    const saved = localStorage.getItem("esp32-dashboard-theme");
    const t = (saved === "dark" || saved === "light") ? saved : "dark";
    applyTheme(t);
  })();
  themeToggleBtn.addEventListener("click",()=>{
    const cur = document.body.getAttribute("data-theme") || "dark";
    const next = cur === "dark" ? "light" : "dark";
    localStorage.setItem("esp32-dashboard-theme",next);
    applyTheme(next);
  });

  // ==== UI ìš”ì†Œ ====
  const mqttDotEl      = $("#mqttDot");
  const mqttStateEl    = $("#mqttState");
  const deviceStateEl  = $("#deviceState");
  const lastUpdateEl   = $("#lastUpdate");
  const headerRssiEl   = $("#headerRssi");
  const logEl          = $("#log");
  const cmdResultEl    = $("#cmdResult");

  const valTemp  = $("#valTemp");
  const valHum   = $("#valHum");
  const valCo2   = $("#valCo2");
  const valSolar = $("#valSolar");
  const valLed   = $("#valLed");
  const valRssi  = $("#valRssi");
  const btnOn    = $("#btnOn");
  const btnOff   = $("#btnOff");
  const btnSoftReset = $("#btnSoftReset");

  const btnShowTable = $("#btnShowTable");
  const btnShowChart = $("#btnShowChart");
  const btnToggleLog = $("#btnToggleLog");
  const tableCard    = $("#tableCard");
  const chartCard    = $("#chartCard");
  const logCard      = $("#logCard");

  const alarmModalBackdrop = $("#alarmModalBackdrop");
  const alarmMetricLabelEl = $("#alarmMetricLabel");
  const alarmUnitLabelEl   = $("#alarmUnitLabel");
  const alarmLowInput      = $("#alarmLow");
  const alarmHighInput     = $("#alarmHigh");
  const alarmCancelBtn     = $("#alarmCancel");
  const alarmSaveBtn       = $("#alarmSave");
  const historyTableBody   = $("#historyTableBody");

  // ==== ë¡œê·¸ ====
  function log(msg){
    const time = new Date().toLocaleTimeString("ko-KR",{hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"});
    logEl.textContent += `[${time}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
    console.log(msg);
  }

  function setMqttStatus(ok,text){
    mqttDotEl.classList.remove("status-ok","status-bad");
    mqttDotEl.classList.add(ok?"status-ok":"status-bad");
    mqttStateEl.textContent = text;
  }
  function setDeviceState(alive){
    if(alive){
      deviceStateEl.textContent = "ì˜¨ë¼ì¸";
      deviceStateEl.style.color = "#16a34a";
    }else{
      deviceStateEl.textContent = "ì˜¤í”„ë¼ì¸";
      deviceStateEl.style.color = "#dc2626";
    }
  }

  function formatDisplayTime12(d){
    return d.toLocaleString("ko-KR",{
      year:"numeric",month:"2-digit",day:"2-digit",
      hour:"2-digit",minute:"2-digit",second:"2-digit",
      hour12:true
    });
  }
  function formatTimeHHMM(d){
    return d.toLocaleTimeString("ko-KR",{hour12:false,hour:"2-digit",minute:"2-digit"});
  }

  // ==== MQTT ì—°ê²° ====
  const brokerUrl = "wss://broker.hivemq.com:8884/mqtt";
  const options = { clean:true, connectTimeout:4000, reconnectPeriod:5000 };
  const client = mqtt.connect(brokerUrl, options);

  let lastDeviceMsgAt = null;

  client.on("connect",()=>{
    setMqttStatus(true,"MQTT ì—°ê²° OK");
    log("MQTT ì—°ê²° ì„±ê³µ");
    client.subscribe("esp32c3/status");
    client.subscribe("esp32c3/history");
    client.subscribe("esp32c3/config/alarm");
    // ESP32ì˜ 60ë¶„ íˆìŠ¤í† ë¦¬ ìš”ì²­
    try{
      client.publish("esp32c3/history/get","GET");
      log("íˆìŠ¤í† ë¦¬ GET ìš”ì²­ ì „ì†¡");
    }catch(e){
      log("íˆìŠ¤í† ë¦¬ GET ìš”ì²­ ì‹¤íŒ¨: "+e.message);
    }
  });
  client.on("reconnect",()=>{
    setMqttStatus(false,"MQTT ì¬ì—°ê²° ì‹œë„ ì¤‘...");
    log("ì¬ì—°ê²° ì‹œë„...");
  });
  client.on("error",(err)=>{
    setMqttStatus(false,"MQTT ì—ëŸ¬");
    log("ì—ëŸ¬: "+err.message);
  });
  client.on("close",()=>{
    setMqttStatus(false,"MQTT ì—°ê²° ëŠê¹€");
    log("MQTT ì—°ê²° ëŠê¹€");
  });

  // ==== ì•ŒëŒ ì„¤ì • (localStorageì—ë§Œ ì €ì¥) ====
  const ALARM_LS_KEY = "esp32_alarm_config_v1";
  const alarmConfig = {
    temp: {low:null, high:null},
    hum:  {low:null, high:null},
    co2:  {low:null, high:null},
    solar:{low:null, high:null}
  };
  let currentAlarmKey = null;

  function loadAlarmFromLocal(){
    try{
      const raw = localStorage.getItem(ALARM_LS_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      ["temp","hum","co2","solar"].forEach(k=>{
        if(obj && obj[k]){
          alarmConfig[k] = { low:obj[k].low ?? null, high:obj[k].high ?? null };
        }
      });
      applyAlarms();
      log("ë¸Œë¼ìš°ì € ì €ì¥ ì•ŒëŒ ì„¤ì • ë³µì›: "+JSON.stringify(alarmConfig));
    }catch(e){ console.warn("ì•ŒëŒ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:", e); }
  }
  function saveAlarmToLocal(){
    try{ localStorage.setItem(ALARM_LS_KEY, JSON.stringify(alarmConfig)); }
    catch(e){ console.warn("ì•ŒëŒ ì„¤ì • ì €ì¥ ì‹¤íŒ¨:", e); }
  }

  function openAlarmModal(key,label,unit){
    currentAlarmKey = key;
    alarmMetricLabelEl.textContent = label;
    alarmUnitLabelEl.textContent   = unit;
    const cfg = alarmConfig[key] || {low:null,high:null};
    alarmLowInput.value  = cfg.low  ?? "";
    alarmHighInput.value = cfg.high ?? "";
    alarmModalBackdrop.classList.remove("hidden");
  }
  function closeAlarmModal(){ alarmModalBackdrop.classList.add("hidden"); }
  alarmCancelBtn.addEventListener("click",closeAlarmModal);
  alarmModalBackdrop.addEventListener("click",(e)=>{
    if(e.target === alarmModalBackdrop) closeAlarmModal();
  });

  alarmSaveBtn.addEventListener("click",()=>{
    if(!currentAlarmKey) return;
    const lowStr  = alarmLowInput.value.trim();
    const highStr = alarmHighInput.value.trim();
    const cfg = alarmConfig[currentAlarmKey];
    cfg.low  = lowStr  === "" ? null : Number(lowStr);
    cfg.high = highStr === "" ? null : Number(highStr);
    saveAlarmToLocal();

    const payload = {
      type: "alarm_config",
      temp:  alarmConfig.temp,
      hum:   alarmConfig.hum,
      co2:   alarmConfig.co2,
      solar: alarmConfig.solar
    };
    if(client.connected){
      client.publish("esp32c3/config/alarm", JSON.stringify(payload));
      log("ì•ŒëŒ ì„¤ì • ì „ì†¡: "+JSON.stringify(payload));
    }else{
      log("ì•ŒëŒ ì„¤ì • ì „ì†¡ ì‹¤íŒ¨: MQTT ë¯¸ì—°ê²°");
    }
    applyAlarms();
    closeAlarmModal();
  });

  function handleAlarmConfigMessage(obj){
    if(!obj) return;
    if(obj.temp)  alarmConfig.temp  = {low:obj.temp.low ?? null,  high:obj.temp.high ?? null};
    if(obj.hum)   alarmConfig.hum   = {low:obj.hum.low ?? null,   high:obj.hum.high ?? null};
    if(obj.co2)   alarmConfig.co2   = {low:obj.co2.low ?? null,   high:obj.co2.high ?? null};
    if(obj.solar) alarmConfig.solar = {low:obj.solar.low ?? null, high:obj.solar.high ?? null};
    saveAlarmToLocal();
    applyAlarms();
  }

  const alarmState = {temp:false,hum:false,co2:false,solar:false};
  function checkMetricAlarm(key,value,valueEl){
    const cfg = alarmConfig[key];
    if(!cfg || isNaN(value)){
      valueEl.classList.remove("alarm-active");
      alarmState[key] = false;
      return;
    }
    let alarm = false;
    if(cfg.low  != null && value < cfg.low)  alarm = true;
    if(cfg.high != null && value > cfg.high) alarm = true;
    alarmState[key] = alarm;
    if(alarm) valueEl.classList.add("alarm-active");
    else      valueEl.classList.remove("alarm-active");
  }
  function applyAlarms(){
    const t = parseFloat(valTemp.textContent);
    const h = parseFloat(valHum.textContent);
    const c = parseFloat(valCo2.textContent);
    const s = parseFloat(valSolar.textContent);
    checkMetricAlarm("temp",  t, valTemp);
    checkMetricAlarm("hum",   h, valHum);
    checkMetricAlarm("co2",   c, valCo2);
    checkMetricAlarm("solar", s, valSolar);
  }
  document.querySelectorAll(".metric-alarmable").forEach(el=>{
    el.addEventListener("click",()=>{
      const key   = el.getAttribute("data-key");
      const label = el.getAttribute("data-label") || key;
      const unit  = el.getAttribute("data-unit") || "";
      openAlarmModal(key,label,unit);
    });
  });

  // ==== íˆìŠ¤í† ë¦¬ (ESP32 ë°ì´í„°ë§Œ ì‚¬ìš©) ====
  let historyData = [];
  const HISTORY_MAX_MINUTES  = 60;
  const BUCKET_MS            = 60*1000;
  const HISTORY_WINDOW_MS    = 60*60*1000;
  let currentBucket = null;

  function createNewBucket(nowMs){
    return {
      startMs: nowMs - (nowMs % BUCKET_MS),
      sampleCount:0,
      tempSum:0,tempCnt:0,
      humSum:0,humCnt:0,
      co2Sum:0,co2Cnt:0,
      solarSum:0,solarCnt:0,
      rssiSum:0,rssiCnt:0,
      lastLed:false
    };
  }
  function bucketToRecord(b){
    const tsMs = b.startMs + BUCKET_MS;
    return {
      ts:   tsMs,
      temp:  b.tempCnt  ? b.tempSum  / b.tempCnt  : null,
      hum:   b.humCnt   ? b.humSum   / b.humCnt   : null,
      co2:   b.co2Cnt   ? b.co2Sum   / b.co2Cnt   : null,
      solar: b.solarCnt ? b.solarSum / b.solarCnt : null,
      rssi:  b.rssiCnt  ? b.rssiSum  / b.rssiCnt  : null,
      led:   b.lastLed
    };
  }

  function keyOfRec(rec){
    const ts = rec.ts || Date.now();
    return Math.floor(ts / BUCKET_MS);
  }

  function trimHistoryByTime(){
    if(historyData.length === 0) return;
    const nowMs = Date.now();
    const cutoff = nowMs - HISTORY_WINDOW_MS;
    historyData = historyData.filter(rec=> (rec.ts || nowMs) >= cutoff);
  }

  function getDisplayHistory(){
    const result = historyData.slice();
    if(currentBucket && currentBucket.sampleCount>0){
      result.push(bucketToRecord(currentBucket));
    }
    return result;
  }

  function addHistorySampleFromStatus(temp,hum,co2,solar,rssi,led){
    const nowMs = Date.now();
    if(!currentBucket){
      currentBucket = createNewBucket(nowMs);
    }else if(nowMs - currentBucket.startMs >= BUCKET_MS){
      if(currentBucket.sampleCount>0){
        pushMergedRecords([bucketToRecord(currentBucket)]);
      }
      currentBucket = createNewBucket(nowMs);
    }
    currentBucket.sampleCount++;
    if(!isNaN(temp)){  currentBucket.tempSum  += temp;  currentBucket.tempCnt++; }
    if(!isNaN(hum)){   currentBucket.humSum   += hum;   currentBucket.humCnt++; }
    if(!isNaN(co2)){   currentBucket.co2Sum   += co2;   currentBucket.co2Cnt++; }
    if(!isNaN(solar)){ currentBucket.solarSum += solar; currentBucket.solarCnt++; }
    if(!isNaN(rssi)){  currentBucket.rssiSum  += rssi;  currentBucket.rssiCnt++; }
    currentBucket.lastLed = !!led;
    rebuildTableAndCharts();
  }

  function pushMergedRecords(newRecords){
    if(!newRecords || !newRecords.length) return;
    const map = new Map();
    historyData.forEach(rec=>{ map.set(keyOfRec(rec), rec); });
    newRecords.forEach(rec=>{ map.set(keyOfRec(rec), rec); }); // ìƒˆ ë°ì´í„°ë¡œ ë®ì–´ì“°ê¸°
    historyData = Array.from(map.values()).sort((a,b)=> (a.ts||0)-(b.ts||0));
    trimHistoryByTime();
    if(historyData.length>HISTORY_MAX_MINUTES){
      historyData.splice(0, historyData.length-HISTORY_MAX_MINUTES);
    }
  }

  function rebuildTable(){
    const data = getDisplayHistory();
    historyTableBody.innerHTML = "";
    const N = data.length;
    if(N===0) return;
    for(let i=N-1;i>=0;i--){
      const rec = data[i];
      const t = new Date(rec.ts || Date.now());
      const timeLabel = formatTimeHHMM(t);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${timeLabel}</td>
        <td>${rec.temp  != null ? Number(rec.temp).toFixed(0)  : "-"}</td>
        <td>${rec.hum   != null ? Number(rec.hum).toFixed(0)   : "-"}</td>
        <td>${rec.co2   != null ? Number(rec.co2).toFixed(0)   : "-"}</td>
        <td>${rec.solar != null ? Number(rec.solar).toFixed(0) : "-"}</td>
        <td>${rec.led   ? "ON" : "OFF"}</td>
        <td>${rec.rssi  != null ? Number(rec.rssi).toFixed(0)  : "-"}</td>
      `;
      historyTableBody.appendChild(tr);
    }
  }

  // ==== Chart ====
  let tempChart=null,humChart=null,co2Chart=null,solarChart=null;
  function createChart(ctx,label,borderColor,bgColor,yTitle){
    return new Chart(ctx,{
      type:"line",
      data:{ labels:[], datasets:[{
        label, data:[],
        borderColor, borderWidth:2,
        backgroundColor:bgColor,
        tension:0.2, spanGaps:true,
        pointRadius:0, pointHoverRadius:0, pointHitRadius:6
      }]},
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{
          legend:{display:false},
          tooltip:{callbacks:{label:(ctx)=>{
            const v=ctx.parsed.y;
            if(v==null) return `${label}: -`;
            return `${label}: ${Math.round(v)}`;
          }}}
        },
        scales:{
          x:{
            title:{display:true,text:"ì‹œê°„ (24ì‹œ)",color:"#6b7280",font:{size:11}},
            ticks:{color:"#6b7280",maxRotation:45,minRotation:45,autoSkip:true,maxTicksLimit:8},
            grid:{color:"rgba(148,163,184,0.25)"}
          },
          y:{
            title:{display:true,text:yTitle,color:"#6b7280",font:{size:11}},
            ticks:{color:"#6b7280"},
            grid:{color:"rgba(148,163,184,0.25)"}
          }
        }
      }
    });
  }
  function ensureChartsInitialized(){
    if(tempChart && humChart && co2Chart && solarChart){ updateCharts(); return; }
    tempChart  = createChart($("#tempChart").getContext("2d"), "ì˜¨ë„",   "#f97316","rgba(249,115,22,0.15)","ì˜¨ë„ (Â°C)");
    humChart   = createChart($("#humChart").getContext("2d"),  "ìŠµë„",   "#22c55e","rgba(34,197,94,0.15)","ìŠµë„ (%)");
    co2Chart   = createChart($("#co2Chart").getContext("2d"),  "COâ‚‚",    "#3b82f6","rgba(59,130,246,0.15)","COâ‚‚ (ppm)");
    solarChart = createChart($("#solarChart").getContext("2d"),"ì¼ì‚¬ëŸ‰", "#eab308","rgba(234,179,8,0.15)","ì¼ì‚¬ëŸ‰ (W/mÂ²)");
    updateCharts();
  }
  function updateCharts(){
    if(!tempChart || !humChart || !co2Chart || !solarChart) return;
    const data = getDisplayHistory();
    const labels=[], temps=[], hums=[], co2s=[], solars=[];
    for(const rec of data){
      const t = new Date(rec.ts || Date.now());
      labels.push(formatTimeHHMM(t));
      temps.push(  rec.temp  != null ? Number(rec.temp)  : null);
      hums.push(   rec.hum   != null ? Number(rec.hum)   : null);
      co2s.push(   rec.co2   != null ? Number(rec.co2)   : null);
      solars.push( rec.solar != null ? Number(rec.solar) : null);
    }
    [tempChart,humChart,co2Chart,solarChart].forEach(c=>{ c.data.labels = labels; });
    tempChart.data.datasets[0].data  = temps;
    humChart.data.datasets[0].data   = hums;
    co2Chart.data.datasets[0].data   = co2s;
    solarChart.data.datasets[0].data = solars;
    tempChart.update(); humChart.update(); co2Chart.update(); solarChart.update();
  }

  // ==== view / ë¡œê·¸ ====
  let viewMode = null;
  function setViewMode(mode){
    viewMode = mode;
    if(mode==="table"){
      tableCard.classList.remove("hidden");
      chartCard.classList.add("hidden");
      btnShowTable.classList.add("active");
      btnShowChart.classList.remove("active");
      rebuildTable();
      tableCard.scrollIntoView({behavior:"smooth",block:"start"});
    }else if(mode==="chart"){
      chartCard.classList.remove("hidden");
      tableCard.classList.add("hidden");
      btnShowChart.classList.add("active");
      btnShowTable.classList.remove("active");
      ensureChartsInitialized();
      chartCard.scrollIntoView({behavior:"smooth",block:"start"});
    }else{
      tableCard.classList.add("hidden");
      chartCard.classList.add("hidden");
      btnShowTable.classList.remove("active");
      btnShowChart.classList.remove("active");
    }
  }
  btnShowTable.addEventListener("click",()=>{ setViewMode(viewMode==="table"?null:"table"); });
  btnShowChart.addEventListener("click",()=>{ setViewMode(viewMode==="chart"?null:"chart"); });

  let logVisible=false;
  btnToggleLog.addEventListener("click",()=>{
    logVisible=!logVisible;
    logCard.classList.toggle("hidden",!logVisible);
    btnToggleLog.classList.toggle("active",logVisible);
    if(logVisible) logCard.scrollIntoView({behavior:"smooth",block:"start"});
  });

  // ==== JSON helper ====
  JSON.parseSafe = function(str){
    try{ return JSON.parse(str); }
    catch(e){ log("JSON íŒŒì‹± ì‹¤íŒ¨: "+e.message); return null;}
  };

  // ==== MQTT ë©”ì‹œì§€ ì²˜ë¦¬ ====
  client.on("message",(topic,payload)=>{
    const text = new TextDecoder().decode(payload);
    log(`ìˆ˜ì‹  (${topic}): ${text}`);
    if(topic==="esp32c3/status")      handleStatusMessage(text);
    else if(topic==="esp32c3/history")handleHistoryMessage(text);
    else if(topic==="esp32c3/config/alarm")handleAlarmConfigMessage(JSON.parseSafe(text));
  });

  function handleStatusMessage(text){
    const fixed = text.replace(/"rssi"\s*:\s*}/,'"rssi":null}');
    const data  = JSON.parseSafe(fixed);
    if(!data) return;
    lastDeviceMsgAt = Date.now();
    setDeviceState(data.alive !== false);

    const now = new Date();
    lastUpdateEl.textContent = formatDisplayTime12(now);

    const temp  = Number(data.temp);
    const hum   = Number(data.hum);
    const co2   = Number(data.co2);
    const solar = Number(data.solar);
    const led   = !!data.led;
    const rssi  = Number(data.rssi);

    if(!isNaN(temp))  valTemp.textContent  = temp.toFixed(0);
    if(!isNaN(hum))   valHum.textContent   = hum.toFixed(0);
    if(!isNaN(co2))   valCo2.textContent   = co2.toFixed(0);
    if(!isNaN(solar)) valSolar.textContent = solar.toFixed(0);
    valLed.textContent = led ? "ON" : "OFF";
    if(!isNaN(rssi)){
      valRssi.textContent   = rssi.toFixed(0);
      headerRssiEl.textContent = valRssi.textContent;
    }
    applyAlarms();
    addHistorySampleFromStatus(temp,hum,co2,solar,rssi,led);
  }

  function handleHistoryMessage(text){
    const obj = JSON.parseSafe(text);
    if(!obj || obj.type!=="history" || !Array.isArray(obj.data)) return;
    const arr = obj.data;
    if(arr.length===0) return;
    lastDeviceMsgAt = Date.now();
    setDeviceState(true);

    const nowMs = Date.now();
    let hasTs=false, hasIdx=false;
    for(const it of arr){
      if(it && it.ts  != null) hasTs = true;
      if(it && it.idx != null) hasIdx = true;
    }

    let newRecords=[];
    if(hasTs){
      newRecords = arr.map(item=>({
        ts:    (item.ts || 0)*1000,
        temp:  item.temp  ?? null,
        hum:   item.hum   ?? null,
        co2:   item.co2   ?? null,
        solar: item.solar ?? null,
        rssi:  item.rssi  ?? null,
        led:   !!item.led
      }));
    }else if(hasIdx){
      let maxIdx=-Infinity;
      arr.forEach(it=>{ if(typeof it.idx==="number" && it.idx>maxIdx) maxIdx=it.idx; });
      if(!isFinite(maxIdx)) maxIdx = arr.length-1;
      newRecords = arr.map(item=>{
        const idx = typeof item.idx==="number" ? item.idx : 0;
        const minutesAgo = maxIdx - idx;
        const ts = nowMs - minutesAgo*60*1000;
        return {
          ts,
          temp:  item.temp  ?? null,
          hum:   item.hum   ?? null,
          co2:   item.co2   ?? null,
          solar: item.solar ?? null,
          rssi:  item.rssi  ?? null,
          led:   !!item.led
        };
      });
    }else{
      const len = arr.length;
      newRecords = arr.map((item,i)=>{
        const minutesAgo = len-1-i;
        const ts = nowMs - minutesAgo*60*1000;
        return {
          ts,
          temp:  item.temp  ?? null,
          hum:   item.hum   ?? null,
          co2:   item.co2   ?? null,
          solar: item.solar ?? null,
          rssi:  item.rssi  ?? null,
          led:   !!item.led
        };
      });
    }

    // ESPê°€ ë³´ë‚´ì¤€ 60ê°œê°€ ê¸°ì¤€ (ë¸Œë¼ìš°ì € íˆìŠ¤í† ë¦¬ ì—†ìŒ)
    pushMergedRecords(newRecords);
    currentBucket = null;
    rebuildTableAndCharts();
    log("ESP history ë°˜ì˜(ë³‘í•©): "+historyData.length+"ê°œ");
  }

  // ==== alive ì²´í¬ (30ì´ˆ ê¸°ì¤€) ====
  setInterval(()=>{
    if(!lastDeviceMsgAt) return;
    if(Date.now()-lastDeviceMsgAt>30000) setDeviceState(false);
  },2000);

  // ==== LED & reset ====
  function publishLed(cmd){
    if(!client.connected){
      cmdResultEl.textContent="ì „ì†¡ ìƒíƒœ: MQTT ë¯¸ì—°ê²°";
      return;
    }
    client.publish("esp32c3/led",cmd,{qos:0,retain:false},(err)=>{
      if(err){
        cmdResultEl.textContent="ì „ì†¡ ìƒíƒœ: ì‹¤íŒ¨ - "+err.message;
        log("LED publish ì‹¤íŒ¨: "+err.message);
      }else{
        cmdResultEl.textContent="ì „ì†¡ ìƒíƒœ: "+cmd;
        log("LED ëª…ë ¹ ì „ì†¡: "+cmd);
      }
    });
  }
  btnOn.addEventListener("click",()=>publishLed("LED_ON"));
  btnOff.addEventListener("click",()=>publishLed("LED_OFF"));

  function publishSoftReset(){
    if(!client.connected){
      alert("MQTTê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      log("Soft reset ì „ì†¡ ì‹¤íŒ¨: MQTT ë¯¸ì—°ê²°");
      return;
    }
    if(!confirm("ì¥ë¹„ì— ì†Œí”„íŠ¸ ë¦¬ì…‹ ëª…ë ¹ì„ ì „ì†¡í• ê¹Œìš”?")) return;
    client.publish("esp32c3/reset","SOFT_RESET",{qos:0,retain:false},(err)=>{
      if(err){
        alert("Soft reset ì „ì†¡ ì‹¤íŒ¨: "+err.message);
        log("Soft reset ì „ì†¡ ì‹¤íŒ¨: "+err.message);
      }else{
        log("Soft reset ëª…ë ¹ ì „ì†¡ ì™„ë£Œ");
      }
    });
  }
  btnSoftReset.addEventListener("click",publishSoftReset);

  function rebuildTableAndCharts(){
    trimHistoryByTime();
    rebuildTable();
    if(tempChart) updateCharts();
  }

  // ==== ì‹œì‘ ì‹œ: ì•ŒëŒ ì„¤ì •ë§Œ ë¡œì»¬ ë³µì› ====
  loadAlarmFromLocal();
</script>
</body>
</html>
