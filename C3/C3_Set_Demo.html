<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ESP32+HiveMQ ëŒ€ì‹œ ë³´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <style>
    :root {
      --bg: #f5f5f5;
      --fg: #111827;
      --subtle: #6b7280;
      --muted: #9ca3af;
      --card-bg: #ffffff;
      --metric-bg: #fafafa;
      --shadow: 0 2px 6px rgba(0,0,0,0.08);
      --log-bg: #111827;
      --log-fg: #e5e7eb;
      --border-soft: rgba(0,0,0,0.06);
      --accent: #3b82f6;
      --alarm: #ef4444;
    }

    body[data-theme="dark"] {
      --bg: #020617;
      --fg: #e5e7eb;
      --subtle: #9ca3af;
      --muted: #6b7280;
      --card-bg: #020617;
      --metric-bg: #020617;
      --shadow: 0 2px 10px rgba(0,0,0,0.55);
      --log-bg: #020617;
      --log-fg: #e5e7eb;
      --border-soft: rgba(148,163,184,0.4);
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--fg);
      margin: 0;
      padding: 16px;
      transition: background 0.25s ease, color 0.25s ease;
    }

    h1 { margin-top: 0; font-size: 1.5rem; }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      border: 1px solid var(--border-soft);
      transition: background 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
      width: 100%;
    }

    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      background: #9ca3af;
    }
    .status-ok { background: #22c55e; }
    .status-bad { background: #ef4444; }

    .mqtt-lines {
      font-size: 0.9rem;
      line-height: 1.4;
    }
    .mqtt-line-main {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
    }
    .mqtt-spacer {
      flex: 1;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }

    .metric {
      background: var(--metric-bg);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      border: 1px solid var(--border-soft);
      transition: background 0.25s ease, border-color 0.25s ease, transform 0.1s ease;
    }
    .metric-label { font-size: 0.8rem; color: var(--subtle); }
    .metric-value { font-size: 1.3rem; font-weight: 600; margin-top: 4px; }

    .metric-alarmable {
      cursor: pointer;
    }
    .metric-alarmable:hover {
      border-color: rgba(59,130,246,0.6);
      transform: translateY(-1px);
    }
    .metric-alarmable .metric-label::after {
      content: " â€¢ ì•ŒëŒ";
      font-size: 0.7rem;
      color: var(--muted);
    }
    .metric-alarm-value.alarm-active {
      color: var(--alarm);
      font-weight: 700;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-right: 8px;
      margin-top: 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.2s ease, color 0.2s ease;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    #btnOn { background: #2ecc71; color: #fff; box-shadow: 0 2px 6px rgba(34,197,94,0.4); }
    #btnOff { background: #e74c3c; color: #fff; box-shadow: 0 2px 6px rgba(239,68,68,0.4); }

    .theme-toggle {
      background: transparent;
      color: var(--subtle);
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 10px;
      font-size: 0.8rem;
      line-height: 1;
      margin: 0;
      margin-top: -4px;
      box-shadow: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .theme-toggle-icon { font-size: 1.1rem; }

    .icon-button {
      padding: 6px 10px;
      border-radius: 999px;
      background: transparent;
      border: 1px solid var(--border-soft);
      color: var(--subtle);
      margin-top: 0;
      box-shadow: none;
      font-size: 0.85rem;
    }
    .icon-button.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .icon-button-small {
      padding: 2px 8px;
      font-size: 0.7rem;
      margin-right: 0;
    }

    #log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      max-height: 260px;
      overflow-y: auto;
      background: var(--log-bg);
      color: var(--log-fg);
      padding: 8px;
      border-radius: 8px;
      white-space: pre-wrap;
      border: 1px solid var(--border-soft);
      transition: background 0.25s ease, color 0.25s ease, border-color 0.25s ease;
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .toolbar-left,
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .hidden {
      display: none !important;
    }

    .log-card {
      border: none;
      box-shadow: none;
      background: transparent;
      padding-top: 0;
    }

    .led-card {
      padding: 10px 16px 8px;
    }
    .led-card h2 {
      margin-top: 0;
      margin-bottom: 4px;
      font-size: 1.05rem;
    }
    .led-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }
    .led-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
    }
    .cmd-status {
      font-size: 0.75rem;
      color: var(--subtle);
      min-height: 1.2em;
      margin-top: 8px;
    }

    .chart-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chart-block {
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      padding: 8px 10px 10px;
      background: var(--metric-bg);
      width: 100%;
      margin: 0;
    }
    .chart-block h3 {
      margin: 0 0 4px;
      font-size: 0.9rem;
      color: var(--subtle);
      text-align: left;
    }
    .chart-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      overflow: hidden;
    }
    .chart-wrapper canvas {
      position: absolute;
      inset: 0;
      width: 100% !important;
      height: 100% !important;
    }

    .table-scroll {
      max-height: 260px;
      overflow-y: auto;
      overflow-x: auto;
    }
    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      table-layout: fixed;
    }
    .history-table thead {
      position: sticky;
      top: 0;
      background: var(--card-bg);
      z-index: 1;
    }
    .history-table th,
    .history-table td {
      padding: 3px 4px;
      border-bottom: 1px solid var(--border-soft);
      text-align: right;
      white-space: nowrap;
    }
    .history-table th {
      font-size: 0.72rem;
      line-height: 1.25;
    }
    .history-table th .th-label {
      display: block;
    }
    .history-table th .th-unit {
      display: block;
      font-size: 0.65rem;
      color: var(--muted);
    }
    .history-table th:first-child,
    .history-table td:first-child {
      text-align: left;
    }
    .history-table td {
      font-size: 0.72rem;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: var(--card-bg);
      color: var(--fg);
      border-radius: 12px;
      padding: 16px 18px 14px;
      width: min(360px, 90vw);
      box-shadow: var(--shadow);
      border: 1px solid var(--border-soft);
    }
    .modal-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 8px;
    }
    .modal-desc {
      font-size: 0.85rem;
      color: var(--subtle);
      margin-bottom: 12px;
    }
    .field-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .field {
      flex: 1;
    }
    .field label {
      display: block;
      font-size: 0.75rem;
      color: var(--subtle);
      margin-bottom: 2px;
    }
    .field input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: var(--bg);
      color: var(--fg);
      font-size: 0.85rem;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 8px;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 2px 6px rgba(37,99,235,0.4);
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border-soft);
      color: var(--subtle);
      box-shadow: none;
    }
  </style>
</head>
<body data-theme="light">
  <header class="page-header">
    <h1>ESP32+HiveMQ ëŒ€ì‹œ ë³´ë“œ</h1>
    <button id="themeToggle" class="theme-toggle" type="button" aria-label="í…Œë§ˆ ì „í™˜">
      <span class="theme-toggle-icon">ğŸŒ</span>
    </button>
  </header>

  <!-- ë¸Œë¡œì»¤/ì¥ë¹„ ìƒíƒœ -->
  <div class="card">
    <div class="mqtt-lines">
      <div class="mqtt-line-main">
        <span id="mqttDot" class="status-dot"></span>
        <strong id="mqttState">MQTT ì—°ê²° ëŒ€ê¸° ì¤‘... (broker.hivemq.com)</strong>
        <span class="mqtt-spacer"></span>
        <button
          id="btnSoftReset"
          class="icon-button icon-button-small"
          type="button"
          title="ì¥ë¹„ ì†Œí”„íŠ¸ ë¦¬ì…‹"
        >
          RESET
        </button>
      </div>
      <div style="font-size:0.85rem;color:var(--subtle);">
        ì¥ë¹„ ìƒíƒœ: <span id="deviceState">ì•Œ ìˆ˜ ì—†ìŒ</span>
        &nbsp;&nbsp; RSSI: <span id="headerRssi">--</span> [dBm]
      </div>
      <div style="font-size:0.85rem;color:var(--subtle);">
        ìˆ˜ì‹  ì‹œê°: <span id="lastUpdate">-</span>
      </div>
    </div>
  </div>

  <!-- ì„¼ì„œ ìƒíƒœ -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">ì„¼ì„œ ìƒíƒœ (esp32c3/status)</h2>
    <div class="grid">
      <div class="metric metric-alarmable" data-key="temp" data-label="ì˜¨ë„" data-unit="Â°C">
        <div class="metric-label">ì˜¨ë„</div>
        <div class="metric-value"><span id="valTemp" class="metric-alarm-value">--</span> Â°C</div>
      </div>
      <div class="metric metric-alarmable" data-key="hum" data-label="ìŠµë„" data-unit="%">
        <div class="metric-label">ìŠµë„</div>
        <div class="metric-value"><span id="valHum" class="metric-alarm-value">--</span> %</div>
      </div>
      <div class="metric metric-alarmable" data-key="co2" data-label="COâ‚‚" data-unit="ppm">
        <div class="metric-label">COâ‚‚</div>
        <div class="metric-value"><span id="valCo2" class="metric-alarm-value">--</span> ppm</div>
      </div>
      <div class="metric metric-alarmable" data-key="solar" data-label="ì¼ì‚¬ëŸ‰" data-unit="W/mÂ²">
        <div class="metric-label">ì¼ì‚¬ëŸ‰</div>
        <div class="metric-value"><span id="valSolar" class="metric-alarm-value">--</span> W/mÂ²</div>
      </div>
      <div class="metric">
        <div class="metric-label">LED ìƒíƒœ</div>
        <div class="metric-value"><span id="valLed">--</span></div>
      </div>
      <div class="metric">
        <div class="metric-label">WiFi RSSI</div>
        <div class="metric-value"><span id="valRssi">--</span> dBm</div>
      </div>
    </div>
  </div>

  <!-- LED ì œì–´ -->
  <div class="card led-card">
    <h2>LED ì œì–´ (esp32c3/led)</h2>
    <div class="led-row">
      <div class="led-buttons">
        <button id="btnOn">LED ON</button>
        <button id="btnOff">LED OFF</button>
      </div>
      <div id="cmdResult" class="cmd-status">ì „ì†¡ ìƒíƒœ: -</div>
    </div>
  </div>

  <!-- ë²„íŠ¼ ë°” -->
  <div class="toolbar">
    <div class="toolbar-left">
      <button id="btnShowTable" class="icon-button" type="button">ğŸ“‹ í…Œì´ë¸”</button>
      <button id="btnShowChart" class="icon-button" type="button">ğŸ“Š ê·¸ë˜í”„</button>
    </div>
    <div class="toolbar-right">
      <button id="btnToggleLog" class="icon-button" type="button">ğŸ ë¡œê·¸</button>
    </div>
  </div>

  <!-- 1ë¶„ í‰ê·  í…Œì´ë¸” -->
  <div class="card hidden" id="tableCard">
    <div class="card-header">
      <h2 style="font-size:1.1rem;margin:0;">1ë¶„ í‰ê·  í…Œì´ë¸”</h2>
      <div style="font-size:0.8rem;color:var(--subtle);">ìµœê·¼ 60ë¶„</div>
    </div>
    <div class="table-scroll">
      <table class="history-table">
        <thead>
          <tr>
            <th>
              <span class="th-label">ì‹œê°„</span>
              <span class="th-unit">&nbsp;</span>
            </th>
            <th>
              <span class="th-label">ì˜¨ë„</span>
              <span class="th-unit">(Â°C)</span>
            </th>
            <th>
              <span class="th-label">ìŠµë„</span>
              <span class="th-unit">(%)</span>
            </th>
            <th>
              <span class="th-label">COâ‚‚</span>
              <span class="th-unit">(ppm)</span>
            </th>
            <th>
              <span class="th-label">ì¼ì‚¬ëŸ‰</span>
              <span class="th-unit">(W/mÂ²)</span>
            </th>
            <th>
              <span class="th-label">LED</span>
              <span class="th-unit">(ìƒíƒœ)</span>
            </th>
            <th>
              <span class="th-label">RSSI</span>
              <span class="th-unit">(dBm)</span>
            </th>
          </tr>
        </thead>
        <tbody id="historyTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ê·¸ë˜í”„ ì¹´ë“œ -->
  <div class="card hidden" id="chartCard">
    <div class="card-header">
      <div>
        <h2 style="font-size:1.1rem;margin:0;">ì˜¨ë„/ìŠµë„/COâ‚‚/ì¼ì‚¬ëŸ‰ ê·¸ë˜í”„</h2>
        <div style="font-size:0.8rem;color:var(--subtle);">1ë¶„ í‰ê· , ìµœê·¼ 60ë¶„</div>
      </div>
    </div>
    <div class="chart-grid">
      <div class="chart-block">
        <h3>ì˜¨ë„ (Â°C)</h3>
        <div class="chart-wrapper">
          <canvas id="tempChart"></canvas>
        </div>
      </div>
      <div class="chart-block">
        <h3>ìŠµë„ (%)</h3>
        <div class="chart-wrapper">
          <canvas id="humChart"></canvas>
        </div>
      </div>
      <div class="chart-block">
        <h3>COâ‚‚ (ppm)</h3>
        <div class="chart-wrapper">
          <canvas id="co2Chart"></canvas>
        </div>
      </div>
      <div class="chart-block">
        <h3>ì¼ì‚¬ëŸ‰ (W/mÂ²)</h3>
        <div class="chart-wrapper">
          <canvas id="solarChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ë¡œê·¸ ì¹´ë“œ -->
  <div class="card log-card hidden" id="logCard">
    <div id="log"></div>
  </div>

  <!-- ì•ŒëŒ ì„¤ì • ëª¨ë‹¬ -->
  <div id="alarmModalBackdrop" class="modal-backdrop hidden">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 class="modal-title"><span id="alarmMetricLabel">ì˜¨ë„</span> ì•ŒëŒ ì„¤ì •</h3>
      <p class="modal-desc">
        ìƒí•œ/í•˜í•œ ê°’ì„ ì„¤ì •í•˜ë©´ ë²”ìœ„ë¥¼ ë²—ì–´ë‚  ë•Œ ì„¼ì„œ ê°’ì´
        <span style="color:var(--alarm);font-weight:600;">ë¹¨ê°„ìƒ‰</span>ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
        ë¹ˆ ì¹¸ìœ¼ë¡œ ë‘ë©´ í•´ë‹¹ ê°’ì€ ë¬´ì‹œë©ë‹ˆë‹¤.
      </p>
      <div class="field-row">
        <div class="field">
          <label for="alarmLow">í•˜í•œê°’</label>
          <input id="alarmLow" type="number" step="0.1" placeholder="ì˜ˆ: 18.0" />
        </div>
        <div class="field">
          <label for="alarmHigh">ìƒí•œê°’</label>
          <input id="alarmHigh" type="number" step="0.1" placeholder="ì˜ˆ: 28.0" />
        </div>
      </div>
      <div style="font-size:0.8rem;color:var(--muted);margin-top:2px;">
        ë‹¨ìœ„: <span id="alarmUnitLabel">Â°C</span>
      </div>
      <div class="modal-actions">
        <button id="alarmCancel" class="btn-ghost" type="button">ì·¨ì†Œ</button>
        <button id="alarmSave" class="btn-primary" type="button">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    const mqttStateEl   = $("#mqttState");
    const mqttDotEl     = $("#mqttDot");
    const deviceStateEl = $("#deviceState");
    const lastUpdateEl  = $("#lastUpdate");
    const headerRssiEl  = $("#headerRssi");
    const logEl         = $("#log");
    const cmdResultEl   = $("#cmdResult");

    const valTemp  = $("#valTemp");
    const valHum   = $("#valHum");
    const valCo2   = $("#valCo2");
    const valSolar = $("#valSolar");
    const valLed   = $("#valLed");
    const valRssi  = $("#valRssi");

    const btnOn        = $("#btnOn");
    const btnOff       = $("#btnOff");
    const btnSoftReset = $("#btnSoftReset");

    const themeToggleBtn  = $("#themeToggle");
    const themeToggleIcon = themeToggleBtn.querySelector(".theme-toggle-icon");

    const btnShowTable = $("#btnShowTable");
    const btnShowChart = $("#btnShowChart");
    const btnToggleLog = $("#btnToggleLog");

    const tableCard = $("#tableCard");
    const chartCard = $("#chartCard");
    const logCard   = $("#logCard");

    const alarmModalBackdrop = $("#alarmModalBackdrop");
    const alarmMetricLabelEl = $("#alarmMetricLabel");
    const alarmUnitLabelEl   = $("#alarmUnitLabel");
    const alarmLowInput      = $("#alarmLow");
    const alarmHighInput     = $("#alarmHigh");
    const alarmCancelBtn     = $("#alarmCancel");
    const alarmSaveBtn       = $("#alarmSave");

    const alarmConfig = {
      temp:  { low: null, high: null },
      hum:   { low: null, high: null },
      co2:   { low: null, high: null },
      solar: { low: null, high: null },
    };
    let currentAlarmKey = null;

    function formatTimeHHMM(date) {
      const h = date.getHours().toString().padStart(2, "0");
      const m = date.getMinutes().toString().padStart(2, "0");
      return `${h}:${m}`;
    }

    function applyTheme(theme) {
      const isDark = theme === "dark";
      document.body.setAttribute("data-theme", theme);
      themeToggleIcon.textContent = isDark ? "ğŸŒ™" : "ğŸŒ";
    }

    (function initTheme() {
      const saved = localStorage.getItem("hivemq-dashboard-theme");
      let theme = "light";
      if (saved === "light" || saved === "dark") {
        theme = saved;
      } else if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
        theme = "dark";
      }
      applyTheme(theme);
    })();

    themeToggleBtn.addEventListener("click", () => {
      const current = document.body.getAttribute("data-theme") || "light";
      const next = current === "dark" ? "light" : "dark";
      localStorage.setItem("hivemq-dashboard-theme", next);
      applyTheme(next);
    });

    function log(msg) {
      const time = new Date().toLocaleTimeString("ko-KR", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false
      });
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    }

    function setMqttStatus(ok, text) {
      mqttDotEl.classList.remove("status-ok", "status-bad");
      mqttDotEl.classList.add(ok ? "status-ok" : "status-bad");
      mqttStateEl.textContent = text;
    }

    function setDeviceState(alive) {
      if (alive) {
        deviceStateEl.textContent = "ì˜¨ë¼ì¸";
        deviceStateEl.style.color = "#16a34a";
      } else {
        deviceStateEl.textContent = "ì˜¤í”„ë¼ì¸";
        deviceStateEl.style.color = "#dc2626";
      }
    }

    // ğŸ” ìˆ˜ì‹  ì‹œê°ë§Œ 12ì‹œê°„ì œ(ì˜¤ì „/ì˜¤í›„)ë¡œ í‘œê¸°
    function formatKoreanDateTime(d) {
      return d.toLocaleString("ko-KR", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: true      // â† ì—¬ê¸°ë§Œ  true ë¡œ ë³€ê²½
      });
    }

    const brokerUrl = "wss://broker.hivemq.com:8884/mqtt";
    const options = { clean: true, connectTimeout: 4000, reconnectPeriod: 5000 };
    const client = mqtt.connect(brokerUrl, options);
    let lastDeviceMsgAt = null;

    client.on("connect", () => {
      setMqttStatus(true, "MQTT ì—°ê²° OK (broker.hivemq.com)");
      log("MQTT ì—°ê²° ì„±ê³µ (broker.hivemq.com)");
      const topicStatus = "esp32c3/status";
      client.subscribe(topicStatus, (err) => {
        if (err) log("êµ¬ë… ì‹¤íŒ¨: " + err.message);
        else     log("êµ¬ë… ì„±ê³µ: " + topicStatus);
      });
    });

    client.on("reconnect", () => {
      setMqttStatus(false, "MQTT ì¬ì—°ê²° ì‹œë„ ì¤‘... (broker.hivemq.com)");
      log("ì¬ì—°ê²° ì‹œë„...");
    });

    client.on("error", (err) => {
      setMqttStatus(false, "MQTT ì—ëŸ¬ (broker.hivemq.com)");
      log("ì—ëŸ¬: " + err.message);
    });

    client.on("close", () => {
      setMqttStatus(false, "MQTT ì—°ê²° ëŠê¹€ (broker.hivemq.com)");
      log("MQTT ì—°ê²° ëŠê¹€");
    });

    const BUCKET_MS  = 1 * 60 * 1000;
    const HISTORY_MS = 60 * 60 * 1000;
    const STORAGE_KEY = "esp32c3_history_v1";
    const historyBuckets = [];

    function saveHistoryToStorage() {
      try {
        const payload = {
          version: 1,
          buckets: historyBuckets.map(b => ({
            start: b.start,
            tempSum: b.tempSum, tempCount: b.tempCount,
            humSum: b.humSum, humCount: b.humCount,
            co2Sum: b.co2Sum, co2Count: b.co2Count,
            solarSum: b.solarSum, solarCount: b.solarCount,
            rssiSum: b.rssiSum, rssiCount: b.rssiCount,
            ledLast: b.ledLast
          }))
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch (e) {
        console.warn("history ì €ì¥ ì‹¤íŒ¨", e);
      }
    }

    function loadHistoryFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const payload = JSON.parse(raw);
        if (!payload || payload.version !== 1 || !Array.isArray(payload.buckets)) return;

        const now = Date.now();
        const cutoff = now - HISTORY_MS;
        historyBuckets.length = 0;

        for (const src of payload.buckets) {
          const startNum = Number(src.start);
          if (!isFinite(startNum) || startNum < cutoff) continue;
          const key = Math.floor(startNum / BUCKET_MS);
          historyBuckets.push({
            key,
            start: startNum,
            tempSum:  src.tempSum  || 0,
            tempCount:src.tempCount|| 0,
            humSum:   src.humSum   || 0,
            humCount: src.humCount || 0,
            co2Sum:   src.co2Sum   || 0,
            co2Count: src.co2Count || 0,
            solarSum: src.solarSum || 0,
            solarCount:src.solarCount||0,
            rssiSum:  src.rssiSum  || 0,
            rssiCount:src.rssiCount|| 0,
            ledLast:  src.ledLast  || null
          });
        }
      } catch (e) {
        console.warn("history ë¡œë“œ ì‹¤íŒ¨", e);
      }
    }

    function addHistoryPoint(ts, temp, hum, co2, solar, ledState, rssi) {
      if (isNaN(temp) && isNaN(hum) && isNaN(co2) && isNaN(solar) && isNaN(rssi) && !ledState) {
        return;
      }

      const key = Math.floor(ts / BUCKET_MS);
      let bucket = historyBuckets[historyBuckets.length - 1];

      if (!bucket || bucket.key !== key) {
        bucket = {
          key,
          start: key * BUCKET_MS,
          tempSum: 0, tempCount: 0,
          humSum:  0, humCount:  0,
          co2Sum:  0, co2Count:  0,
          solarSum: 0, solarCount: 0,
          rssiSum: 0, rssiCount: 0,
          ledLast: null
        };
        historyBuckets.push(bucket);
      }

      if (!isNaN(temp)) {
        bucket.tempSum += temp;
        bucket.tempCount += 1;
      }
      if (!isNaN(hum)) {
        bucket.humSum += hum;
        bucket.humCount += 1;
      }
      if (!isNaN(co2)) {
        bucket.co2Sum += co2;
        bucket.co2Count += 1;
      }
      if (!isNaN(solar)) {
        bucket.solarSum += solar;
        bucket.solarCount += 1;
      }
      if (!isNaN(rssi)) {
        bucket.rssiSum += rssi;
        bucket.rssiCount += 1;
      }
      if (ledState) {
        bucket.ledLast = ledState;
      }

      const cutoff = ts - HISTORY_MS;
      while (historyBuckets.length && historyBuckets[0].start < cutoff) {
        historyBuckets.shift();
      }

      saveHistoryToStorage();
    }

    loadHistoryFromStorage();

    let tempChart = null;
    let humChart  = null;
    let co2Chart  = null;
    let solarChart = null;

    function createChart(ctx, label, borderColor, bgColor, yTitle) {
      return new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label,
              data: [],
              borderColor,
              backgroundColor: bgColor,
              tension: 0.2,
              spanGaps: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.parsed.y;
                  if (v == null) return `${label}: -`;
                  return `${label}: ${v.toFixed(1)}`;
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: "ì‹œê°„",
                color: "#6b7280",
                font: { size: 11 }
              },
              ticks: {
                color: "#6b7280",
                maxRotation: 45,
                minRotation: 45,
                autoSkip: true,
                maxTicksLimit: 8
              },
              grid: {
                color: "rgba(148,163,184,0.25)"
              }
            },
            y: {
              title: {
                display: true,
                text: yTitle,
                color: "#6b7280",
                font: { size: 11 }
              },
              position: "left",
              ticks: {
                color: "#6b7280"
              },
              grid: {
                color: "rgba(148,163,184,0.25)"
              }
            }
          }
        }
      });
    }

    function ensureChartsInitialized() {
      if (tempChart && humChart && co2Chart && solarChart) {
        updateCharts();
        return;
      }
      const ctxTemp  = document.getElementById("tempChart").getContext("2d");
      const ctxHum   = document.getElementById("humChart").getContext("2d");
      const ctxCo2   = document.getElementById("co2Chart").getContext("2d");
      const ctxSolar = document.getElementById("solarChart").getContext("2d");

      tempChart  = createChart(ctxTemp,  "ì˜¨ë„",   "#f97316", "rgba(249,115,22,0.15)",  "ì˜¨ë„ (Â°C)");
      humChart   = createChart(ctxHum,   "ìŠµë„",   "#22c55e", "rgba(34,197,94,0.15)",   "ìŠµë„ (%)");
      co2Chart   = createChart(ctxCo2,   "COâ‚‚",    "#3b82f6", "rgba(59,130,246,0.15)", "COâ‚‚ (ppm)");
      solarChart = createChart(ctxSolar, "ì¼ì‚¬ëŸ‰", "#eab308", "rgba(234,179,8,0.15)",  "ì¼ì‚¬ëŸ‰ (W/mÂ²)");

      updateCharts();
    }

    function updateCharts() {
      if (!tempChart || !humChart || !co2Chart || !solarChart) return;

      const labels = historyBuckets.map(b =>
        formatTimeHHMM(new Date(b.start))
      );

      const tempData  = historyBuckets.map(b => b.tempCount  ? b.tempSum  / b.tempCount  : null);
      const humData   = historyBuckets.map(b => b.humCount   ? b.humSum   / b.humCount   : null);
      const co2Data   = historyBuckets.map(b => b.co2Count   ? b.co2Sum   / b.co2Count   : null);
      const solarData = historyBuckets.map(b => b.solarCount ? b.solarSum / b.solarCount : null);

      [tempChart, humChart, co2Chart, solarChart].forEach((chart) => {
        chart.data.labels = labels;
      });

      tempChart.data.datasets[0].data  = tempData;
      humChart.data.datasets[0].data   = humData;
      co2Chart.data.datasets[0].data   = co2Data;
      solarChart.data.datasets[0].data = solarData;

      tempChart.update();
      humChart.update();
      co2Chart.update();
      solarChart.update();
    }

    function updateTable() {
      const tbody = document.getElementById("historyTableBody");
      if (!tbody) return;
      tbody.innerHTML = "";

      for (let i = historyBuckets.length - 1; i >= 0; i--) {
        const b = historyBuckets[i];
        const timeLabel = formatTimeHHMM(new Date(b.start));

        const temp  = b.tempCount  ? (b.tempSum  / b.tempCount ).toFixed(1) : "-";
        const hum   = b.humCount   ? (b.humSum   / b.humCount  ).toFixed(1) : "-";
        const co2   = b.co2Count   ? (b.co2Sum   / b.co2Count  ).toFixed(0) : "-";
        const solar = b.solarCount ? (b.solarSum / b.solarCount).toFixed(0) : "-";
        const rssi  = b.rssiCount  ? (b.rssiSum  / b.rssiCount ).toFixed(0) : "-";
        const led   = b.ledLast || "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${timeLabel}</td>
          <td>${temp}</td>
          <td>${hum}</td>
          <td>${co2}</td>
          <td>${solar}</td>
          <td>${led}</td>
          <td>${rssi}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    updateTable();

    let viewMode = null;
    function setViewMode(mode) {
      viewMode = mode;
      if (mode === "table") {
        tableCard.classList.remove("hidden");
        chartCard.classList.add("hidden");
        btnShowTable.classList.add("active");
        btnShowChart.classList.remove("active");
        updateTable();
        tableCard.scrollIntoView({ behavior: "smooth", block: "start" });
      } else if (mode === "chart") {
        chartCard.classList.remove("hidden");
        tableCard.classList.add("hidden");
        btnShowChart.classList.add("active");
        btnShowTable.classList.remove("active");
        ensureChartsInitialized();
        chartCard.scrollIntoView({ behavior: "smooth", block: "start" });
      } else {
        tableCard.classList.add("hidden");
        chartCard.classList.add("hidden");
        btnShowTable.classList.remove("active");
        btnShowChart.classList.remove("active");
      }
    }

    btnShowTable.addEventListener("click", () => {
      setViewMode(viewMode === "table" ? null : "table");
    });
    btnShowChart.addEventListener("click", () => {
      setViewMode(viewMode === "chart" ? null : "chart");
    });

    let logVisible = false;
    btnToggleLog.addEventListener("click", () => {
      logVisible = !logVisible;
      logCard.classList.toggle("hidden", !logVisible);
      btnToggleLog.classList.toggle("active", logVisible);
      if (logVisible) {
        logCard.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    });

    client.on("message", (topic, payload) => {
      const text = new TextDecoder().decode(payload);
      log(`ìˆ˜ì‹  (${topic}): ${text}`);

      const trimmed = text.trim();
      if (!trimmed.startsWith("{")) return;

      // "rssi":} â†’ "rssi":null}
      let fixed = trimmed.replace(/"rssi"\s*:\s*}/, '"rssi":null}');

      let data;
      try {
        data = JSON.parse(fixed);
      } catch (e) {
        log("JSON íŒŒì‹± ì‹¤íŒ¨: " + e.message);
        return;
      }

      lastDeviceMsgAt = Date.now();
      setDeviceState(data.alive !== false);
      const now = new Date();

      if ("temp"  in data) {
        const t = Number(data.temp);
        valTemp.textContent = isNaN(t) ? "--" : t.toFixed(1);
      }
      if ("hum"   in data) {
        const h = Number(data.hum);
        valHum.textContent = isNaN(h) ? "--" : h.toFixed(1);
      }
      if ("co2"   in data) {
        const c = Number(data.co2);
        valCo2.textContent = isNaN(c) ? "--" : c.toFixed(0);
      }
      if ("solar" in data) {
        const s = Number(data.solar);
        valSolar.textContent = isNaN(s) ? "--" : s.toFixed(0);
      }
      if ("led"   in data) {
        valLed.textContent = data.led ? "ON" : "OFF";
      }
      if ("rssi"  in data) {
        const r = Number(data.rssi);
        valRssi.textContent = isNaN(r) ? "--" : r.toFixed(0);
        headerRssiEl.textContent = valRssi.textContent;
      }

      // ì—¬ê¸°ì„œ ìˆ˜ì‹  ì‹œê° ì—…ë°ì´íŠ¸ â†’ 12ì‹œê°„ì œ
      lastUpdateEl.textContent = formatKoreanDateTime(now);

      const tVal   = parseFloat(valTemp.textContent);
      const hVal   = parseFloat(valHum.textContent);
      const cVal   = parseFloat(valCo2.textContent);
      const sVal   = parseFloat(valSolar.textContent);
      const ledStr = valLed.textContent.trim() || null;
      const rVal   = parseFloat(valRssi.textContent);

      addHistoryPoint(now.getTime(), tVal, hVal, cVal, sVal, ledStr, rVal);

      updateCharts();
      updateTable();
      applyAlarms();
    });

    setInterval(() => {
      if (!lastDeviceMsgAt) return;
      if (Date.now() - lastDeviceMsgAt > 10000) {
        setDeviceState(false);
      }
    }, 2000);

    function publishLed(cmd) {
      if (!client.connected) {
        cmdResultEl.textContent = "ì „ì†¡ ìƒíƒœ: MQTTê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        return;
      }
      const topic = "esp32c3/led";
      client.publish(topic, cmd, { qos: 0, retain: false }, (err) => {
        if (err) {
          cmdResultEl.textContent = "ì „ì†¡ ìƒíƒœ: ì „ì†¡ ì‹¤íŒ¨ - " + err.message;
          log("LED publish ì‹¤íŒ¨: " + err.message);
        } else {
          cmdResultEl.textContent = `ì „ì†¡ ìƒíƒœ: ${cmd}`;
          log(`LED ëª…ë ¹ ì „ì†¡ (${topic}): ${cmd}`);
        }
      });
    }

    btnOn.addEventListener("click", () => publishLed("LED_ON"));
    btnOff.addEventListener("click", () => publishLed("LED_OFF"));

    function publishSoftReset() {
      if (!client.connected) {
        alert("MQTTê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        log("Soft reset ì „ì†¡ ì‹¤íŒ¨: MQTT ë¯¸ì—°ê²°");
        return;
      }
      if (!confirm("ì¥ë¹„ì— ì†Œí”„íŠ¸ ë¦¬ì…‹ ëª…ë ¹ì„ ì „ì†¡í• ê¹Œìš”?")) return;

      const topic   = "esp32c3/reset";
      const payload = "SOFT_RESET";

      client.publish(topic, payload, { qos: 0, retain: false }, (err) => {
        if (err) {
          alert("Soft reset ì „ì†¡ ì‹¤íŒ¨: " + err.message);
          log("Soft reset ì „ì†¡ ì‹¤íŒ¨: " + err.message);
        } else {
          log(`Soft reset ëª…ë ¹ ì „ì†¡ (${topic}): ${payload}`);
        }
      });
    }

    btnSoftReset.addEventListener("click", publishSoftReset);

    function openAlarmModal(key, label, unit) {
      currentAlarmKey = key;
      alarmMetricLabelEl.textContent = label;
      alarmUnitLabelEl.textContent   = unit;

      const cfg = alarmConfig[key] || { low: null, high: null };
      alarmLowInput.value  = cfg.low  ?? "";
      alarmHighInput.value = cfg.high ?? "";

      alarmModalBackdrop.classList.remove("hidden");
    }
    function closeAlarmModal() {
      alarmModalBackdrop.classList.add("hidden");
    }

    alarmCancelBtn.addEventListener("click", closeAlarmModal);
    alarmModalBackdrop.addEventListener("click", (e) => {
      if (e.target === alarmModalBackdrop) closeAlarmModal();
    });

    alarmSaveBtn.addEventListener("click", () => {
      if (!currentAlarmKey) return;
      let low  = alarmLowInput.value.trim();
      let high = alarmHighInput.value.trim();

      const key = currentAlarmKey;
      const cfg = alarmConfig[key];

      cfg.low  = low === ""  ? null : Number(low);
      cfg.high = high === "" ? null : Number(high);

      applyAlarms();
      closeAlarmModal();
    });

    document.querySelectorAll(".metric-alarmable").forEach((el) => {
      el.addEventListener("click", () => {
        const key   = el.getAttribute("data-key");
        const label = el.getAttribute("data-label") || key;
        const unit  = el.getAttribute("data-unit") || "";
        openAlarmModal(key, label, unit);
      });
    });

    const alarmState = { temp: false, hum: false, co2: false, solar: false };

    function checkMetricAlarm(key, value, valueEl) {
      const cfg = alarmConfig[key];
      if (!cfg || isNaN(value)) {
        valueEl.classList.remove("alarm-active");
        alarmState[key] = false;
        return;
      }
      let alarm = false;
      if (cfg.low  != null && value < cfg.low)  alarm = true;
      if (cfg.high != null && value > cfg.high) alarm = true;
      alarmState[key] = alarm;
      if (alarm) valueEl.classList.add("alarm-active");
      else       valueEl.classList.remove("alarm-active");
    }

    function applyAlarms() {
      const tVal = parseFloat(valTemp.textContent);
      const hVal = parseFloat(valHum.textContent);
      const cVal = parseFloat(valCo2.textContent);
      const sVal = parseFloat(valSolar.textContent);

      checkMetricAlarm("temp",  tVal, valTemp);
      checkMetricAlarm("hum",   hVal, valHum);
      checkMetricAlarm("co2",   cVal, valCo2);
      checkMetricAlarm("solar", sVal, valSolar);
    }
  </script>
</body>
</html>
