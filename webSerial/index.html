<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebSerial Console (CMD Presets)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-gray-100 p-3 sm:p-5">
  <!-- 모바일: 세로 / lg 이상: 가로 -->
  <div id="mainLayout" class="flex flex-col lg:flex-row gap-4 lg:gap-6 w-full">

    <!-- LEFT PANEL -->
    <div id="consolePanel" class="w-full lg:w-[60%] bg-gray-800 p-4 sm:p-5 rounded-xl shadow-lg border border-gray-700">
      <!-- 타이틀 + 프리셋 버튼 -->
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl sm:text-3xl font-bold">WebSerial Console</h2>
        <button id="togglePresetBtn" class="bg-gray-700 hover:bg-gray-600 px-3 sm:px-4 py-1 rounded border border-gray-600">
          프리셋
        </button>
      </div>

      <!-- 상단 설정 영역: 모바일에서 줄바꿈 -->
      <div class="flex flex-col sm:flex-row sm:justify-between mb-4 gap-3 sm:items-end">
        <div class="flex flex-wrap gap-3 sm:gap-4 items-end">
          <div>
            <label class="text-sm">Baud</label>
            <select id="baud" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 w-28">
              <option>4800</option>
              <option>9600</option>
              <option selected>115200</option>
            </select>
          </div>

          <div>
            <label class="text-sm">끝문자</label>
            <select id="ending" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 w-36">
              <option value="\n">LF (\n)</option>
              <option value="\r">CR (\r)</option>
              <option value="\r\n" selected>CRLF (\r\n)</option>
            </select>
          </div>
        </div>

        <div class="flex gap-2">
          <button id="connectBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-1 rounded border border-emerald-500 text-emerald-200">
            포트 연결
          </button>
          <button id="disconnectBtn" class="bg-gray-600 px-4 py-1 rounded border border-gray-500 text-gray-400 cursor-default" disabled>
            해제됨
          </button>
        </div>
      </div>

      <!-- 출력창: 모바일은 화면 높이 기준 -->
      <div id="serialOutput"
           class="bg-[#0D0D0D] p-3 rounded-lg h-[55vh] sm:h-[60vh] lg:h-[36rem] overflow-y-auto whitespace-pre-wrap mb-4 font-[FiraCode] font-thin text-white text-[14px] sm:text-[15px]">
      </div>

      <!-- 입력/전송 -->
      <div class="flex gap-2 sm:gap-3 mb-3">
        <input id="msgInput" type="text" placeholder="메시지 입력..."
               class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 sm:py-1" />
        <button id="sendBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 sm:py-1 rounded border border-emerald-500 text-emerald-200">
          전송
        </button>
      </div>

      <div class="flex items-center gap-4">
        <button id="clearBtn" class="bg-gray-700 px-3 py-2 sm:py-1 rounded border border-gray-600 hover:bg-gray-600">
          지우기
        </button>
        <label class="flex items-center gap-2">
          <input type="checkbox" id="autoScroll" checked />
          자동 스크롤
        </label>
      </div>
    </div>

    <!-- RIGHT PANEL (lg 이상에서만 보임) -->
    <div id="presetPanel" class="hidden lg:block w-full lg:w-[40%] bg-gray-800 p-4 sm:p-5 rounded-xl shadow-lg border border-gray-700 text-sm">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg sm:text-xl font-bold">프리셋</h2>
        <button id="closePresetBtn" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded border border-gray-600">
          닫기
        </button>
      </div>

      <div class="flex flex-wrap gap-2 mb-4">
        <button id="importPreset" class="bg-gray-700 px-3 py-2 sm:py-1 rounded border border-gray-600 hover:bg-gray-600">
          가져오기
        </button>
        <button id="exportPreset" class="bg-gray-700 px-3 py-2 sm:py-1 rounded border border-gray-600 hover:bg-gray-600">
          내보내기
        </button>
        <button id="deletePreset" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 sm:py-1 rounded border border-rose-500 text-rose-200">
          전체 삭제
        </button>
      </div>

      <div class="flex gap-2 mb-4">
        <input id="cmdInput" type="text" placeholder="Command"
               class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 sm:py-1" />
        <button id="addCmd" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 sm:py-1 rounded border border-emerald-500 text-emerald-200">
          추가
        </button>
      </div>

      <div id="groupsContainer" class="flex flex-col gap-6"></div>
    </div>

  </div>

  <!-- 모바일 전용: 프리셋 오버레이(슬라이드 인) -->
  <div id="presetOverlay" class="lg:hidden fixed inset-0 z-50 hidden">
    <div id="presetBackdrop" class="absolute inset-0 bg-black/60"></div>

    <div id="presetSheet"
         class="absolute right-0 top-0 h-full w-[92%] max-w-md bg-gray-800 border-l border-gray-700 shadow-2xl
                translate-x-full transition-transform duration-200 ease-out p-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">프리셋</h2>
        <button id="closePresetBtnMobile" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded border border-gray-600">
          닫기
        </button>
      </div>

      <div class="flex flex-wrap gap-2 mb-4">
        <button id="importPresetMobile" class="bg-gray-700 px-3 py-2 rounded border border-gray-600 hover:bg-gray-600">
          가져오기
        </button>
        <button id="exportPresetMobile" class="bg-gray-700 px-3 py-2 rounded border border-gray-600 hover:bg-gray-600">
          내보내기
        </button>
        <button id="deletePresetMobile" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded border border-rose-500 text-rose-200">
          전체 삭제
        </button>
      </div>

      <div class="flex gap-2 mb-4">
        <input id="cmdInputMobile" type="text" placeholder="Command"
               class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2" />
        <button id="addCmdMobile" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded border border-emerald-500 text-emerald-200">
          추가
        </button>
      </div>

      <div id="groupsContainerMobile" class="flex flex-col gap-6 overflow-y-auto h-[calc(100vh-200px)] pr-1"></div>
    </div>
  </div>

<script>
let port, reader, writer;
const decoder = new TextDecoder();
const encoder = new TextEncoder();
let presetData = {};

function safeEnding(){ return document.getElementById("ending").value; }
function savePresets(){ localStorage.setItem("presetGroups", JSON.stringify(presetData)); }
function loadPresets(){ presetData = JSON.parse(localStorage.getItem("presetGroups") || "{}"); renderGroups(); }

/* ============================================================
   IMPORT with GROUP auto-detection (공통 함수)
============================================================ */
function doImportPreset(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".txt,application/json";

  input.onchange = (e) => {
    const file = e.target.files[0];
    const reader2 = new FileReader();

    reader2.onload = () => {
      let text = String(reader2.result || "").trim();
      let json = null;

      try { json = JSON.parse(text); } catch(err){ json = null; }

      /* 1) JSON 배열 → [GROUP] 자동 분리 */
      if (json && Array.isArray(json)) {
        let groups = {};
        let currentGroup = "Default";

        json.forEach(line => {
          line = String(line).trim();
          if (line.startsWith("[GROUP]")) {
            currentGroup = line.replace("[GROUP]", "").trim();
            if (!groups[currentGroup]) groups[currentGroup] = [];
          } else {
            if (!groups[currentGroup]) groups[currentGroup] = [];
            if (line.length) groups[currentGroup].push(line);
          }
        });

        presetData = groups;
        savePresets();
        renderGroups();
        return;
      }

      /* 2) JSON 객체 → 그대로 사용 */
      if (json && typeof json === "object") {
        presetData = json;
        savePresets();
        renderGroups();
        return;
      }

      /* 3) TXT → [GROUP] 자동 분리 */
      const lines = text
        .split(/\r?\n/)
        .map(v => v.trim())
        .filter(v => v.length > 0);

      let groups = {};
      let currentGroup = "Default";

      lines.forEach(line => {
        if (line.startsWith("[GROUP]")) {
          currentGroup = line.replace("[GROUP]", "").trim();
          if (!groups[currentGroup]) groups[currentGroup] = [];
        } else {
          if (!groups[currentGroup]) groups[currentGroup] = [];
          groups[currentGroup].push(line);
        }
      });

      presetData = groups;
      savePresets();
      renderGroups();
    };

    reader2.readAsText(file);
  };

  input.click();
}

/* ============================================================
   RENDER PRESETS (desktop + mobile 동시에 렌더)
============================================================ */
function renderGroups(){
  const containerDesktop = document.getElementById("groupsContainer");
  const containerMobile  = document.getElementById("groupsContainerMobile");

  if (containerDesktop) containerDesktop.innerHTML = "";
  if (containerMobile)  containerMobile.innerHTML  = "";

  Object.entries(presetData).forEach(([group, cmds]) => {

    function makeBox(){
      const box = document.createElement("div");
      box.className = "bg-gray-700 p-3 rounded-lg border border-gray-600";

      const header = document.createElement("div");
      header.className = "mb-2";

      const title = document.createElement("h3");
      title.className = "font-semibold text-blue-300";
      title.textContent = group;

      header.appendChild(title);
      box.appendChild(header);

      const list = document.createElement("div");
      list.className = "flex flex-wrap gap-2";

      (cmds || []).forEach(cmd => {
        const tag = document.createElement("div");
        tag.className =
          "inline-flex items-center bg-gray-600 text-white px-2 py-1 rounded-full cursor-pointer text-sm";

        const textSpan = document.createElement("span");
        textSpan.textContent = cmd;

        textSpan.onclick = () => {
          if (!writer) return alert("포트가 열려 있지 않습니다.");
          writer.write(encoder.encode(cmd + safeEnding()));
        };

        tag.appendChild(textSpan);
        list.appendChild(tag);
      });

      box.appendChild(list);
      return box;
    }

    const boxDesktop = makeBox();
    const boxMobile  = makeBox();

    if (containerDesktop) containerDesktop.appendChild(boxDesktop);
    if (containerMobile)  containerMobile.appendChild(boxMobile);
  });
}

/* ============================================================
   기타 기능 (공통 함수)
============================================================ */
function addCommand(cmd){
  const v = String(cmd || "").trim();
  if(!v) return;

  if(!presetData["Default"]) presetData["Default"] = [];
  presetData["Default"].push(v);

  savePresets();
  renderGroups();
}

function deleteAllPresets(){
  if(!confirm("모든 프리셋을 삭제하시겠습니까?")) return;
  presetData = {};
  savePresets();
  renderGroups();
}

function exportPresets(){
  const blob = new Blob([JSON.stringify(presetData,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "presets.json";
  a.click();
}

/* ============================================================
   초기 로드
============================================================ */
loadPresets();

/* ============================================================
   데스크톱 버튼 핸들러
============================================================ */
document.getElementById("importPreset").onclick = doImportPreset;

document.getElementById("addCmd").onclick = () => {
  const el = document.getElementById("cmdInput");
  addCommand(el.value);
  el.value = "";
};

document.getElementById("deletePreset").onclick = deleteAllPresets;
document.getElementById("exportPreset").onclick = exportPresets;

/* ============================================================
   모바일 버튼 핸들러(같은 로직 재사용)
============================================================ */
document.getElementById("importPresetMobile").onclick = doImportPreset;
document.getElementById("exportPresetMobile").onclick = exportPresets;
document.getElementById("deletePresetMobile").onclick = deleteAllPresets;

document.getElementById("addCmdMobile").onclick = () => {
  const el = document.getElementById("cmdInputMobile");
  addCommand(el.value);
  el.value = "";
};

document.getElementById("cmdInputMobile").addEventListener("keydown", e => {
  if(e.key === "Enter"){
    e.preventDefault();
    document.getElementById("addCmdMobile").click();
  }
});

/* ============================================================
   Serial
============================================================ */
async function readLoop(){
  try{
    reader = port.readable.getReader();
    const out = document.getElementById("serialOutput");

    while(true){
      const { value, done } = await reader.read();
      if(done) break;

      out.innerHTML += decoder.decode(value);
      if(document.getElementById("autoScroll").checked)
        out.scrollTop = out.scrollHeight;
    }

  } catch(err){ console.log("⚠️ 포트 끊김:", err); }

  updateConnectionUI(false);
  try{ if(reader) reader.releaseLock(); }catch(e){}
}

document.getElementById("connectBtn").onclick = async () => {
  try{
    port = await navigator.serial.requestPort();
    await port.open({ baudRate:Number(document.getElementById("baud").value) });
    writer = port.writable.getWriter();
    readLoop();
    updateConnectionUI(true);
  }catch(e){ alert("연결 실패: " + e); }
};

document.getElementById("disconnectBtn").onclick = async () => {
  try{
    if(reader) await reader.cancel();
    if(writer) await writer.close();
    if(port) await port.close();
  }catch(e){}
  updateConnectionUI(false);
};

document.getElementById("sendBtn").onclick = () => {
  if(!writer) return alert("포트가 열려 있지 않습니다.");
  writer.write(encoder.encode(document.getElementById("msgInput").value + safeEnding()));
};

document.getElementById("msgInput").addEventListener("keydown", e => {
  if(e.key === "Enter"){
    e.preventDefault();
    document.getElementById("sendBtn").click();
  }
});

document.getElementById("clearBtn").onclick = () => {
  document.getElementById("serialOutput").textContent = "";
};

function updateConnectionUI(connected){
  const c = document.getElementById("connectBtn");
  const d = document.getElementById("disconnectBtn");

  if(connected){
    c.disabled = true;
    c.className =
      "bg-gray-700 px-4 py-1 rounded border border-emerald-500 text-emerald-200 cursor-default";
    c.textContent = "연결됨";

    d.disabled = false;
    d.className =
      "bg-gray-700 hover:bg-gray-600 px-4 py-1 rounded border border-rose-500 text-rose-200";
    d.textContent = "해제";
  } else {
    c.disabled = false;
    c.className =
      "bg-gray-700 hover:bg-gray-600 px-4 py-1 rounded border border-emerald-500 text-emerald-200";
    c.textContent = "포트 연결";

    d.disabled = true;
    d.className =
      "bg-gray-600 px-4 py-1 rounded border border-gray-500 text-gray-400 cursor-default";
    d.textContent = "해제됨";
  }
}

/* ============================================================
   프리셋 패널 열기/닫기 (PC + 모바일 오버레이)
============================================================ */
const consolePanelEl  = document.getElementById("consolePanel");
const presetPanelEl   = document.getElementById("presetPanel");
const togglePresetBtn = document.getElementById("togglePresetBtn");
const closePresetBtn  = document.getElementById("closePresetBtn");

// mobile overlay
const presetOverlay = document.getElementById("presetOverlay");
const presetSheet   = document.getElementById("presetSheet");
const presetBackdrop= document.getElementById("presetBackdrop");
const closePresetBtnMobile = document.getElementById("closePresetBtnMobile");

function isMobile(){
  return window.matchMedia("(max-width: 1023px)").matches; // lg 미만
}

function openPresetPanel(){
  if (isMobile()){
    // 모바일: 오버레이 슬라이드
    presetOverlay.classList.remove("hidden");
    requestAnimationFrame(() => presetSheet.classList.remove("translate-x-full"));
  } else {
    // 데스크톱: 오른쪽 패널 표시
    presetPanelEl.classList.remove("hidden");
    // 데스크톱에서 콘솔 폭 보정
    consolePanelEl.classList.remove("w-full");
    if (!consolePanelEl.classList.contains("lg:w-[60%]")) {
      consolePanelEl.classList.add("lg:w-[60%]");
    }
  }
}

function closePresetPanel(){
  if (isMobile()){
    presetSheet.classList.add("translate-x-full");
    setTimeout(() => presetOverlay.classList.add("hidden"), 200);
  } else {
    presetPanelEl.classList.add("hidden");
    // 콘솔은 lg에서만 풀폭 처리되도록
    consolePanelEl.classList.add("w-full");
  }
}

togglePresetBtn.addEventListener("click", openPresetPanel);
closePresetBtn.addEventListener("click", closePresetPanel);
closePresetBtnMobile.addEventListener("click", closePresetPanel);
presetBackdrop.addEventListener("click", closePresetPanel);

// 화면 크기 바뀔 때 상태 정리(모바일→데스크톱 / 데스크톱→모바일)
window.addEventListener("resize", () => {
  if (isMobile()){
    // 데스크톱 패널은 숨김 유지
    presetPanelEl.classList.add("hidden");
    consolePanelEl.classList.add("w-full");
  } else {
    // 모바일 오버레이 닫기
    presetSheet.classList.add("translate-x-full");
    presetOverlay.classList.add("hidden");
  }
});
</script>

</body>
</html>
