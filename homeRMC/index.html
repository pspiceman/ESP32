<!doctype html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
<title>Home Control System</title>

<!-- ‚úÖ Pretendard -->
<link rel="stylesheet" as="style" crossorigin
  href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />

<!-- ‚úÖ (Ï∂îÍ∞Ä) Mobile / PWA Icon ÏÑ§Ï†ï -->
<link rel="icon" type="image/png" href="homeRMC.png">
<link rel="apple-touch-icon" href="homeRMC.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2b2f3a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- ‚úÖ MQTT over WebSocket -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
  :root{
    --bgA:#2b2f3a;
    --bgB:#1f2430;
    --card:#2a3040;
    --card2:#242a38;
    --stroke:rgba(255,255,255,.10);
    --text:#f5f7ff;
    --sub:#c6cee6;
    --green:#37ff79;
    --greenSoft:rgba(55,255,121,.14);
    --danger:#ff4c4c;
    --shadow: 0 14px 30px rgba(0,0,0,.35);
    --shadowSoft: 0 10px 22px rgba(0,0,0,.22);
    --btnGrad: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
    --btnStroke: rgba(255,255,255,.10);
    --glow: 0 0 14px rgba(55,255,121,.35), 0 0 28px rgba(55,255,121,.18);
    --textGlow: 0 0 10px rgba(255,255,255,.12);
  }

  body.theme-light{
    --bgA:#f4f6ff;
    --bgB:#eef2ff;
    --card:#ffffff;
    --card2:#f7f9ff;
    --stroke:rgba(15,23,42,.10);
    --text:#111827;
    --sub:#6b7280;
    --green:#16a34a;
    --greenSoft:rgba(22,163,74,.12);
    --danger:#dc2626;
    --shadow: 0 12px 28px rgba(15,23,42,.10);
    --shadowSoft: 0 10px 22px rgba(15,23,42,.10);
    --btnGrad: linear-gradient(180deg,#ffffff,#eef2ff);
    --btnStroke: rgba(15,23,42,.12);
    --glow: 0 0 12px rgba(22,163,74,.20), 0 0 24px rgba(22,163,74,.10);
    --textGlow: 0 0 10px rgba(15,23,42,.10);
  }

  *{box-sizing:border-box;}
  body{
    margin:0;
    padding:0;
    font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI",
                 system-ui, Roboto, "Noto Sans KR", sans-serif;
    background: radial-gradient(circle at top, var(--bgA) 0, var(--bgB) 55%, #151925 100%);
    color: var(--text);
    transition: background .25s ease, color .25s ease;
    display:flex;
    justify-content:center;
  }
  body.theme-light{
    background: radial-gradient(circle at top, #e5edff 0, #f9fafb 45%, #e5e7eb 100%);
  }

  .wrap{
    width:360px;
    max-width:100vw;
    padding:14px 12px 18px;
  }

  /* TITLE */
  .titleRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin: 6px 0 12px;
  }

  .heroTitle{
    font-size: 24px;
    font-weight: 900;
    letter-spacing: 0.02em;
    line-height: 1.05;
    background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(210,220,255,.80));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow:
      0 1px 0 rgba(255,255,255,.20),
      0 2px 8px rgba(0,0,0,.28),
      var(--textGlow);
  }
  body.theme-light .heroTitle{
    background: linear-gradient(180deg, rgba(17,24,39,.98), rgba(55,65,81,.72));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow:
      0 1px 0 rgba(255,255,255,.35),
      0 2px 6px rgba(15,23,42,.18);
  }

  .themeToggle{
    border-radius:999px;
    padding:8px 10px;
    border:1px solid rgba(148,163,184,0.55);
    background:rgba(15,23,42,0.45);
    color:var(--text);
    font-size:16px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition: all .18s;
    min-width:44px;
    box-shadow: var(--shadowSoft);
  }
  body.theme-light .themeToggle{
    background:#f3f4ff;
    color:#111827;
    border-color:rgba(99,102,241,0.25);
  }
  .themeToggle:active{transform:scale(.98);}

  /* STATUS PANEL */
  .panel{
    background: linear-gradient(180deg, var(--card), var(--card2));
    border:1px solid var(--stroke);
    border-radius:18px;
    padding:12px;
    box-shadow: var(--shadow);
  }

  .statusRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .leftBlock{
    display:flex;
    align-items:center;
    gap:10px;
    flex:1;
    min-width:0;
  }

  .pill{
    height:34px;
    padding:0 12px;
    border-radius:999px;
    display:inline-flex;
    align-items:center;
    gap:7px;
    font-size:12px;
    font-weight:800;
    border:1px solid rgba(148,163,184,0.35);
    background: rgba(255,255,255,.06);
    color: var(--sub);
    white-space:nowrap;
  }

  .pill.ok{
    border-color: rgba(55,255,121,0.55);
    background: var(--greenSoft);
    color: var(--text);
    box-shadow: var(--glow);
  }
  .pill.bad{
    border-color: rgba(255,76,76,0.55);
    background: rgba(255,76,76,0.12);
    color: var(--text);
    box-shadow: 0 0 12px rgba(255,76,76,0.18);
  }

  .gatewayPill{
    height:34px;
    flex:1;
    min-width:0;
    border-radius:999px;
    border:1px solid rgba(55,255,121,0.75);
    background: rgba(10, 14, 20, .55);
    color: var(--green);
    font-weight: 800;
    font-size: 12.5px;
    display:flex;
    align-items:center;
    padding:0 12px;
    box-shadow: var(--glow);
    overflow:hidden;
  }

  body.theme-light .gatewayPill{
    background: linear-gradient(180deg, #eafff3, #d9ffe9);
    border-color: rgba(22,163,74,.40);
    color: #0f5132;
    box-shadow: 0 6px 16px rgba(22,163,74,.14);
  }

  .gatewayPill .left{
    font-weight: 900;
    letter-spacing: .2px;
    margin-right:10px;
    white-space:nowrap;
  }
  .gatewayPill .right{
    margin-left:auto;
    white-space:nowrap;
    color: var(--text);
    opacity:.95;
    font-weight: 800;
  }
  body.theme-light .gatewayPill .right{
    color:#0f5132;
  }

  .resetBtn{
    height:34px;
    padding:0 14px;
    border-radius:999px;
    border:1px solid rgba(55,255,121,0.65);
    background: linear-gradient(180deg, rgba(22,163,74,.95), rgba(22,163,74,.75));
    color:#ecfdf5;
    font-weight:900;
    font-size:12px;
    letter-spacing:.3px;
    cursor:pointer;
    box-shadow: 0 10px 20px rgba(22,163,74,0.18);
    white-space:nowrap;
  }
  .resetBtn:active{transform:scale(.98);}

  /* BIG BUTTONS */
  .grid{
    margin-top:12px;
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
  }
  .bigbtn{
    height: 96px;
    border-radius: 18px;
    border:1px solid var(--btnStroke);
    background: var(--btnGrad);
    box-shadow: var(--shadowSoft);
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    transition: transform .10s, box-shadow .12s, filter .12s;
    user-select:none;
  }
  .bigbtn:hover{filter:brightness(1.05);}
  .bigbtn:active{
    transform: translateY(2px) scale(.985);
  }
  .bigbtn.sent{
    border-color: rgba(55,255,121,0.55);
    box-shadow: 0 0 22px rgba(55,255,121,0.22), var(--shadowSoft);
    filter: brightness(1.08);
  }
  .bigbtn.loading{opacity:.75;pointer-events:none;}

  .icon{font-size:16px;opacity:.9;}

  .btnLabel{
    font-size: 20px;
    font-weight: 900;
    letter-spacing: 0.05em;
    background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(210,220,255,.78));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow:
      0 1px 0 rgba(255,255,255,.18),
      0 2px 8px rgba(0,0,0,.25),
      var(--textGlow);
  }
  body.theme-light .btnLabel{
    background: linear-gradient(180deg, rgba(17,24,39,.98), rgba(55,65,81,.70));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow:
      0 1px 0 rgba(255,255,255,.35),
      0 2px 6px rgba(15,23,42,.16);
  }

  /* FOOTER */
  .footer{
    margin-top:12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .datetime{
    font-size:12.5px;
    color: var(--sub);
    font-weight: 700;
  }

  .bugBtn{
    height:34px;
    padding:0 12px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.35);
    background: rgba(255,255,255,.06);
    color: var(--sub);
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:6px;
    font-size:12px;
    font-weight:800;
    box-shadow: var(--shadowSoft);
    user-select:none;
  }
  .bugBtn.active{
    background: linear-gradient(135deg,#3b82f6,#22c55e);
    color:#f9fbff;
    box-shadow: 0 0 12px rgba(34,197,94,0.35);
    border-color: transparent;
  }
  .bugBtn:active{transform:scale(.98);}

  .logPanel{
    margin-top:10px;
    background: rgba(0,0,0,.22);
    border:1px solid rgba(40,60,120,0.35);
    border-radius:14px;
    padding:10px;
    display:none;
    max-height: 220px;
    overflow:auto;
    font-size:12.5px;
    color: var(--sub);
    box-shadow: var(--shadowSoft);
  }
  body.theme-light .logPanel{
    background:#ffffff;
    border-color:rgba(99,102,241,0.18);
    color:#374151;
  }
  .logPanel.show{display:block;}
  .logLine{
    padding:7px 6px;
    border-bottom:1px dashed rgba(148,163,184,0.25);
    word-break:break-word;
  }
  .logLine:last-child{border-bottom:none;}
</style>
</head>

<body>
  <div class="wrap">

    <div class="titleRow">
      <div class="heroTitle">Home Control System</div>
      <button id="themeToggle" class="themeToggle" type="button" onclick="toggleTheme()">
        <span id="themeIcon">üåô</span>
      </button>
    </div>

    <div class="panel">
      <div class="statusRow">
        <div class="leftBlock">
          <span id="mqttPill" class="pill">MQTT</span>

          <div class="gatewayPill">
            <span class="left">Ïû•ÎπÑÏó∞Í≤∞</span>
            <span id="rssiText" class="right">-- dBm</span>
          </div>
        </div>

        <button class="resetBtn" onclick="sendReset()">RESET</button>
      </div>
    </div>

    <div class="grid">
      <button class="bigbtn" onclick="sendCmd(this,'LIGHT')">
        <span class="icon">üí°</span><span class="btnLabel">LIGHT</span>
      </button>

      <button class="bigbtn" onclick="sendCmd(this,'SPK1')">
        <span class="icon">üîä</span><span class="btnLabel">SPK1</span>
      </button>

      <button class="bigbtn" onclick="sendCmd(this,'SPK2')">
        <span class="icon">üì¢</span><span class="btnLabel">SPK2</span>
      </button>

      <button class="bigbtn" onclick="sendCmd(this,'DOOR')">
        <span class="icon">üö™</span><span class="btnLabel">DOOR</span>
      </button>
    </div>

    <div class="footer">
      <div id="dt" class="datetime">--</div>
      <button id="btnLog" class="bugBtn" type="button" onclick="toggleLog()">
        <span class="icon">üêû</span><span>Î°úÍ∑∏</span>
      </button>
    </div>

    <div id="logPanel" class="logPanel"></div>
  </div>

<script>
const MQTT_URL = "wss://broker.hivemq.com:8884/mqtt";
const TOPIC_CMD    = "tswell/433home/cmd";
const TOPIC_STATUS = "tswell/433home/status";
const TOPIC_LOG    = "tswell/433home/log";

const mqttPill  = document.getElementById("mqttPill");
const rssiText  = document.getElementById("rssiText");
const dtEl      = document.getElementById("dt");
const logPanel  = document.getElementById("logPanel");
const btnLog    = document.getElementById("btnLog");
const themeIcon = document.getElementById("themeIcon");

function addLog(msg){
  const time = new Date().toLocaleTimeString();
  const div = document.createElement("div");
  div.className = "logLine";
  div.textContent = `[${time}] ${msg}`;
  logPanel.appendChild(div);
  logPanel.scrollTop = logPanel.scrollHeight;
}

function toggleLog(){
  const visible = (logPanel.style.display === "block");
  logPanel.style.display = visible ? "none" : "block";
  btnLog.classList.toggle("active", !visible);
}

function updateDateTime(){
  const d = new Date();
  const y = d.getFullYear();
  const mo = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  dtEl.textContent = `${y}-${mo}-${da} ${hh}:${mm}:${ss}`;
}
setInterval(updateDateTime, 1000);
updateDateTime();

function applyTheme(theme){
  const isLight = (theme === "light");
  document.body.classList.toggle("theme-light", isLight);
  themeIcon.textContent = isLight ? "‚òÄÔ∏è" : "üåô";
}
function toggleTheme(){
  const isLight = document.body.classList.contains("theme-light");
  const next = isLight ? "dark" : "light";
  localStorage.setItem("hcs-theme", next);
  applyTheme(next);
}
applyTheme(localStorage.getItem("hcs-theme") || "dark");

/* MQTT connect */
let client = mqtt.connect(MQTT_URL, { reconnectPeriod: 3000 });

client.on("connect", ()=>{
  mqttPill.className = "pill ok";
  mqttPill.textContent = "MQTT OK";
  addLog("[MQTT] connected");

  client.subscribe(TOPIC_STATUS);
  client.subscribe(TOPIC_LOG);
  addLog("[MQTT] subscribed: status + log");
});

client.on("close", ()=>{
  mqttPill.className = "pill bad";
  mqttPill.textContent = "MQTT OFF";
  addLog("[MQTT] disconnected");
});

client.on("message", (topic, msg)=>{
  const text = msg.toString();

  if(topic === TOPIC_LOG){
    addLog(text);
    return;
  }

  if(topic === TOPIC_STATUS){
    try{
      const j = JSON.parse(text);
      const mqttOk = !!j.mqtt;
      const rssi   = (typeof j.rssi === "number") ? j.rssi : "--";

      mqttPill.className = "pill " + (mqttOk ? "ok" : "bad");
      mqttPill.textContent = mqttOk ? "MQTT OK" : "MQTT OFF";
      rssiText.textContent = `${rssi} dBm`;
    }catch(e){
      addLog("[STATUS] parse error");
    }
  }
});

/* Publish */
function publishCmd(cmd){
  if(!client || !client.connected){
    addLog("MQTT ÎØ∏Ïó∞Í≤∞ - Î™ÖÎ†π Ï†ÑÏÜ° Î∂àÍ∞Ä");
    return false;
  }
  client.publish(TOPIC_CMD, cmd);
  return true;
}

/* ‚úÖ ÎàåÎ¶º ÌëúÏãúÎ•º Îçî Í∏∏Í≤å */
const PRESS_MS = 900;

function sendCmd(btn, cmd){
  btn.classList.add("sent","loading");
  setTimeout(()=>btn.classList.remove("sent"), PRESS_MS);

  const ok = publishCmd(cmd);
  addLog(ok ? `SEND ${cmd}` : `FAIL ${cmd}`);

  setTimeout(()=>btn.classList.remove("loading"), 250);
}

function sendReset(){
  const ok = publishCmd("reset");
  addLog(ok ? "SEND reset" : "FAIL reset");
}
</script>
</body>
</html>
