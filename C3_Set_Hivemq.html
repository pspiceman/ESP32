<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ESP32+HiveMQ ëŒ€ì‹œ ë³´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root {
      --bg: #f5f5f5;
      --fg: #111827;
      --subtle: #6b7280;
      --muted: #9ca3af;
      --card-bg: #ffffff;
      --metric-bg: #fafafa;
      --shadow: 0 2px 6px rgba(0,0,0,0.08);
      --log-bg: #111827;
      --log-fg: #e5e7eb;
      --border-soft: rgba(0,0,0,0.06);
    }

    body[data-theme="dark"] {
      --bg: #020617;
      --fg: #e5e7eb;
      --subtle: #9ca3af;
      --muted: #6b7280;
      --card-bg: #020617;
      --metric-bg: #020617;
      --shadow: 0 2px 10px rgba(0,0,0,0.55);
      --log-bg: #020617;
      --log-fg: #e5e7eb;
      --border-soft: rgba(148,163,184,0.4);
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--fg);
      margin: 0;
      padding: 16px;
      transition: background 0.25s ease, color 0.25s ease;
    }

    h1 { margin-top: 0; font-size: 1.5rem; }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 12px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      border: 1px solid var(--border-soft);
      transition: background 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
    }

    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      background: #9ca3af;
    }

    .status-ok { background: #22c55e; }
    .status-bad { background: #ef4444; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }

    .metric {
      background: var(--metric-bg);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      border: 1px solid var(--border-soft);
    }

    .metric-label { font-size: 0.8rem; color: var(--subtle); }
    .metric-value { font-size: 1.3rem; font-weight: 600; margin-top: 4px; }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-right: 8px;
      margin-top: 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    #btnOn { background: #2ecc71; color: #fff; }
    #btnOff { background: #e74c3c; color: #fff; }

    .theme-toggle {
      background: transparent;
      color: var(--subtle);
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 10px;
      font-size: 1rem;
      line-height: 1;
      margin-top: -4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle-icon { font-size: 1.2rem; }

    #log {
      font-family: ui-monospace, monospace;
      font-size: 0.8rem;
      max-height: 200px;
      overflow-y: auto;
      background: var(--log-bg);
      color: var(--log-fg);
      padding: 8px;
      border-radius: 8px;
      white-space: pre-wrap;
      border: 1px solid var(--border-soft);
    }
  </style>
</head>

<body data-theme="light">
  <header class="page-header">
    <h1>ESP32+HiveMQ ëŒ€ì‹œ ë³´ë“œ</h1>
    <button id="themeToggle" class="theme-toggle"><span class="theme-toggle-icon">ğŸŒ</span></button>
  </header>

  <!-- ìƒíƒœ ì¹´ë“œ -->
  <div class="card">
    <div>
      <span id="mqttDot" class="status-dot"></span>
      <strong id="mqttState">MQTT ì—°ê²° ëŒ€ê¸° ì¤‘...</strong>
    </div>

    <!-- â—€ ìˆ˜ì •ëœ ë¶€ë¶„ -->
    <div style="margin-top:4px;font-size:0.85rem;color:var(--subtle);">
      ë¸Œë¡œì»¤: <code>broker.hivemq.com</code><br>
      Web: <code>WS 8000</code> / ESP32: <code>1883</code>
    </div>

    <div style="margin-top:4px;font-size:0.8rem;color:var(--muted);">
      ì¥ë¹„ ìƒíƒœ: <span id="deviceState">ì•Œ ìˆ˜ ì—†ìŒ</span>
    </div>
    <div style="margin-top:4px;font-size:0.8rem;color:var(--muted);">
      ë§ˆì§€ë§‰ ìˆ˜ì‹  ì‹œê°: <span id="lastUpdate">-</span>
    </div>
  </div>

  <!-- ì„¼ì„œ ì¹´ë“œ -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">ì„¼ì„œ ìƒíƒœ (esp32c3/status)</h2>
    <div class="grid">
      <div class="metric"><div class="metric-label">ì˜¨ë„</div><div class="metric-value"><span id="valTemp">--</span> Â°C</div></div>
      <div class="metric"><div class="metric-label">ìŠµë„</div><div class="metric-value"><span id="valHum">--</span> %</div></div>
      <div class="metric"><div class="metric-label">COâ‚‚</div><div class="metric-value"><span id="valCo2">--</span> ppm</div></div>
      <div class="metric"><div class="metric-label">ì¼ì‚¬ëŸ‰</div><div class="metric-value"><span id="valSolar">--</span></div></div>
      <div class="metric"><div class="metric-label">LED ìƒíƒœ</div><div class="metric-value"><span id="valLed">--</span></div></div>
      <div class="metric"><div class="metric-label">RSSI</div><div class="metric-value"><span id="valRssi">--</span> dBm</div></div>
    </div>
  </div>

  <!-- LED ì œì–´ -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">LED ì œì–´ (esp32c3/led)</h2>
    <button id="btnOn">LED ON</button>
    <button id="btnOff">LED OFF</button>
    <div id="cmdResult" style="margin-top:8px;font-size:0.8rem;color:var(--subtle);">-</div>
  </div>

  <!-- ë¡œê·¸ -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">ë¡œê·¸</h2>
    <div id="log"></div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);

    const mqttDotEl     = $("#mqttDot");
    const mqttStateEl   = $("#mqttState");
    const deviceStateEl = $("#deviceState");
    const lastUpdateEl  = $("#lastUpdate");
    const logEl         = $("#log");

    const valTemp  = $("#valTemp");
    const valHum   = $("#valHum");
    const valCo2   = $("#valCo2");
    const valSolar = $("#valSolar");
    const valLed   = $("#valLed");
    const valRssi  = $("#valRssi");

    const btnOn  = $("#btnOn");
    const btnOff = $("#btnOff");

    const themeToggleBtn  = $("#themeToggle");
    const themeIcon       = themeToggleBtn.querySelector(".theme-toggle-icon");

    // ------------------ ë‹¤í¬/ë¼ì´íŠ¸ í…Œë§ˆ ------------------
    function applyTheme(t) {
      document.body.setAttribute("data-theme", t);
      themeIcon.textContent = t === "dark" ? "ğŸŒ™" : "ğŸŒ";
    }

    (function restoreTheme() {
      const saved = localStorage.getItem("hivemq-theme");
      applyTheme(saved || "light");
    })();

    themeToggleBtn.onclick = () => {
      const cur = document.body.getAttribute("data-theme");
      const next = cur === "dark" ? "light" : "dark";
      localStorage.setItem("hivemq-theme", next);
      applyTheme(next);
    };

    // ------------------ MQTT ì—°ê²° ------------------
    function log(msg) {
      logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setMqttStatus(ok, text) {
      mqttDotEl.classList.remove("status-ok", "status-bad");
      mqttDotEl.classList.add(ok ? "status-ok" : "status-bad");
      mqttStateEl.textContent = text;
    }

    function setDeviceState(ok) {
      deviceStateEl.textContent = ok ? "ì˜¨ë¼ì¸" : "ì˜¤í”„ë¼ì¸";
      deviceStateEl.style.color = ok ? "#16a34a" : "#dc2626";
    }

    // ------- ë¸Œë¡œì»¤: broker.hivemq.com ------
    const brokerUrl = "ws://broker.hivemq.com:8000/mqtt";
    const options = {
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 4000,
    };

    const client = mqtt.connect(brokerUrl, options);

    client.on("connect", () => {
      setMqttStatus(true, "MQTT ì—°ê²° OK (broker.hivemq.com)");
      log("ì—°ê²° ì„±ê³µ");

      client.subscribe("esp32c3/status", (err) => {
        if (!err) log("êµ¬ë… ì„±ê³µ esp32c3/status");
      });
    });

    client.on("error", e => {
      setMqttStatus(false, "MQTT ì—ëŸ¬");
      log("MQTT ì—ëŸ¬: " + e.message);
    });

    client.on("close", () => {
      setMqttStatus(false, "MQTT ì—°ê²° ëŠê¹€");
      log("ì—°ê²° ëŠê¹€");
    });

    client.on("message", (topic, payload) => {
      let text = new TextDecoder().decode(payload);
      log(`ìˆ˜ì‹ (${topic}): ${text}`);

      if (!text.startsWith("{")) return;

      const data = JSON.parse(text);

      setDeviceState(data.alive !== false);

      valTemp.textContent  = data.temp  ?? "--";
      valHum.textContent   = data.hum   ?? "--";
      valCo2.textContent   = data.co2   ?? "--";
      valSolar.textContent = data.solar ?? "--";
      valLed.textContent   = data.led ? "ON" : "OFF";
      valRssi.textContent  = data.rssi ?? "--";

      lastUpdateEl.textContent = new Date().toLocaleString();
    });

    // ------- LED ì œì–´ í† í”½: esp32c3/led ------
    function sendLed(cmd) {
      if (!client.connected) return;
      client.publish("esp32c3/led", cmd);
      log("ì „ì†¡: " + cmd);
    }

    btnOn.onclick  = () => sendLed("LED_ON");
    btnOff.onclick = () => sendLed("LED_OFF");

  </script>
</body>
</html>
