<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LoRa Mesh + MQTT Monitor</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê¸°ë³¸ í…Œë§ˆ ë³€ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg: #f5f6fa;
  --text: #111;
  --card: #ffffff;
  --border: #cfcfcf;
  --table-alt: #eef1f5;
  --log-bg: #fff;
  --log-fg: #000;

  --online-color: #37ff79;
  --offline-color: #ff4c4c;
}

[data-theme="dark"] {
  --bg: #0d111d;
  --text: #e9eef6;
  --card: #141b2d;
  --border: #2b2f3b;
  --table-alt: #1b2436;
  --log-bg: #000;
  --log-fg: #00ff00;

  --online-color: #37ff79;
  --offline-color: #ff6666;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì „ì²´ ë ˆì´ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body {
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, sans-serif;
  margin: 0;
  padding: 16px;
}

.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.title {
  font-size:22px;
  font-weight:700;
}
.theme-btn {
  font-size:25px;
  border:none;
  background:none;
  cursor:pointer;
  color:var(--text);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒë‹¨ ìƒíƒœ + ë¦¬ì…‹ ë²„íŠ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.top-row {
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.status-group {
  display:flex;
  align-items:center;
  gap:14px;
}

/* [ MQTT: ì—°ê²°ë¨ ] ë°•ìŠ¤ ë””ìì¸ */
.status-box {
  display:inline-flex;
  align-items:center;
  gap:6px;

  padding:6px 12px;
  background:#2a2a2c;      /* íšŒìƒ‰ ë°•ìŠ¤ */
  border-radius:8px;
  border:1px solid #444;

  font-weight:700;
}

.label {
  color:#cfcfcf;           /* í•­ëª© ë¼ë²¨ì€ í•­ìƒ Gray */
}

.state-text {
  font-size:15px;
  font-weight:700;
}

/* ìƒíƒœê°’ ìƒ‰ìƒ */
.status-on {
  color: var(--online-color);
}
.status-off {
  color: var(--offline-color);
}

/* ë¦¬ì…‹ ë²„íŠ¼ */
.reset-btn {
  padding:6px 12px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  background:#ef4444;
  color:#fff;
}
.reset-btn:hover { opacity:0.9; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ í…Œì´ë¸” â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background:var(--card);
  padding:12px;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,0.18);
  margin-top:12px;
}
table {
  width:100%;
  border-collapse:collapse;
  font-size:15px;
}
th,td {
  padding:7px 4px;
  border-bottom:1px solid var(--border);
  text-align:center;
}
tr:nth-child(even){ background:var(--table-alt); }
.lowbat { color:red; font-weight:bold; }
.node-missing { color:#ff3b3b; font-weight:800; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë¡œê·¸ ì˜ì—­ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.debug-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:6px;
}
.log-toggle{
  font-size:22px;
  background:none;
  border:none;
  cursor:pointer;
  color:var(--text);
}
.log-box{
  display:none;
  margin-top:10px;
  padding:10px;
  height:220px;
  overflow-y:auto;
  border-radius:10px;
  white-space:pre-line;
  background:var(--log-bg);
  color:var(--log-fg);
  border:1px solid var(--border);
}
.time-text{ font-size:12px; opacity:0.8; }
</style>
</head>

<body>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒë‹¨ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="header">
  <div class="title">LoRa Mesh + MQTT Monitor</div>
  <button class="theme-btn" id="themeBtn">ğŸŒ™</button>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ MQTT/ì¥ë¹„ ìƒíƒœ + ë¦¬ì…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="top-row">

  <div class="status-group">

    <!-- MQTT ìƒíƒœ -->
    <div class="status-box">
      <span class="label">MQTT:</span>
      <span id="mqttState" class="state-text status-off">ì—°ê²°ì•ˆë¨</span>
    </div>

    <!-- ì¥ë¹„ ìƒíƒœ -->
    <div class="status-box">
      <span class="label">ì¥ë¹„ ìƒíƒœ:</span>
      <span id="deviceState" class="state-text status-off">OFF LINE</span>
    </div>

  </div>

  <button class="reset-btn" onclick="resetESP()">ë¦¬ì…‹</button>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ í…Œì´ë¸” â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="card">
  <table>
    <thead>
      <tr>
        <th>Node</th>
        <th>Bat</th>
        <th>Temp</th>
        <th>RH</th>
        <th>COâ‚‚</th>
        <th>RSSI</th>
        <th>LED</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë””ë²„ê·¸ / ë¡œê·¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="debug-bar">
  <button class="log-toggle" onclick="toggleLog()">ğŸ</button>
  <div id="timeBox" class="time-text">--:--:--</div>
</div>

<div id="logBox" class="log-box"></div>


<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ SCRIPT â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
const ESP = "http://192.168.31.200";
let client;
let nodes = {};

document.body.setAttribute("data-theme","dark");
themeBtn.textContent = "â˜€ï¸";

/* MQTT ì—°ê²° */
function connectMQTT(){
  client = mqtt.connect(
    "wss://6c56aefe0ddb4d57977c735f5070abe8.s1.eu.hivemq.cloud:8884/mqtt",
    {
      username:"mqtt_ESP32",
      password:"gomqtt_ESP32",
      reconnectPeriod:3000
    }
  );

  client.on("connect", ()=>{
    mqttState.textContent = "ì—°ê²°ë¨";
    mqttState.classList.remove("status-off");
    mqttState.classList.add("status-on");

    client.subscribe("lora/node/+/data");
  });

  client.on("close", ()=>{
    mqttState.textContent = "ì—°ê²°ì•ˆë¨";
    mqttState.classList.remove("status-on");
    mqttState.classList.add("status-off");
  });

  client.on("message", (topic, msg)=>{
    const id = Number(topic.split("/")[2]);
    if (!id || id === 99) return;

    const data = JSON.parse(msg);
    nodes[id] = { ...nodes[id], ...data, last: Date.now() };

    renderTable();
    updateDeviceStatus();
    addLog(`[MQTT] ${topic} â†’ ${msg}`);
  });
}
connectMQTT();

/* ESP32 ë¦¬ì…‹ */
function resetESP(){
  fetch(ESP+"/reset",{method:"POST"})
    .then(()=>addLog("[RESET] Reset í˜¸ì¶œ"))
    .catch(e=>addLog("[RESET] error: "+e));
}

/* í…Œì´ë¸” ë Œë”ë§ */
function renderTable(){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  const now = Date.now();

  Object.keys(nodes)
    .sort((a,b)=>a-b)
    .forEach(id=>{
      const d = nodes[id];
      const missing = now - d.last > 8000;
      const lowbat = d.bat < 3.0;

      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td class="${missing?'node-missing':''}">${id}</td>
        <td class="${lowbat?'lowbat':''}">${d.bat ?? '--'}</td>
        <td>${d.t ?? '--'}</td>
        <td>${d.rh ?? '--'}</td>
        <td>${d.co2 ?? '--'}</td>
        <td>${d.rssi ?? '--'}</td>
        <td><input type="checkbox" onchange="sendLED(${id},this.checked)" ${d.led?'checked':''}></td>
      `;
      tbody.appendChild(tr);
    });
}

/* LED ì œì–´ */
function sendLED(id, checked){
  client.publish(`lora/node/${id}/cmd`, checked?"1":"0");
  addLog(`[LED] node ${id} â†’ ${checked?1:0}`);
}

/* ë¡œê·¸ */
function toggleLog(){
  logBox.style.display = logBox.style.display==="block" ? "none" : "block";
}
function addLog(t){
  logBox.textContent += t+"\n";
  logBox.scrollTop = logBox.scrollHeight;
}

/* í…Œë§ˆ ì „í™˜ */
themeBtn.onclick = ()=>{
  const dark = document.body.getAttribute("data-theme")==="dark";
  if(dark){
    document.body.removeAttribute("data-theme");
    themeBtn.textContent = "ğŸŒ™";
  } else {
    document.body.setAttribute("data-theme","dark");
    themeBtn.textContent = "â˜€ï¸";
  }
};

/* ì‹œê°„ í‘œì‹œ */
setInterval(()=>{
  const d=new Date();
  timeBox.textContent =
    `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} `
    +`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
},1000);

/* ì¥ë¹„ ìƒíƒœ ê°±ì‹  */
function updateDeviceStatus(){
  const now = Date.now();
  const ids = Object.keys(nodes);

  let offline = ids.length === 0;

  ids.forEach(id=>{
    if(now - nodes[id].last > 8000) offline = true;
  });

  if(offline){
    deviceState.textContent = "OFF LINE";
    deviceState.classList.remove("status-on");
    deviceState.classList.add("status-off");
  } else {
    deviceState.textContent = "ON LINE";
    deviceState.classList.remove("status-off");
    deviceState.classList.add("status-on");
  }
}
setInterval(updateDeviceStatus, 2000);
</script>

</body>
</html>
