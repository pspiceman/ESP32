<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 + HiveMQ Cloud Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root {
      --bg: #f5f5f5;
      --fg: #111827;
      --subtle: #6b7280;
      --muted: #9ca3af;
      --card-bg: #ffffff;
      --metric-bg: #fafafa;
      --shadow: 0 2px 6px rgba(0,0,0,0.08);
      --log-bg: #111827;
      --log-fg: #e5e7eb;
      --border-soft: rgba(0,0,0,0.06);
    }
    body[data-theme="dark"] {
      --bg: #020617;
      --fg: #e5e7eb;
      --subtle: #9ca3af;
      --muted: #6b7280;
      --card-bg: #020617;
      --metric-bg: #020617;
      --shadow: 0 2px 10px rgba(0,0,0,0.55);
      --log-bg: #020617;
      --log-fg: #e5e7eb;
      --border-soft: rgba(148,163,184,0.4);
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--fg);
      margin: 0; padding: 16px;
    }
    .page-header {
      display:flex;justify-content:space-between;align-items:center;
    }
    .card {
      background:var(--card-bg);
      border-radius:12px;
      padding:16px;
      border:1px solid var(--border-soft);
      box-shadow:var(--shadow);
      margin-bottom:16px;
    }
    .metric { background:var(--metric-bg);padding:10px;border-radius:10px;text-align:center;border:1px solid var(--border-soft); }
    .grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px; }
    #log { background:var(--log-bg);color:var(--log-fg);padding:8px;border-radius:8px;white-space:pre-wrap;max-height:180px;overflow-y:auto; }
    #btnReset { background:#e74c3c;color:white;padding:8px 16px;border:none;border-radius:8px;cursor:pointer; }
    .status-dot { width:10px;height:10px;background:#9ca3af;border-radius:50%;display:inline-block;margin-right:4px; }
    .status-ok { background:#22c55e; }
    .status-bad { background:#ef4444; }
  </style>
</head>

<body data-theme="light">

<header class="page-header">
  <h1>ESP32 + HiveMQ Cloud Dashboard</h1>
</header>

<div class="card">
  <div><span id="mqttDot" class="status-dot"></span>
    <strong id="mqttState">MQTT 연결 대기 중...</strong>
  </div>
  <div style="margin-top:6px;font-size:0.85rem;color:var(--subtle);">
    Broker(WSS): <code>6c56aefe0ddb4d57977c735f5070abe8.s1.eu.hivemq.cloud:8884</code>
  </div>
  <div style="margin-top:6px;font-size:0.85rem;color:var(--muted);">
    장비 상태: <span id="deviceState">알 수 없음</span>
  </div>
  <div style="margin-top:4px;font-size:0.8rem;color:var(--muted);">
    최근 업데이트: <span id="lastUpdate">-</span>
  </div>
</div>

<div class="card">
  <h2>ESP32 상태</h2>
  <div class="grid">
    <div class="metric">
      <div class="metric-label">ESP32 IP</div>
      <div class="metric-value"><span id="valIP">--</span></div>
    </div>
    <div class="metric">
      <div class="metric-label">메시지</div>
      <div class="metric-value"><span id="valMsg">--</span></div>
    </div>
  </div>
</div>

<div class="card">
  <h2>ESP32 Reset</h2>

  <!-- ===== 버튼 텍스트 변경된 부분 ===== -->
  <button id="btnReset">Reset Command</button>

  <div id="cmdResult" style="margin-top:8px;color:var(--subtle);font-size:0.8rem;">-</div>
</div>

<div class="card">
  <h2>로그</h2>
  <div id="log"></div>
</div>

<script>
const $ = q => document.querySelector(q);

const mqttDot = $("#mqttDot");
const mqttState = $("#mqttState");
const valIP = $("#valIP");
const valMsg = $("#valMsg");
const deviceState = $("#deviceState");
const lastUpdate = $("#lastUpdate");
const logEl = $("#log");
const cmdResult = $("#cmdResult");

function log(t){
  logEl.textContent += `[${new Date().toLocaleTimeString()}] ${t}\n`;
  logEl.scrollTop = logEl.scrollHeight;
}

function setMqttStatus(ok, text){
  mqttDot.classList.remove("status-ok","status-bad");
  mqttDot.classList.add(ok?"status-ok":"status-bad");
  mqttState.textContent = text;
}

const brokerUrl =
  "wss://6c56aefe0ddb4d57977c735f5070abe8.s1.eu.hivemq.cloud:8884/mqtt";

const client = mqtt.connect(brokerUrl, {
  clean:true,
  connectTimeout:4000,
  reconnectPeriod:5000,
  username:"mqtt_ESP32",
  password:"gomqtt_ESP32"
});

client.on("connect", ()=>{
  setMqttStatus(true,"MQTT 연결됨");
  log("MQTT(HiveMQ) 접속 성공");

  client.subscribe("esp32/ip");
  client.subscribe("esp32/response");
});

client.on("message",(topic,payload)=>{
  const msg = new TextDecoder().decode(payload);
  log(`수신: ${topic} → ${msg}`);

  if(topic==="esp32/ip"){
    valIP.textContent = msg;
    deviceState.textContent = "온라인";
    deviceState.style.color = "#22c55e";
  }

  if(topic==="esp32/response"){
    valMsg.textContent = msg;
  }

  lastUpdate.textContent = new Date().toLocaleString();
});

client.on("close",()=> setMqttStatus(false,"MQTT 연결 끊김"));
client.on("reconnect",()=> setMqttStatus(false,"MQTT 재연결 중..."));

$("#btnReset").addEventListener("click", ()=>{
  if(!client.connected){
    cmdResult.textContent = "MQTT 연결 안됨!";
    return;
  }
  client.publish("esp32/reset","1");
  cmdResult.textContent = "Reset Command 전송됨";
  log("Reset Command 전송");
});
</script>

</body>
</html>
