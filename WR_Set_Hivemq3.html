<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ</title>
<!-- MQTT JS (HiveMQ WebSocketìš©) -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
:root{--bg:#0b1020;--card:#131a2b;--txt:#e8eefc;--mut:#9fb2d7;--line:#22314f;--btn-bg:#1b2b4a;--btn-border:#2c3e63}
:root.light{--bg:#f5f7fa;--card:#ffffff;--txt:#0b1020;--mut:#5a6b8a;--line:#ccd4e0;--btn-bg:#e4e8ef;--btn-border:#b0bacb}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.5 system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif}
.wrap{max-width:1100px;margin:20px auto;padding:0 12px}
.card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h1{margin:0 0 8px;font-size:26px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
.mut{margin:0 0 4px;color:var(--mut)}
.mut.small{font-size:13px}
.theme-toggle{cursor:pointer;font-size:22px}

.status-block{margin-bottom:4px}
.status-block p{margin:0;font-size:13px;color:var(--mut);}
.state-online{color:#4ade80;}
.state-offline{color:#f97373;}

/* íƒ€ì¼ ë ˆì´ì•„ì›ƒ */
.grid{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:8px;
  margin:10px 0;
}
/* í™”ë©´ ë„“ìœ¼ë©´ 6ê°œ ê°€ë¡œ í•œ ì¤„ */
@media (min-width: 900px){
  .grid{
    grid-template-columns:repeat(6,minmax(0,1fr));
  }
}

.tile{
  padding:10px 12px;
  border-radius:10px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.16);   /* ë‹¤í¬/ë¼ì´íŠ¸ ê³µí†µ ë°˜íˆ¬ëª… ë°°ê²½ */
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  text-align:center;
}
.tile-label{
  font-size:13px;
  color:var(--mut);
}
.v{
  font-size:26px;
  font-weight:700;
  text-align:center;
}

/* êµ¬ë¶„ì„  */
hr{
  border:0;
  border-top:1px solid var(--line);  /* í…Œë§ˆì— ë§ëŠ” ê·¸ë ˆì´ ë¼ì¸ */
  margin:12px 0;
}

/* LED ë²„íŠ¼ ì˜ì—­ */
.led{display:flex;align-items:center;gap:8px;margin:10px 0}
.btn{border-radius:99px;border:1px solid var(--btn-border);background:var(--btn-bg);color:var(--txt);padding:6px 14px;font-size:14px;cursor:pointer}
.btn:hover{filter:brightness(1.1)}
.btn.on{border-color:#22c55e}
.btn.off{border-color:#f97373}

/* í† ê¸€/í…Œì´ë¸”/ê·¸ë˜í”„ */
.toggle-row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.btn.toggle{font-size:13px;padding:6px 10px}
.collapsible{max-height:0;overflow:hidden;transition:max-height .25s ease,opacity .25s ease;opacity:0}
.collapsible.open{max-height:600px;opacity:1}
.tablewrap{margin-top:6px;overflow:auto;border-radius:10px;border:1px solid var(--line)}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:5px 8px;border-bottom:1px solid #111827;text-align:right;white-space:nowrap}
th:first-child,td:first-child{text-align:left}
thead{background:rgba(15,23,42,.9)}
tbody tr:nth-child(even){background:rgba(15,23,42,.9)}
tbody tr:nth-child(odd){background:rgba(15,23,42,.8)}

/* â–¶ ë¼ì´íŠ¸ ëª¨ë“œì—ì„œ í…Œì´ë¸” ë°ê²Œ ë³´ì´ë„ë¡ ì˜¤ë²„ë¼ì´ë“œ */
.light thead{
  background:#e5e9f2;
}
.light tbody tr:nth-child(even){
  background:#f3f4f7;
}
.light tbody tr:nth-child(odd){
  background:#ffffff;
}
.light th,
.light td{
  border-bottom:1px solid #d1d5db;
}

/* ê·¸ë˜í”„ ì˜ì—­ */
.charts{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
.chart{border-radius:10px;border:1px solid var(--line);padding:8px 8px 10px;background:rgba(0,0,0,.18)}
.chart h3{margin:0 0 4px;font-size:14px}
.legend{display:flex;flex-wrap:wrap;gap:6px;font-size:11px;color:var(--mut);margin-bottom:4px}
.legend .item{display:inline-flex;align-items:center;gap:4px}
.legend .swatch{display:inline-block;width:10px;height:10px;border-radius:999px}
.legend .swatch.blue{background:#60a5fa}
.legend .swatch.orange{background:#fb923c}
.canvas-wrap{width:100%;height:120px;border-radius:8px;border:1px solid var(--line);background:#020617;overflow:hidden}
canvas{width:100%;height:100%;display:block}

/* í•˜ë‹¨ RSSI í‘œì‹œ */
.bottomRow{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;color:var(--mut);margin-top:10px}
#rssiText{font-size:12px;margin:0}
.timeText{font-size:12px;white-space:nowrap;margin:0 2px 0 0}

/* ì˜ˆì „ #foot ìˆ¨ê¹€ */
#foot{display:none;}
</style>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ <span class="theme-toggle" id="themeToggle">ğŸŒ™</span></h1>
  <p class="mut">AHT25(ì˜¨/ìŠµ) + SCD42(ì˜¨/ìŠµ/COâ‚‚) Â· LEDì œì–´</p>

  <!-- MQTT ìƒíƒœ ë¸”ë¡ -->
  <div class="status-block">
    <p id="mqttLine">MQTT: ì—°ê²° ëŒ€ê¸° ì¤‘...</p>
    <p>ë¸Œë¡œì»¤: broker.hivemq.com</p>
    <p>Web: WSS 8884 / ESP32: 1883</p>
    <p id="devState">ì¥ë¹„ ìƒíƒœ: <span id="devStateVal" class="state-offline">ì˜¤í”„ë¼ì¸</span></p>
  </div>

  <!-- ìƒë‹¨ ì„¼ì„œ + LED ìƒíƒœ íƒ€ì¼ (6ê°œ) -->
  <div class="grid">
    <div class="tile">
      <div class="tile-label">AHT25 ì˜¨ë„</div>
      <div id="aht_t" class="v">--.- Â°C</div>
    </div>
    <div class="tile">
      <div class="tile-label">AHT25 ìŠµë„</div>
      <div id="aht_h" class="v">-- %</div>
    </div>
    <div class="tile">
      <div class="tile-label">SCD42 ì˜¨ë„</div>
      <div id="scd_t" class="v">--.- Â°C</div>
    </div>
    <div class="tile">
      <div class="tile-label">SCD42 ìŠµë„</div>
      <div id="scd_h" class="v">-- %</div>
    </div>
    <div class="tile">
      <div class="tile-label">COâ‚‚ ê³µê¸°</div>
      <div id="scd_c" class="v">---- ppm</div>
    </div>
    <div class="tile">
      <div class="tile-label">LED ìƒíƒœ</div>
      <div id="ledTile" class="v">--</div>
    </div>
  </div>

  <!-- LED êµ¬ë¶„ì„  + ë²„íŠ¼ -->
  <hr>
  <div class="led">
    <button id="on"  class="btn on">LED ON</button>
    <button id="off" class="btn off">LED OFF</button>
  </div>

  <hr>
  <div class="toggle-row">
    <button class="btn toggle" id="toggleTable">ğŸ“‹ í…Œì´ë¸” ë³´ê¸°</button>
    <button class="btn toggle" id="toggleGraph">ğŸ“Š ê·¸ë˜í”„ ë³´ê¸°</button>
  </div>

  <div id="tableSection" class="collapsible">
    <div class="tablewrap">
      <table>
        <thead>
          <tr>
            <th>ì‹œê°„</th><th>AHT&nbsp;Â°C</th><th>AHT&nbsp;%</th>
            <th>SCD&nbsp;Â°C</th><th>SCD&nbsp;%</th><th>COâ‚‚</th><th>LED</th>
          </tr>
        </thead>
        <tbody id="logtbl"></tbody>
      </table>
    </div>
  </div>

  <div id="graphSection" class="collapsible">
    <div class="charts">
      <div class="chart">
        <h3>ì˜¨ë„ (Â°C) â€” ìµœê·¼ 60ë¶„</h3>
        <div class="legend">
          <span class="item"><i class="swatch blue"></i>AHT25 ì˜¨ë„</span>
          <span class="item"><i class="swatch orange"></i>SCD42 ì˜¨ë„</span>
        </div>
        <div class="canvas-wrap"><canvas id="chTemp"></canvas></div>
      </div>

      <div class="chart">
        <h3>ìŠµë„ (%) â€” ìµœê·¼ 60ë¶„</h3>
        <div class="legend">
          <span class="item"><i class="swatch blue"></i>AHT25 ìŠµë„</span>
          <span class="item"><i class="swatch orange"></i>SCD42 ìŠµë„</span>
        </div>
        <div class="canvas-wrap"><canvas id="chHum"></canvas></div>
      </div>

      <div class="chart">
        <h3>COâ‚‚ (ppm) â€” ìµœê·¼ 60ë¶„</h3>
        <div class="legend">
          <span class="item"><i class="swatch blue"></i>SCD42 COâ‚‚</span>
        </div>
        <div class="canvas-wrap"><canvas id="chCO2"></canvas></div>
      </div>
    </div>
  </div>

  <!-- RSSI ê°’ + ì‹œê°„ë§Œ -->
  <div class="bottomRow">
    <p id="rssiText">RSSI: -- [dBm]</p>
    <p class="timeText" id="ts">--:--:--</p>
  </div>

</div></div>

<script>
const $=s=>document.querySelector(s);

/* ===== í…Œë§ˆ ===== */
const themeToggle=$('#themeToggle');
function applyTheme(t){
  document.documentElement.classList.toggle('light',t==='light');
  themeToggle.textContent=(t==='light')?'â˜€ï¸':'ğŸŒ™';
  renderAllCharts();
}
applyTheme(localStorage.getItem('theme')||'dark');
themeToggle.onclick=()=>{
  const t=document.documentElement.classList.contains('light')?'dark':'light';
  applyTheme(t); localStorage.setItem('theme',t);
};

/* ===== MQTT ê¸°ë³¸ ===== */
const MQTT_BROKER_URL = "wss://6c56aefe0ddb4d57977c735f5070abe8.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_OPTIONS = {
  clean: true,
  connectTimeout: 4000,
  reconnectPeriod: 5000,
  username: "mqtt_ESP32",
  password: "gomqtt_ESP32"
};
const STATUS_TOPIC = "esp32wr/status";
const LED_TOPIC    = "esp32wr/led";

let mqttClient = null;
let lastDeviceMsgAt = 0;
const mqttLine = $('#mqttLine');
const devStateValEl = $('#devStateVal');
function setMqttText(t){ if(mqttLine) mqttLine.textContent = t; }
function setDevState(isOnline){
  if(!devStateValEl) return;
  devStateValEl.textContent = isOnline ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸';
  devStateValEl.classList.toggle('state-online', isOnline);
  devStateValEl.classList.toggle('state-offline', !isOnline);
}

/* ===== ESP32 HTTP ë² ì´ìŠ¤ ìë™ ë°œê²¬ (historyìš©) ===== */
const LS_LAST_STATUS='esp32_last_status', LS_BASE='base';
let BASE=(localStorage.getItem(LS_BASE)||'').replace(/\/$/,'');
const LS_TABLE='esp32wr_table';
let tableHistory = [];
function saveTableHistory(){
  try{
    localStorage.setItem(LS_TABLE, JSON.stringify(tableHistory));
  }catch(_){}
}
const CANDS=[]; if(BASE) CANDS.push(BASE); CANDS.push('http://esp32.local','http://192.168.31.204');

async function tryStatus(b){
  try{
    const r=await fetch(b+'/api/status',{cache:'no-store'});
    return r.ok;
  }catch(_){return false;}
}
async function discoverBase(){
  for(const b of CANDS){
    if(await tryStatus(b)){BASE=b;localStorage.setItem(LS_BASE,b);return true}
  }
  return false;
}

/* ===== ì—”ë“œí¬ì¸íŠ¸ (history ì „ìš© + HTTP LED fallback) ===== */
const EP={
  history60: ['/api/history?limit=60','/history?limit=60','/api/history','/history','/logs'],
  ledOn    : ['/api/led?state=on','/led/on','/api/led/on','/set?led=1'],
  ledOff   : ['/api/led?state=off','/led/off','/api/led/off','/set?led=0']
};
async function fetchFirstJson(paths,opt={}){
  for(const p of paths){
    const u=(/^(?:https?:)?\/\//.test(p)?p:(BASE+p));
    try{
      const r=await fetch(u,{...opt,cache:'no-store'});
      if(!r.ok) continue;
      return await r.json();
    }catch(_){}
  }
  throw new Error('ëª¨ë“  ê²½ë¡œ ì‹¤íŒ¨');
}

/* ===== ìœ í‹¸ ===== */
function toBool(v){return v===true||v===1||v==='1'||v==='true'||v==='on'||v==='ON';}
function fmtNow(){
  const d=new Date();
  const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');
  const h=String(d.getHours()).padStart(2,'0'),mi=String(d.getMinutes()).padStart(2,'0'),s=String(d.getSeconds()).padStart(2,'0');
  return `${y}-${m}-${da} ${h}:${mi}:${s}`;
}

/* ===== ìƒíƒœ ë¼ì¸ íŒŒì„œ (ë¬¸ìì—´ í”„ë¡œí† ì½œìš©) ===== */
function parseStatusLineToObj(line){
  const o={};
  const ahtMatch=line.match(/AHT25:([\-0-9.]+)C\s+([0-9.]+)%/);
  const scdMatch=line.match(/SCD42:([\-0-9.]+)C\s+([0-9.]+)%/);
  const co2Match=line.match(/CO2:([0-9.]+)ppm/);
  const ledMatch=line.match(/LED:(ON|OFF)/i);
  const rssiMatch=line.match(/RSSI:([\-0-9]+)/);
  if(ahtMatch){ o.aht_t=parseFloat(ahtMatch[1]); o.aht_h=parseFloat(ahtMatch[2]); }
  if(scdMatch){ o.scd_t=parseFloat(scdMatch[1]); o.scd_h=parseFloat(scdMatch[2]); }
  if(co2Match){ o.co2  =parseFloat(co2Match[1]); }
  if(ledMatch){ o.led  = ledMatch[1].toUpperCase()==='ON'; }
  if(rssiMatch){o.rssi = parseInt(rssiMatch[1],10);}
  return o;
}

/* ===== ìºì‹œ ìš°ì„  ì ìš© ===== */
(function(){
  const raw=localStorage.getItem(LS_LAST_STATUS);
  if(!raw) return;
  try{applyStatus(JSON.parse(raw),true);}catch(_){}
})();

/* ===== LED ë²„íŠ¼ ë™ê¸°í™” ===== */
function syncButtons(on){
  const bon=$('#on'), boff=$('#off');
  bon.classList.remove('active','dim'); boff.classList.remove('active','dim');
  if(on){ bon.classList.add('active'); boff.classList.add('dim'); }
  else  { boff.classList.add('active'); bon.classList.add('dim'); }
}

/* ===== ìƒíƒœ ì ìš© ===== */
function applyStatus(s,fromCache=false){
  const aT=Number(s.aht_t), aH=Number(s.aht_h),
        sT=Number(s.scd_t), sH=Number(s.scd_h),
        co=Number(s.co2);
  const led = toBool(s.led);

  if(!Number.isNaN(aT)) $('#aht_t').textContent=aT.toFixed(1)+' Â°C';
  if(!Number.isNaN(aH)) $('#aht_h').textContent=Math.round(aH)+' %';
  if(!Number.isNaN(sT)) $('#scd_t').textContent=sT.toFixed(1)+' Â°C';
  if(!Number.isNaN(sH)) $('#scd_h').textContent=Math.round(sH)+' %';
  if(!Number.isNaN(co)&&co>0) $('#scd_c').textContent=co+' ppm';

  const ledTile=$('#ledTile');
  if(ledTile) ledTile.textContent=led?'ON':'OFF';

  if(typeof s.rssi!=='undefined'){
    $('#rssiText').textContent = `RSSI: ${s.rssi} [dBm]`;
  }

  syncButtons(led);

  if(!fromCache){
    const cacheObj={
      aht_t:aT,aht_h:aH,
      scd_t:sT,scd_h:sH,
      co2:co,
      led:led,
      rssi:s.rssi
    };
    localStorage.setItem(LS_LAST_STATUS,JSON.stringify(cacheObj));
  }
}

/* ===== í† ê¸€ ì„¹ì…˜ ===== */
const secTable=$('#tableSection');
const secGraph=$('#graphSection');
$('#toggleTable').onclick=()=>{
  const open=secTable.classList.toggle('open');
  $('#toggleTable').textContent=open?'ğŸ“‹ í…Œì´ë¸” ìˆ¨ê¸°ê¸°':'ğŸ“‹ í…Œì´ë¸” ë³´ê¸°';
};
$('#toggleGraph').onclick=()=>{
  const open=secGraph.classList.toggle('open');
  $('#toggleGraph').textContent=open?'ğŸ“Š ê·¸ë˜í”„ ìˆ¨ê¸°ê¸°':'ğŸ“Š ê·¸ë˜í”„ ë³´ê¸°';
  if(open) renderAllCharts();
};

/* ===== ë¸Œë¼ìš°ì € ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ í…Œì´ë¸”/ê·¸ë˜í”„ ë³µì› ===== */
let histBuf=[];

function restoreHistoryFromLS(){
  try{
    const raw = localStorage.getItem(LS_TABLE);
    if(!raw) return;
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr) || !arr.length) return;
    const tb = $('#logtbl');
    if(!tb) return;
    tb.innerHTML='';
    tableHistory = arr;
    histBuf = [];
    for(const rec of tableHistory.slice().reverse()){
      const d = rec.ts ? new Date(rec.ts) : new Date();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${hh}:${mm}</td>
        <td>${Number(rec.aht_t).toFixed(1)}</td>
        <td>${Math.round(Number(rec.aht_h))}</td>
        <td>${Number(rec.scd_t).toFixed(1)}</td>
        <td>${Math.round(Number(rec.scd_h))}</td>
        <td>${Math.round(Number(rec.co2))}</td>
        <td>${rec.led?'ON':'OFF'}</td>`;
      if(tb.firstChild) tb.insertBefore(tr,tb.firstChild); else tb.appendChild(tr);
      histBuf.push({
        aht_t:Number(rec.aht_t),
        aht_h:Number(rec.aht_h),
        scd_t:Number(rec.scd_t),
        scd_h:Number(rec.scd_h),
        co2:Number(rec.co2)
      });
    }
    if(histBuf.length>60){
      histBuf = histBuf.slice(-60);
      tableHistory = tableHistory.slice(0,60);
      saveTableHistory();
    }
    renderAllCharts();
  }catch(_){}
}

/* ===== í…Œì´ë¸”: ê³¼ê±° 60ë¶„ ë¡œë“œ ===== */
async function loadHistory60(){
  if(!BASE) return;
  try{
    const list=await fetchFirstJson(EP.history60);
    $('#logtbl').innerHTML='';
    const now=Date.now();
    histBuf = [];
    tableHistory = [];
    for(const it of list){
      const ts=it.timestamp?new Date(it.timestamp):
               new Date(now-(it.age||0)*60000);
      const row = {
        aht_t:+(it.aht_t??it.aht_temp??it.temp),
        aht_h:+(it.aht_h??it.aht_hum??it.hum),
        scd_t:+(it.scd_t??it.scd_temp??it.st),
        scd_h:+(it.scd_h??it.scd_hum??it.sh),
        co2  :+(it.co2??it.scd_co2??it.ppm),
        led  :toBool(it.led)
      };
      addRowTop(row,ts);
      histBuf.push({
        aht_t: row.aht_t, aht_h: row.aht_h,
        scd_t: row.scd_t, scd_h: row.scd_h, co2: row.co2
      });
      tableHistory.unshift({
        ts: ts.toISOString(),
        aht_t: row.aht_t,
        aht_h: row.aht_h,
        scd_t: row.scd_t,
        scd_h: row.scd_h,
        co2:  row.co2,
        led:  row.led
      });
    }
    if(histBuf.length>60){
      histBuf = histBuf.slice(-60);
    }
    if(tableHistory.length>60){
      tableHistory = tableHistory.slice(0,60);
    }
    saveTableHistory();
    renderAllCharts();
  }catch(_){}
}
function addRowTop(o,ts){
  const tb=$('#logtbl');
  const d=ts?new Date(ts):new Date();
  const hh=String(d.getHours()).padStart(2,'0');
  const mm=String(d.getMinutes()).padStart(2,'0');
  const tr=document.createElement('tr');
  tr.innerHTML=`<td>${hh}:${mm}</td>
    <td>${Number(o.aht_t).toFixed(1)}</td>
    <td>${Math.round(Number(o.aht_h))}</td>
    <td>${Number(o.scd_t).toFixed(1)}</td>
    <td>${Math.round(Number(o.scd_h))}</td>
    <td>${Math.round(Number(o.co2))}</td>
    <td>${toBool(o.led)?'ON':'OFF'}</td>`;
  if(tb.firstChild) tb.insertBefore(tr,tb.firstChild); else tb.appendChild(tr);
  while(tb.rows.length>60) tb.deleteRow(tb.rows.length-1);
}

/* ===== ì°¨íŠ¸ + Yì¶• ëˆˆê¸ˆ ===== */
const dpr=()=>window.devicePixelRatio||1;
function prepCanvas(c){
  const r=c.getBoundingClientRect();
  const w=r.width,h=r.height;
  const dprv=dpr();
  if(c.width!==w*dprv||c.height!==h*dprv){
    c.width=w*dprv;c.height=h*dprv;
  }
  const ctx=c.getContext('2d');
  ctx.setTransform(dprv,0,0,dprv,0,0);
  return ctx;
}

function drawChart(c,series){
  const ctx=prepCanvas(c); const W=c.clientWidth,H=c.clientHeight;
  const padL=42,padR=10,padT=10,padB=26,plotW=W-padL-padR,plotH=H-padT-padB;
  const light=document.documentElement.classList.contains('light');

  let vmin=Infinity,vmax=-Infinity;
  for(const arr of series){
    for(const v of arr){
      if(!Number.isFinite(v)) continue;
      if(v<vmin) vmin=v;
      if(v>vmax) vmax=v;
    }
  }
  if(!Number.isFinite(vmin)||!Number.isFinite(vmax)||vmin===vmax){
    vmin=0; vmax=1;
  }else{
    const span=vmax-vmin;
    vmin-=span*0.1; vmax+=span*0.1;
  }

  ctx.clearRect(0,0,W,H);
  ctx.fillStyle=light?'#eef1f7':'#020617';ctx.fillRect(0,0,W,H);

  ctx.strokeStyle=light?'#ccd4e0':'#22314f';
  ctx.beginPath();
  for(let g=0;g<=4;g++){
    const y=padT+plotH*g/4;
    ctx.moveTo(padL,y);ctx.lineTo(padL+plotW,y);
  }
  for(let m=0;m<=60;m+=10){
    const x=padL+plotW*(m/60);
    ctx.moveTo(x,padT);ctx.lineTo(x,padT+plotH);
  }
  ctx.stroke();

  // Xì¶• ë¼ë²¨
  ctx.fillStyle=light?'#5a6b8a':'#9fb2d7';
  ctx.font='11px system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='top';
  for(let m=0;m<=60;m+=10){
    const x=padL+plotW*(m/60);
    ctx.fillText((60-m)==0?'ì§€ê¸ˆ':`-${60-m}m`,x,padT+plotH+6);
  }

  // Yì¶• ë¼ë²¨
  ctx.textAlign='right'; ctx.textBaseline='middle';
  const span=vmax-vmin;
  const step=span/4;
  for(let g=0;g<=4;g++){
    const y=padT+plotH*g/4;
    const val=vmax-step*g;
    const txt=(Math.abs(val)<1?val.toFixed(2):val.toFixed(1));
    ctx.fillText(txt, padL-6, y);
  }

  const xAt=i=>padL+plotW*(i/59), yAt=v=>padT+((vmax-v)/(vmax-vmin))*plotH;
  const colors=['#7aa0ff','#fb923c'];
  series.forEach((arr,idx)=>{
    ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle=colors[idx%colors.length];
    let moved=false; const N=arr.length;
    for(let i=0;i<60;i++){
      const j=i-(60-N); const v=(j>=0&&j<N)?arr[j]:NaN; const x=xAt(i);
      if(Number.isFinite(v)){
        const y=yAt(v);
        if(!moved){ctx.moveTo(x,y); moved=true;} else ctx.lineTo(x,y);
      }else{
        moved=false;
      }
    }
    ctx.stroke();
  });
}

function renderAllCharts(){
  if(!$('#graphSection').classList.contains('open')) return;
  const aht_t=histBuf.map(r=>r.aht_t??NaN), scd_t=histBuf.map(r=>r.scd_t??NaN),
        aht_h=histBuf.map(r=>r.aht_h??NaN), scd_h=histBuf.map(r=>r.scd_h??NaN),
        co2  =histBuf.map(r=>r.co2??NaN);
  drawChart(document.getElementById('chTemp'),[aht_t,scd_t]);
  drawChart(document.getElementById('chHum'), [aht_h,scd_h]);
  drawChart(document.getElementById('chCO2'), [co2]);
}

/* ===== 1ë¶„ í‰ê·  ë²„í¼ (MQTT ìˆ˜ì‹ ê¸°ë°˜) ===== */
let minuteKey=null;
let minuteSamples=[];

function pushMinuteSample(s, now){
  const key = now.getHours()*60 + now.getMinutes();
  if(minuteKey!==null && key!==minuteKey && minuteSamples.length){
    const ts = new Date(now.getFullYear(), now.getMonth(), now.getDate(),
                        Math.floor(minuteKey/60), minuteKey%60, 0, 0);
    const avg = k=>{
      const vals = minuteSamples.map(x=>+x[k]).filter(Number.isFinite);
      if(!vals.length) return NaN;
      return vals.reduce((a,b)=>a+b,0)/vals.length;
    };
    const row = {
      aht_t: avg('aht_t'),
      aht_h: avg('aht_h'),
      scd_t: avg('scd_t'),
      scd_h: avg('scd_h'),
      co2  : avg('co2'),
      led  : minuteSamples[minuteSamples.length-1].led
    };
    addRowTop(row, ts);
    histBuf.push({
      aht_t: row.aht_t, aht_h: row.aht_h,
      scd_t: row.scd_t, scd_h: row.scd_h, co2: row.co2
    });
    if(histBuf.length>60) histBuf.shift();
    tableHistory.unshift({
      ts: ts.toISOString(),
      aht_t: row.aht_t,
      aht_h: row.aht_h,
      scd_t: row.scd_t,
      scd_h: row.scd_h,
      co2:  row.co2,
      led:  row.led
    });
    if(tableHistory.length>60){
      tableHistory = tableHistory.slice(0,60);
    }
    saveTableHistory();
    renderAllCharts();
    minuteSamples = [];
  }
  minuteKey = key;
  minuteSamples.push({
    aht_t:+s.aht_t, aht_h:+s.aht_h,
    scd_t:+s.scd_t, scd_h:+s.scd_h,
    co2  :+s.co2,   led: toBool(s.led)
  });
}

/* ===== LED ì œì–´ ===== */
function publishLed(cmd){
  if(mqttClient && mqttClient.connected){
    mqttClient.publish(LED_TOPIC, cmd, {qos:0, retain:false});
  }else if(BASE){
    const path = cmd==="ON" ? EP.ledOn[0] : EP.ledOff[0];
    fetch(BASE+path,{cache:'no-store'}).catch(()=>{});
  }
}

$('#on').onclick  = ()=> publishLed("ON");
$('#off').onclick = ()=> publishLed("OFF");

/* ===== ì´ˆê¸° ë¶€íŒ… ===== */
(async()=>{
  restoreHistoryFromLS();
  if(!BASE || !(await tryStatus(BASE))) await discoverBase();
  if(BASE) await loadHistory60();
  setInterval(()=>{ $('#ts').textContent=fmtNow(); },1000);

  mqttClient = mqtt.connect(MQTT_BROKER_URL, MQTT_OPTIONS);

  mqttClient.on('connect', ()=>{
    setMqttText('MQTT ì—°ê²° OK');
    mqttClient.subscribe(STATUS_TOPIC, err=>{
      if(err) setMqttText('MQTT êµ¬ë… ì‹¤íŒ¨');
    });
  });
  mqttClient.on('reconnect', ()=> setMqttText('MQTT ì¬ì—°ê²° ì¤‘...'));
  mqttClient.on('error', ()=> setMqttText('MQTT ì—ëŸ¬'));
  mqttClient.on('close', ()=>{
    setMqttText('MQTT ì—°ê²° ëŠê¹€');
    setDevState(false);
  });

  mqttClient.on('message',(topic,payload)=>{
    if(topic!==STATUS_TOPIC) return;
    const text = new TextDecoder().decode(payload);
    const trimmed = text.trim();
    lastDeviceMsgAt = Date.now();
    setDevState(true);

    let st = null;
    if(trimmed.startsWith('{')){
      try{ st = JSON.parse(trimmed); }catch(e){ return; }
    }else{
      st = parseStatusLineToObj(trimmed);
    }
    if(!st) return;
    applyStatus(st,false);
    pushMinuteSample(st, new Date());
  });

  setInterval(()=>{
    if(!lastDeviceMsgAt){
      setDevState(false);
      return;
    }
    const diff = Date.now()-lastDeviceMsgAt;
    if(diff>20000){
      setDevState(false);
    }else{
      setDevState(true);
    }
  },5000);
})();
</script>
</body>
</html>
