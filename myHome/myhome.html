<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#1f7cc6"/>
  <title>My Smart Home</title>

  <!-- PWA -->
  <link rel="manifest" href="./icons/manifest.json">
  <link rel="icon" href="./icons/favicon.ico">
  <link rel="apple-touch-icon" href="./icons/icon-180x180.png">

  <style>
    :root{ --blue1:#1f7cc6; --blue2:#2a8bd6; --bg:#eef3f7; --card:#fff; --shadow: 0 10px 30px rgba(0,0,0,.08); }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    body{margin:0;background:var(--bg);color:#123;}
    header{background:linear-gradient(180deg,var(--blue2),var(--blue1));color:#fff;padding:18px 16px 14px;}
    .toprow{display:flex;align-items:center;justify-content:space-between;gap:10px}
    h1{margin:0;font-size:22px;font-weight:800;letter-spacing:.2px}
    .subtitle{margin-top:6px;font-size:13px;opacity:.9}
    .iconbtn{width:38px;height:38px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;color:#fff}
    .iconbtn:active{transform:scale(.98)}
    .wrap{max-width:520px;margin:0 auto;padding:14px 14px 26px}
    .status{margin-top:10px;background:#3aa557;border-radius:10px;padding:10px 12px;color:#fff;display:flex;justify-content:space-between;align-items:center;gap:10px;box-shadow:var(--shadow)}
    .status.bad{background:#d9343f}
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.95);display:inline-block;margin-right:8px}
    .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:10px;margin-top:12px}
    .device{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px}
    .device + .device{border-top:1px solid #e7eef6;border-radius:0}
    .left{display:flex;align-items:center;gap:10px;min-width:0}
    .ico{width:34px;height:34px;border-radius:10px;background:#eaf3ff;display:flex;align-items:center;justify-content:center;flex:0 0 auto}
    .name{font-weight:800;font-size:16px;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .key{font-size:12px;color:#678;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{display:flex;flex-direction:column;min-width:0}
    .right{display:flex;align-items:center;gap:10px}
    .pill{font-size:11px;padding:4px 8px;border-radius:999px;background:#f1f5fb;color:#345;border:1px solid #e0e8f3}
    .pill.pending{background:#fff4d6;border-color:#ffe7a3;color:#6a4b00}
    /* toggle */
    .sw{position:relative;display:inline-block;width:54px;height:28px}
    .sw input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#cfd9e6;transition:.15s;border-radius:999px}
    .slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;top:3px;background:white;transition:.15s;border-radius:999px;box-shadow:0 2px 7px rgba(0,0,0,.2)}
    input:checked + .slider{background:#1f7cc6}
    input:checked + .slider:before{transform:translateX(26px)}
    input:disabled + .slider{opacity:.55;cursor:not-allowed}
    .actions{display:flex;gap:10px;margin-top:12px}
    .btn{flex:1;display:flex;align-items:center;justify-content:center;gap:10px;height:44px;border-radius:12px;border:1px solid #d9e6f6;background:#fff;box-shadow:var(--shadow);font-weight:800}
    .btn:active{transform:scale(.99)}
    .small{margin-top:10px;color:#567;font-size:12px}
    /* log drawer */
    .bugbtn{position:fixed;right:14px;bottom:14px;width:52px;height:52px;border-radius:18px;border:none;background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.18);display:flex;align-items:center;justify-content:center}
    .drawer{position:fixed;left:0;right:0;bottom:-70vh;height:70vh;background:#0e1624;color:#d5e3ff;border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:0 -12px 40px rgba(0,0,0,.35);transition:.25s;padding:12px 12px 10px}
    .drawer.open{bottom:0}
    .drawerhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .drawerhead .title{font-weight:900}
    .drawerhead button{border:none;background:rgba(255,255,255,.12);color:#fff;border-radius:10px;padding:8px 10px}
    pre{margin:0;white-space:pre-wrap;word-break:break-word;font-size:12px;line-height:1.4;max-height:calc(70vh - 60px);overflow:auto}
  </style>

  <!-- mqtt.js (works on GitHub Pages) -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>

<body>
<header>
  <div class="toprow">
    <div>
      <h1>My Smart Home</h1>
      <div class="subtitle">Connected Devices</div>
    </div>
    <div style="display:flex;gap:10px">
      <button id="btnBugTop" class="iconbtn" title="Logs" aria-label="Logs">
        <!-- bug icon -->
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M9 9h6v10a3 3 0 0 1-6 0V9Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
          <path d="M10 7a2 2 0 0 1 4 0v2h-4V7Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
          <path d="M6 13H4m16 0h-2M7 8 5 6m12 2 2-2M7 18l-2 2m12-2 2 2" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <button id="btnRefresh" class="iconbtn" title="Refresh" aria-label="Refresh">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M20 12a8 8 0 1 1-2.34-5.66" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M20 4v6h-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</header>

<div class="wrap">
  <div id="status" class="status">
    <div><span class="dot"></span><span id="statusText">Connecting...</span></div>
    <div id="statusRight" style="font-size:12px;opacity:.95">‚Äî</div>
  </div>

  <div id="devicesCard" class="card" style="padding:10px">
    <div class="device" style="border-top:none">
      <div class="left">
        <div class="ico">‚ÑπÔ∏è</div>
        <div class="meta">
          <div class="name">Waiting ESP32...</div>
          <div class="key">ESP32 announce ÏàòÏã† ÌõÑ ÏûêÎèô Ïó∞Í≤∞</div>
        </div>
      </div>
      <div class="right">
        <label class="sw">
          <input type="checkbox" disabled>
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </div>

  <div class="actions">
    <button class="btn" id="btnLogout">
      <span style="font-size:18px">‚èª</span> Logout
    </button>
  </div>
  <div class="small" id="smallInfo">Auto refresh: <span id="pollMs">1500</span>ms</div>
</div>

<button class="bugbtn" id="btnBug" title="Logs" aria-label="Logs">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
    <path d="M9 9h6v10a3 3 0 0 1-6 0V9Z" stroke="#1f7cc6" stroke-width="2" stroke-linejoin="round"/>
    <path d="M10 7a2 2 0 0 1 4 0v2h-4V7Z" stroke="#1f7cc6" stroke-width="2" stroke-linejoin="round"/>
    <path d="M6 13H4m16 0h-2M7 8 5 6m12 2 2-2M7 18l-2 2m12-2 2 2" stroke="#1f7cc6" stroke-width="2" stroke-linecap="round"/>
  </svg>
</button>

<div class="drawer" id="drawer">
  <div class="drawerhead">
    <div class="title">Logs</div>
    <div style="display:flex;gap:8px">
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </div>
  <pre id="log"></pre>
</div>

<script>
(() => {
  // ====== CONFIG (public broker) ======
  const TOPIC_ROOT = "pspiceman/myhome";
  const WSS_URL = "wss://broker.hivemq.com:8884/mqtt"; // GitHub Pages -> WSS only

  // ====== UI helpers ======
  const $ = (id)=>document.getElementById(id);
  const logEl = $("log");
  const drawer = $("drawer");
  function log(tag, obj){
    const ts = new Date().toLocaleTimeString();
    let line = `[${ts}] ${tag}`;
    if(obj !== undefined){
      try{ line += "\n" + (typeof obj === "string" ? obj : JSON.stringify(obj, null, 2)); }
      catch(e){ line += "\n" + String(obj); }
    }
    logEl.textContent = (line + "\n\n") + logEl.textContent;
  }
  function setStatus(ok, text, right){
    const st = $("status");
    st.classList.toggle("bad", !ok);
    $("statusText").textContent = text;
    $("statusRight").textContent = right || "‚Äî";
  }

  // drawer
  function toggleDrawer(on){ drawer.classList.toggle("open", !!on); }
  $("btnBug").onclick = ()=>toggleDrawer(true);
  $("btnBugTop").onclick = ()=>toggleDrawer(true);
  $("btnClose").onclick = ()=>toggleDrawer(false);
  $("btnCopy").onclick = async () => {
    try{ await navigator.clipboard.writeText(logEl.textContent); log("copied"); }
    catch(e){ log("copy failed", String(e)); }
  };

  // ====== state ======
  let client = null;
  let nodeId = null;
  let devices = []; // [{key,name,state,pending,online}]

  function iconFor(key){
    const map = { myDesk:"ü™õ", floor:"üî•", tablet:"üì±", server:"üñ•Ô∏è", water:"üö∞" };
    return map[key] || "üîå";
  }

  function renderDevices(){
    const card = $("devicesCard");
    card.innerHTML = "";
    if(!devices.length){
      card.innerHTML = `
        <div class="device" style="border-top:none">
          <div class="left">
            <div class="ico">‚ÑπÔ∏è</div>
            <div class="meta">
              <div class="name">Waiting ESP32...</div>
              <div class="key">ESP32 announce ÏàòÏã† ÌõÑ ÏûêÎèô Ïó∞Í≤∞</div>
            </div>
          </div>
          <div class="right">
            <label class="sw"><input type="checkbox" disabled><span class="slider"></span></label>
          </div>
        </div>`;
      return;
    }

    devices.forEach(d=>{
      const row = document.createElement("div");
      row.className = "device";
      row.innerHTML = `
        <div class="left">
          <div class="ico">${iconFor(d.key)}</div>
          <div class="meta">
            <div class="name">${d.name || d.key}</div>
            <div class="key">${d.key}</div>
          </div>
        </div>
        <div class="right">
          ${d.pending ? `<span class="pill pending">pending</span>` : ``}
          ${d.online === false ? `<span class="pill">offline</span>` : ``}
          <label class="sw">
            <input type="checkbox" ${d.state ? "checked":""} ${d.pending ? "disabled":""} data-key="${d.key}">
            <span class="slider"></span>
          </label>
        </div>
      `;
      card.appendChild(row);
    });

    // attach handlers
    card.querySelectorAll('input[type="checkbox"][data-key]').forEach(inp=>{
      inp.onchange = (e)=>{
        const key = inp.getAttribute("data-key");
        const on = inp.checked;
        log(`(ui) toggle ${key}`, {next:on});
        // optimistic UI
        const idx = devices.findIndex(x=>x.key===key);
        if(idx>=0){ devices[idx].pending = true; renderDevices(); }

        if(!client || !nodeId){
          log("mqtt not ready");
          return;
        }
        const payload = JSON.stringify({key, on, t: Date.now()});
        client.publish(`${TOPIC_ROOT}/${nodeId}/cmd/set`, payload, {qos:1}, (err)=>{
          if(err) log("publish err", String(err));
        });
      };
    });
  }

  function onDevicesMessage(payload){
    try{
      const obj = JSON.parse(payload);
      if(Array.isArray(obj.devices)) devices = obj.devices;
      else if(Array.isArray(obj)) devices = obj;
      renderDevices();
      setStatus(true, "Connected", nodeId ? `node=${nodeId}` : "‚Äî");
      log("devices", {count: devices.length});
    }catch(e){
      log("devices parse err", String(e));
    }
  }

  function subscribeNode(n){
    nodeId = n;
    log("use node", {node: nodeId});
    setStatus(true, "Connected", `node=${nodeId}`);
    // subscribe retained snapshot + logs
    client.subscribe(`${TOPIC_ROOT}/${nodeId}/devices`, {qos:0});
    client.subscribe(`${TOPIC_ROOT}/${nodeId}/log`, {qos:0});
    // ask snapshot (in case retained isn't delivered on some clients)
    client.publish(`${TOPIC_ROOT}/${nodeId}/cmd/get`, JSON.stringify({t:Date.now()}), {qos:0});
  }

  // ====== MQTT connect ======
  function connectMQTT(){
    setStatus(false, "Connecting...", "‚Äî");
    log("mqtt connect", {url: WSS_URL, root: TOPIC_ROOT});

    client = mqtt.connect(WSS_URL, {
      keepalive: 20,
      reconnectPeriod: 1200,
      connectTimeout: 9000,
      clean: true
    });

    client.on("connect", ()=>{
      log("mqtt connected");
      setStatus(true, "Connected", "waiting node");
      devices = [];
      renderDevices();
      nodeId = null;

      // subscribe announce channel
      client.subscribe(`${TOPIC_ROOT}/announce`, {qos:0});
    });

    client.on("reconnect", ()=>log("mqtt reconnect"));
    client.on("close", ()=>log("mqtt close"));
    client.on("offline", ()=>{ log("mqtt offline"); setStatus(false, "Connect Failed", "offline"); });
    client.on("error", (e)=>{ log("mqtt error", String(e)); setStatus(false, "Connect Failed", "error"); });

    client.on("message", (topic, payloadBuf)=>{
      const payload = payloadBuf.toString();
      if(topic === `${TOPIC_ROOT}/announce`){
        try{
          const a = JSON.parse(payload);
          const n = a.node || a.id || a.client || a.mac;
          if(!n) return;
          log("subscribed node", {node:n});
          subscribeNode(n);
        }catch(e){ log("announce parse err", payload); }
        return;
      }
      if(nodeId && topic === `${TOPIC_ROOT}/${nodeId}/devices`){
        onDevicesMessage(payload);
        return;
      }
      if(nodeId && topic === `${TOPIC_ROOT}/${nodeId}/log`){
        try{ log("(esp)", JSON.parse(payload)); }catch(e){ log("(esp)", payload); }
      }
    });
  }

  // actions
  $("btnRefresh").onclick = ()=>{
    if(client && nodeId){
      client.publish(`${TOPIC_ROOT}/${nodeId}/cmd/get`, JSON.stringify({t:Date.now(), reason:"refresh"}));
      log("refresh");
    }else{
      log("refresh (no node)");
    }
  };
  $("btnLogout").onclick = ()=>{
    if(client){ client.end(true); client = null; }
    nodeId = null;
    devices = [];
    renderDevices();
    setStatus(false, "Disconnected", "logout");
    log("logout");
    connectMQTT();
  };

  // boot
  renderDevices();
  connectMQTT();
})();
</script>
</body>
</html>
