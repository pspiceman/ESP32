<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>투약 시간 기록 (공용/동기화)</title>
  <style>
    :root{ color-scheme: light dark; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; padding:16px; }
    .wrap{ max-width:920px; margin:0 auto; }
    h1{ margin:0 0 8px; font-size:20px; }
    .muted{ opacity:.75; font-size:12px; line-height:1.4; }
    .card{ margin:12px 0; padding:14px; border:1px solid rgba(128,128,128,.35); border-radius:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    label{ display:grid; gap:6px; font-size:12px; opacity:.85; }
    input, select, button{ font:inherit; padding:10px 12px; border-radius:12px; border:1px solid rgba(128,128,128,.35); background:transparent; min-height:44px; }
    button{ cursor:pointer; }
    .right{ margin-left:auto; display:flex; gap:8px; flex-wrap:wrap; }
    .pill{ display:inline-block; padding:6px 10px; border:1px solid rgba(128,128,128,.35); border-radius:999px; font-size:12px; }
    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th,td{ border-bottom:1px solid rgba(128,128,128,.25); padding:8px; text-align:left; font-size:13px; }
    td.actions{ white-space:nowrap; width:1%; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>투약 시간 기록 (공용/동기화)</h1>
  <div class="muted">
    저장 위치: Google Sheets (모든 기기에서 동일).<br/>
    ※ 웹앱 URL + API_KEY로 스프레드시트에 기록합니다.
  </div>

  <div class="card">
    <div class="row">
      <label>날짜<input type="date" id="dateInput"></label>
      <label>투약 시간<input type="time" id="timeInput" step="60"></label>
      <label style="min-width:220px;">메모(선택)<input type="text" id="noteInput" maxlength="120" placeholder="예: 아침 식후"></label>

      <div class="right">
        <button id="saveBtn">저장</button>
        <button id="clearBtn">해당 날짜 삭제</button>
      </div>
    </div>
    <div style="margin-top:10px;">
      <span class="pill" id="statusPill">상태: 대기</span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <label>보기 기준
        <select id="viewMode">
          <option value="month">월별 보기</option>
          <option value="all">전체 보기</option>
        </select>
      </label>
      <label id="monthLabel">월
        <input type="month" id="monthInput">
      </label>
      <div class="right">
        <button id="refreshBtn">새로고침</button>
        <button id="wipeBtn" style="color:#ff3b30;">전체 초기화</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="muted">기록 개수: <b id="countSpan">0</b></div>
    <table>
      <thead><tr><th>날짜</th><th>시간</th><th>메모</th><th class="actions">작업</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- POST 전송용(숨김) -->
<iframe name="hiddenFrame" style="display:none;"></iframe>
<form id="postForm" method="post" target="hiddenFrame" style="display:none;"></form>

<script>
/*** ✅ 이미 URL 넣어둠 / API_KEY만 네 값으로 바꾸기 ***/
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzuTgN4qhXuvhSWSXvV1mFiG3P7hExZm2f83n5HyM1s5DGtDmjd3pN7hzI2SrhsOzAOTw/exec";
const API_KEY = "CHANGE_ME_TO_LONG_KEY"; // <-- Apps Script의 API_KEY와 동일하게!
/*******************************************************/

const dateInput = document.getElementById("dateInput");
const timeInput = document.getElementById("timeInput");
const noteInput = document.getElementById("noteInput");
const saveBtn = document.getElementById("saveBtn");
const clearBtn = document.getElementById("clearBtn");
const refreshBtn = document.getElementById("refreshBtn");
const wipeBtn = document.getElementById("wipeBtn");

const viewMode = document.getElementById("viewMode");
const monthInput = document.getElementById("monthInput");
const monthLabel = document.getElementById("monthLabel");

const statusPill = document.getElementById("statusPill");
const countSpan = document.getElementById("countSpan");
const tbody = document.getElementById("tbody");

const postForm = document.getElementById("postForm");

function setStatus(msg){ statusPill.textContent = "상태: " + msg; }

function todayISO(){
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
function monthISO(){
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function validateDate(dateStr){
  if(!dateStr) return "날짜를 선택하세요.";
  const year = Number(dateStr.slice(0,4));
  if(!Number.isFinite(year)) return "날짜 형식 오류";
  if(year < 2026) return "2026년부터 기록 가능";
  return "";
}

// JSONP 로드(CORS 우회)
function jsonp(url){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    window[cb] = (data) => { cleanup(); resolve(data); };
    const s = document.createElement("script");
    s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
    s.onerror = () => { cleanup(); reject(new Error("JSONP load error")); };
    document.head.appendChild(s);
    function cleanup(){
      try{ delete window[cb]; }catch(_){ window[cb] = undefined; }
      s.remove();
    }
  });
}

async function loadList(){
  setStatus("불러오는 중...");
  const mode = viewMode.value;
  const month = monthInput.value;

  const base = `${WEB_APP_URL}?action=${encodeURIComponent(mode === "all" ? "all" : "list")}&key=${encodeURIComponent(API_KEY)}`;
  const url = (mode === "all") ? base : (base + `&month=${encodeURIComponent(month)}`);

  try{
    const res = await jsonp(url);
    if(!res || !res.ok) throw new Error(res?.error || "load failed");
    renderRows(res.rows || []);
    setStatus("완료");
  }catch(e){
    console.error(e);
    setStatus("불러오기 실패(웹앱 URL/KEY 확인)");
  }
}

function renderRows(rows){
  countSpan.textContent = String(rows.length);
  tbody.innerHTML = "";
  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.date||"")}</td>
      <td>${escapeHtml(r.time||"")}</td>
      <td>${escapeHtml(r.note||"")}</td>
      <td class="actions">
        <button data-act="load">불러오기</button>
        <button data-act="del" data-date="${escapeAttr(r.date||"")}">삭제</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeAttr(s){ return String(s).replace(/"/g, "&quot;"); }

// POST는 form+iframe(CORS 영향 없음)
function postAction(fields){
  return new Promise((resolve) => {
    postForm.innerHTML = "";
    postForm.action = WEB_APP_URL;

    const all = { ...fields, key: API_KEY };
    for (const [k,v] of Object.entries(all)) {
      const inp = document.createElement("input");
      inp.name = k;
      inp.value = String(v ?? "");
      postForm.appendChild(inp);
    }
    postForm.submit();
    setTimeout(resolve, 600);
  });
}

async function save(){
  const date = dateInput.value;
  const time = timeInput.value;
  const note = (noteInput.value || "").trim();

  const msg = validateDate(date);
  if(msg) return setStatus(msg);
  if(!time) return setStatus("투약 시간을 입력하세요.");

  setStatus("저장 중...");
  await postAction({ action:"upsert", date, time, note });
  await loadList();
}

async function delDate(date){
  const msg = validateDate(date);
  if(msg) return setStatus(msg);

  setStatus("삭제 중...");
  await postAction({ action:"delete", date });
  await loadList();
}

async function wipeAll(){
  if(!confirm("정말로 전체 초기화할까요?")) return;
  setStatus("초기화 중...");
  await postAction({ action:"wipe" });
  await loadList();
}

tbody.addEventListener("click", async (e) => {
  const btn = e.target.closest("button");
  if(!btn) return;
  const act = btn.dataset.act;

  if(act === "load"){
    const tr = btn.closest("tr");
    dateInput.value = tr.children[0].textContent.trim();
    timeInput.value = tr.children[1].textContent.trim();
    noteInput.value = tr.children[2].textContent.trim();
    setStatus("불러옴");
  } else if(act === "del"){
    await delDate(btn.dataset.date);
  }
});

saveBtn.addEventListener("click", save);
clearBtn.addEventListener("click", () => delDate(dateInput.value));
refreshBtn.addEventListener("click", loadList);
wipeBtn.addEventListener("click", wipeAll);

viewMode.addEventListener("change", () => {
  monthLabel.style.display = (viewMode.value === "month") ? "" : "none";
  loadList();
});
monthInput.addEventListener("change", loadList);

// init
dateInput.value = todayISO();
monthInput.value = monthISO();
monthLabel.style.display = "";
setStatus("준비 완료");
loadList();
</script>
</body>
</html>
