<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Universal RMC</title>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b0f14">
  <meta name="background-color" content="#0b0f14">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Universal RMC">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root { --pad: 12px; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif; background:#0b0f14; color:#e6eef8;}
    header{ position:sticky; top:0; z-index:10; background:rgba(11,15,20,.92); backdrop-filter: blur(8px); padding: var(--pad); border-bottom:1px solid rgba(255,255,255,.08);}
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .pill{ padding:6px 10px; border-radius:999px; font-size:12px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.10);}
    .ok{ background:rgba(52,211,153,.15); border-color:rgba(52,211,153,.35);}
    .bad{ background:rgba(248,113,113,.15); border-color:rgba(248,113,113,.35);}
    main{ padding: var(--pad); display:grid; gap:12px;}
    section{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); border-radius:18px; padding:12px;}
    h2{ margin:0 0 10px; font-size:14px; opacity:.9; display:flex; justify-content:space-between; align-items:center; gap:10px;}
    .grid{ display:grid; grid-template-columns: repeat(3,1fr); gap:10px;}
    button{ width:100%; padding:14px 10px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.08); color:#fff; font-size:14px; font-weight:600;}
    button:active{ transform: translateY(1px); }
    .wide{ grid-column: span 3; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    input{ width:100%; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.24); background:rgba(0,0,0,.25); color:#fff; font-size:14px;}
    .log{ max-height:170px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; line-height:1.35; padding:10px; background:rgba(0,0,0,.30); border-radius:12px; border:1px solid rgba(255,255,255,.10);}
    .muted{ opacity:.75; font-size:12px;}
    button{ box-shadow: 0 6px 14px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.12); }

    .logbtn-left{
      width:54px; padding:10px 0; text-align:center;
      border:1px solid rgba(255,255,255,.24);
      box-shadow: 0 14px 26px rgba(0,0,0,.70),
                  inset 0 1px 0 rgba(255,255,255,.12), inset 0 -6px 14px rgba(0,0,0,.40);
    }
    .logbtn-right{ width:110px; padding:10px 0; text-align:center; font-size:13px; letter-spacing:.3px; }

    /* Pressed feedback */
    .btn:active, .logbtn:active{
      transform: translateY(3px) scale(0.985);
      filter: brightness(0.90);
    }
    .pressed{
      transform: translateY(3px) scale(0.985);
      filter: brightness(0.90);
      box-shadow: inset 0 6px 14px rgba(0,0,0,.45) !important;
    }

    /* Universal RMC depth up */
    .pill{
      box-shadow: 0 10px 22px rgba(0,0,0,.65), inset 0 1px 0 rgba(255,255,255,.18), inset 0 -4px 10px rgba(0,0,0,.35);
    }

    /* Status pills (OK like attach) */
    .pill{
      padding:8px 14px;
      border-radius:999px;
      font-weight:800;
      letter-spacing:.2px;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 22px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.10);
    }
    .pill.ok, .pill.good{
      background: linear-gradient(180deg,#1f262f,#151a21);
      border:1px solid rgba(34,197,94,.85); /* green outline */
      box-shadow: 0 0 0 1px rgba(34,197,94,.35),
                  0 0 18px rgba(34,197,94,.22),
                  0 12px 26px rgba(0,0,0,.65),
                  inset 0 1px 0 rgba(255,255,255,.14), inset 0 -6px 14px rgba(0,0,0,.40);
      color:#eafff1;
      text-shadow: 0 1px 0 rgba(0,0,0,.55);
    }
    .pill.bad{
      background: linear-gradient(180deg,#2a313b,#1a2028);
      color:#e6eef8;
      border:1px solid rgba(255,255,255,.10);
    }

    /* Remote vs button separation + 3D */
    .section{
      background: linear-gradient(180deg,#0c1016,#070a0f);
      border: 2px solid rgba(255,255,255,.32);
      box-shadow: 0 26px 52px rgba(0,0,0,.80), inset 0 1px 0 rgba(255,255,255,.05);
    }
    .btn{
      background: linear-gradient(180deg,#465566,#2f3a48);
      border:1px solid rgba(255,255,255,.32);
      box-shadow: 0 22px 44px rgba(0,0,0,.85), 0 8px 18px rgba(0,0,0,.60),
                  inset 0 1px 0 rgba(255,255,255,.24), inset 0 -10px 18px rgba(0,0,0,.38);
      color:#f2f7ff;
    }
    .btn.ok{
      background: linear-gradient(180deg,#465566,#2f3a48);
      border:1px solid rgba(255,255,255,.32);
      box-shadow: 0 22px 44px rgba(0,0,0,.85), 0 8px 18px rgba(0,0,0,.60),
                  inset 0 1px 0 rgba(255,255,255,.24), inset 0 -10px 18px rgba(0,0,0,.38);
      color:#f2f7ff;
    }

    .logbtn{
      border:1px solid rgba(255,255,255,.24);
      background: linear-gradient(180deg,#1f262f,#151a21);
      box-shadow: 0 14px 26px rgba(0,0,0,.70), inset 0 1px 0 rgba(255,255,255,.12), inset 0 -6px 14px rgba(0,0,0,.40);
    }
    .logbtn-left{
      width:54px; padding:10px 0; text-align:center;
      border:1px solid rgba(255,255,255,.24);
      box-shadow: 0 14px 26px rgba(0,0,0,.70),
                  inset 0 1px 0 rgba(255,255,255,.12), inset 0 -6px 14px rgba(0,0,0,.40);
    }

    /* Status row compact (prevent RSSI wrap) */
    .status-row{
      display:flex;
      flex-wrap:nowrap;
      gap:8px;
      overflow:hidden;
    }
    .status-row .pill{
      padding:6px 10px;
      font-size:13px;
      white-space:nowrap;
      flex:0 0 auto;
    }
    #st-rssi{
      border:1px solid rgba(59,130,246,.85);
      box-shadow: 0 0 0 1px rgba(59,130,246,.30),
                  0 0 16px rgba(59,130,246,.18),
                  0 10px 22px rgba(0,0,0,.60),
                  inset 0 1px 0 rgba(255,255,255,.14), inset 0 -6px 14px rgba(0,0,0,.40);
    }

    /* Section tint (clearer separation among 3 remotes) */
    section:nth-of-type(1){
      background: linear-gradient(180deg, rgba(59,130,246,.18), rgba(59,130,246,.10));
    }
    section:nth-of-type(2){
      background: linear-gradient(180deg, rgba(34,197,94,.18), rgba(34,197,94,.10));
    }
    section:nth-of-type(3){
      background: linear-gradient(180deg, rgba(168,85,247,.18), rgba(168,85,247,.10));
    }
    /* Log/Reset section (neutral) */
    section:nth-of-type(4){
      background: rgba(255,255,255,.07);
    }

    /* ===================== Schedule button ===================== */
    .clock-btn{
      width:32px;
      height:32px;
      padding:0;
      border:none;
      background:transparent;
      box-shadow:none;
      border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      line-height:1;
      font-size:16px;
      color:#e6eef8;
      flex:0 0 auto;
      -webkit-tap-highlight-color: transparent;
    }
    .clock-btn:active{ transform: translateY(1px); filter: brightness(0.95); }

    /* ===================== Schedule modal (match screenshot, keep mobile time picker) ===================== */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(560px, 96vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(31,38,47,.92), rgba(21,26,33,.92));
      box-shadow: 0 26px 52px rgba(0,0,0,.75), inset 0 1px 0 rgba(255,255,255,.10);
      padding:16px;
    }
    .sched-title{
      font-size:16px;
      font-weight:800;
      margin:0 0 12px;
    }
    .sched-row{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .sched-label{
      width:52px;
      font-weight:800;
      opacity:.9;
    }

    /* placeholder overlay so --:-- always shows when empty */
    .time-wrap{ position:relative; flex:1; }
    .time-wrap input[type="time"]{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.24);
      background:rgba(0,0,0,.25);
      color:#fff;
      font-size:14px;
    }
    .time-ph{
      position:absolute;
      left:14px;
      top:50%;
      transform:translateY(-50%);
      font-size:14px;
      opacity:.55;
      pointer-events:none;
      user-select:none;
      white-space:nowrap;
    }

    .sched-actions{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .sched-actions button{
      padding:14px 10px;
      border-radius:14px;
    }
    .sched-actions .ghost{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.16);
    }
    .sched-help{
      margin-top:10px;
      font-size:12px;
      opacity:.75;
      line-height:1.5;
    }
    .sched-help .link{
      display:inline-block;
      margin-top:6px;
      opacity:.9;
      text-decoration: underline;
      cursor:pointer;
    }

    /* ===== UI tweaks requested ===== */
    section{ padding:10px 12px 12px; } /* title area smaller */
    h2{ margin:0 0 8px; font-size:15px; font-weight:800; opacity:.95; gap:8px; line-height:1.1; }
  </style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between">
    <div style="font-weight:800; letter-spacing:.2px; font-size:22px;">Universal RMC</div>
    <div class="pill" id="clock">--:--</div>
  </div>
  <div class="row status-row" style="margin-top:10px">
    <div class="pill bad" id="st-mqtt">MQTT: --</div>
    <div class="pill bad" id="st-gw">Gateway: --</div>
    <div class="pill bad" id="st-ble">BLE: --</div>
    <div class="pill" id="st-rssi">RSSI: --</div>
  </div>
</header>

<main>
<section>
    <h2>
      <span>MiBox RMC</span>
      <button class="clock-btn" onclick="openSchedule('mibox','MiBox (MUTE)')" aria-label="MiBox schedule">üïí</button>
    </h2>

    <div class="grid">
      <button onclick="sendMi('up')" class="wide">‚ñ≤</button>
      <button onclick="sendMi('left')">‚óÄ</button>
      <button onclick="sendMi('ok1')">OK</button>
      <button onclick="sendMi('right')">‚ñ∂</button>
      <button onclick="sendMi('down')" class="wide">‚ñº</button>

      <button onclick="sendMi('voldown')">VOL-</button>
      <button onclick="sendMi('mute')">MUTE</button>
      <button onclick="sendMi('volup')">VOL+</button>
    </div>

    <div style="height:10px"></div>
    <div class="grid2">
      <button onclick="sendMi('MB:2000')">‚üµ BACK</button>
      <button onclick="sendMi('MB:0080')">HOME</button>
    </div>

</section>

<section>
    <h2>
      <span>433 RMC</span>
      <button class="clock-btn" onclick="openSchedule('rf433','433 (LIGHT)')" aria-label="433 schedule">üïí</button>
    </h2>

    <div class="grid2">
      <button onclick="send433('LIGHT')">LIGHT</button>
      <button onclick="send433('DOOR')">DOOR</button>
      <button onclick="send433('SPK1')">SPK1</button>
      <button onclick="send433('SPK2')">SPK2</button>
    </div>
</section>

<section>
    <h2>
      <span>IR RMC</span>
      <button class="clock-btn" onclick="openSchedule('ir','IR (POWER1)')" aria-label="IR schedule">üïí</button>
    </h2>

    <div class="grid">
      <button onclick="sendIR('POWER1')" class="wide">POWER1</button>
    </div>
    <div class="grid2" style="margin-top:10px">
      <button onclick="sendIR('VOL-1')">VOL-</button>
      <button onclick="sendIR('VOL+1')">VOL+</button>
    </div>

    <div style="height:10px"></div>

    <div class="grid">
      <button onclick="sendIR('POWER2')" class="wide">POWER2</button>
    </div>
    <div class="grid2" style="margin-top:10px">
      <button onclick="sendIR('VOL-2')">VOL-</button>
      <button onclick="sendIR('VOL+2')">VOL+</button>
    </div>

</section>

<section>
    <h2 style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <button id="toggleLog" class="logbtn logbtn-left" onclick="toggleLog()">ü™≤</button>
      <button class="logbtn logbtn-right" onclick="sendReset()">RESET</button>
    </h2>
    <div class="log" id="log" style="display:none"></div>
</section>
</main>

<!-- ===================== Schedule Modal (UPDATED) ===================== -->
<div class="modal-backdrop" id="schedBackdrop" onclick="closeSchedule(true)">
  <div class="modal" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
    <div class="sched-title" id="schedTitle">Ïä§ÏºÄÏ§Ñ ÏÑ§Ï†ï</div>

    <div class="sched-row">
      <div class="sched-label">ÏãúÏûë</div>
      <div class="time-wrap">
        <span class="time-ph" id="schedStartPh">--:--</span>
        <input id="schedStart" type="time"
               oninput="phSync()"
               onchange="phSync()"/>
      </div>
    </div>

    <div class="sched-row">
      <div class="sched-label">Ï¢ÖÎ£å</div>
      <div class="time-wrap">
        <span class="time-ph" id="schedEndPh">--:--</span>
        <input id="schedEnd" type="time"
               oninput="phSync()"
               onchange="phSync()"/>
      </div>
    </div>

    <div class="sched-actions">
      <button class="ghost" onclick="closeSchedule(false)">Îã´Í∏∞</button>
      <button onclick="saveSchedule()">Ï†ÄÏû•</button>
    </div>

    <div class="sched-help">
      ‚Ä¢ ESP32Í∞Ä NTP ÏãúÍ∞Ñ Í∏∞Ï§ÄÏúºÎ°ú Îß§Ïùº Î∞òÎ≥µ Ïã§ÌñâÌï©ÎãàÎã§. (ÏõπÏùÄ ÏÑ§Ï†ïÌï† ÎïåÎßå ÌïÑÏöî)<br/>
      ‚Ä¢ Ï¢ÖÎ£åÏãúÍ∞ÑÏùÑ ÎπÑÏö∞Î©¥ ÏãúÏûëÎßå 1Ìöå Ïã§ÌñâÎê©ÎãàÎã§.<br/>
      ‚Ä¢ IRÏùÄ HTMLÏùò IR_TOKENÍ≥º ESP32Ïùò AUTH_TOKENÏù¥ Í∞ôÏïÑÏïº Ìï©ÎãàÎã§.<br/>
      <span class="link" onclick="clearSchedule()">Ïä§ÏºÄÏ§Ñ ÏßÄÏö∞Í∏∞</span>
    </div>
  </div>
</div>

<script>
  // Topics (ESP32 firmwareÏôÄ ÎèôÏùº)
  // IR auth token (ESP32 AUTH_TOKENÍ≥º ÎèôÏùº)
  const IR_TOKEN = "YOUR_TOKEN";

  const TOPIC = {
    miboxCmd: "tswell/mibox3/cmd",
    miboxStatus: "tswell/mibox3/status",
    irCmd: "tswell/ir/cmd",
    irStatus: "tswell/ir/status",
    r433Cmd: "tswell/433home/cmd",
    r433Status: "tswell/433home/status",
    r433Log: "tswell/433home/log",

    // ESP32 Ïä§ÏºÄÏ§Ñ ÏÑ§Ï†ï ÌÜ†ÌîΩ (BÏïà)
    scheduleSet: "tswell/schedule/set",
  };

  let client = null;
  let gw = { wifi:null, mqtt:null, rssi:null };
  let gwLastTs = 0; // ms timestamp of last 433 status update (gateway heartbeat)
  const GW_STALE_MS = 7000; // 7s without 433 status => gateway offline

  let ble = null;
  let bleLastTs = 0; // ms timestamp of last BLE status update
  const BLE_STALE_MS = 6000; // stable: 6s timeout
  let bleOffStart = 0; // UI-side OFF debounce start (ms)
  const BLE_UI_OFF_CONFIRM_MS = 4000; // require 4s continuous OFF before showing OFF
  let mqttOk = false;

  // Schedule state
  let schedTarget = null;


  // ===== Schedule UI persistence (per remote) =====
  // NOTE: ESP32 is the real scheduler. This is UI-side memory so the user can see what they set.
  const SCHED_UI_KEY = "tswell_sched_ui_v1";

  function schedLoadAll(){
    try{ return JSON.parse(localStorage.getItem(SCHED_UI_KEY) || "{}"); }catch(e){ return {}; }
  }
  function schedSaveAll(map){
    try{ localStorage.setItem(SCHED_UI_KEY, JSON.stringify(map || {})); }catch(e){}
  }
  function schedGet(target){
    const m = schedLoadAll();
    return m[target] || null;
  }
  function schedSet(target, start, end){
    const m = schedLoadAll();
    m[target] = { start: start || "", end: end || "" };
    schedSaveAll(m);
  }
  function schedDel(target){
    const m = schedLoadAll();
    delete m[target];
    schedSaveAll(m);
  }

  // placeholder visibility helper (for our overlay)
  function phSync(){
    const s = document.getElementById('schedStart');
    const e = document.getElementById('schedEnd');
    const sPh = document.getElementById('schedStartPh');
    const ePh = document.getElementById('schedEndPh');
    if(s && sPh) sPh.style.display = s.value ? 'none' : 'block';
    if(e && ePh) ePh.style.display = e.value ? 'none' : 'block';
  }


  const $ = (id)=>document.getElementById(id);
  const logEl = $("log");
  const stMqtt = $("st-mqtt");
  const stGw = $("st-gw");
  const stBle = $("st-ble");
  const stRssi = $("st-rssi");

  function toggleLog(){
    const el = $("log");
    const showing = el.style.display !== "none";
    el.style.display = showing ? "none" : "block";
  }

  function addLog(line){
    const ts = new Date().toLocaleTimeString();
    logEl.innerText = `[${ts}] ${line}\n` + logEl.innerText;
  }

  function setPill(el, ok, text){
    el.classList.remove("ok","bad");
    el.classList.add(ok ? "ok":"bad");
    el.innerText = text;
  }

  function connect(){
    const url = "wss://broker.hivemq.com:8884/mqtt";
    const cid = "web_" + Math.random().toString(16).slice(2);
    client = mqtt.connect(url, {
      clientId: cid,
      clean: true,
      reconnectPeriod: 1500,
      keepalive: 30,
    });

    client.on("connect", ()=>{ mqttOk = true;
      setPill(stMqtt, true, "MQTT: OK");
      addLog("MQTT connected");
      client.subscribe(Object.values(TOPIC), { qos:0 }, (err)=>{
        if(err) addLog("SUB ERR: " + err.message);
        else addLog("Subscribed topics");
      });
    });

    client.on("reconnect", ()=>{
      mqttOk = false;
      setPill(stMqtt, false, "MQTT: --");
      // MQTTÍ∞Ä ÌùîÎì§Î¶¥ Îïå Gateway/BLEÎäî ÌåêÏ†ï Î≥¥Î•ò
      gwLastTs = 0;
      setPill(stGw, false, "Gateway: --");
      stRssi.innerText = "RSSI: --";
      bleLastTs = 0;
      setPill(stBle, false, "BLE: --");
    });

    client.on("close", ()=>{
      mqttOk = false;
      setPill(stMqtt, false, "MQTT: --");
      gwLastTs = 0;
      setPill(stGw, false, "Gateway: --");
      stRssi.innerText = "RSSI: --";
      bleLastTs = 0;
      setPill(stBle, false, "BLE: --");
    });
    client.on("error", (e)=> addLog("MQTT ERR: " + e.message));

    client.on("message", (topic, payload)=>{
      const msg = payload.toString();
      if(topic === TOPIC.r433Status){
        try{
          const j = JSON.parse(msg);
          gw = j;
          gwLastTs = Date.now();
          const ok = (j.wifi===1 && j.mqtt===1);
          setPill(stGw, ok, "Gateway: " + (ok ? "OK":"BAD"));
          stRssi.innerText = "RSSI: " + (j.rssi ?? "--");
        }catch(e){}
      }
      if(topic === TOPIC.miboxStatus){
        try{
          const j = JSON.parse(msg);
          const now = Date.now();

          // If LWT/offline marker arrives (ts==0), don't flicker OFF immediately.
          // Reset freshness and show unknown; stale checker will turn it to OFF if no heartbeat follows.
          if(j.ts === 0){
            // LWT/offline marker can arrive briefly during reconnect.
            // If we recently had a fresh heartbeat, ignore this marker to prevent flicker.
            if(bleLastTs && (now - bleLastTs) <= BLE_STALE_MS){
              return;
            }
            ble = false;
            bleLastTs = 0;
            bleOffStart = 0;
            setPill(stBle, false, "BLE: --");
            return;
          }

          // Ignore stale retained snapshots (prevents OFF/OK flicker on first load)
          if(j.ts && j.ts > 1700000000){
            const age = now - (j.ts*1000);
            if(age > BLE_STALE_MS){
              return;
            }
          }

          const cand = !!j.ble;
          bleLastTs = now; // use receive-time

          if(cand){
            // ON: clear OFF debounce and reflect immediately
            bleOffStart = 0;
            ble = true;
            setPill(stBle, true, "BLE: OK");
          }else{
            // OFF: debounce so brief BLE hiccups don't flip the UI
            if(!bleOffStart) bleOffStart = now;
            const offLongEnough = (now - bleOffStart) >= BLE_UI_OFF_CONFIRM_MS;
            if(offLongEnough){
              ble = false;
              setPill(stBle, false, "BLE: OFF");
            }else{
              // keep previous OK during the debounce window
              ble = true;
              setPill(stBle, true, "BLE: OK");
            }
          }
        }catch(e){}
      }
      if(topic === TOPIC.r433Log){
        addLog(msg);
      }
      if(topic === TOPIC.irStatus){
        addLog("IR: " + msg);
      }
    });
  }

  function pub(topic, msg){
    if(!client || !client.connected){
      addLog("Not connected");
      return;
    }
    client.publish(topic, msg, { qos:0, retain:false });
  }

  // --- Commands ---
  function sendReset(){
    send433('reset');
    addLog('RESET requested');
  }

  function sendMi(cmd){
    if(!canBleControl()){
      addLog("BLE not connected -> blocked: " + cmd);
      setPill(stBle, false, "BLE: --");
      return;
    }
    pub(TOPIC.miboxCmd, cmd);
    addLog("MiBox cmd: " + cmd);
  }

  function sendIR(cmd){
    // ESP32Îäî JSON {token,cmd} ÌòïÌÉúÎ•º Í∏∞ÎåÄÌï®
    const payload = JSON.stringify({ token: IR_TOKEN, cmd });
    pub(TOPIC.irCmd, payload);
    addLog("IR cmd: " + cmd);
  }

  function send433(cmd){ pub(TOPIC.r433Cmd, cmd); addLog("433 cmd: " + cmd); }

  // Gateway/BLE stale checker
  setInterval(()=>{
    // MQTT ÎÅäÍπÄÏù¥Î©¥ Ï†ÑÎ∂Ä ÌåêÏ†ï Î≥¥Î•ò
    if(!mqttOk){
      gwLastTs = 0;
      setPill(stGw, false, "Gateway: --");
      stRssi.innerText = "RSSI: --";

      ble = false;
      bleLastTs = 0;
      setPill(stBle, false, "BLE: --");
      return;
    }

    // Gateway(433 status) freshness
    if(!gwLastTs){
      setPill(stGw, false, "Gateway: --");
      stRssi.innerText = "RSSI: --";
    }else{
      const gwStale = (Date.now() - gwLastTs) > GW_STALE_MS;
      if(gwStale){
        gwLastTs = 0;
        setPill(stGw, false, "Gateway: --");
        stRssi.innerText = "RSSI: --";
        // Gateway Ïò§ÌîÑÎùºÏù∏Ïù¥Î©¥ BLEÎèÑ -- Î°ú
        ble = false;
        bleLastTs = 0;
        setPill(stBle, false, "BLE: --");
        return;
      }
    }

    // BLE freshness (GatewayÍ∞Ä ÏÇ¥ÏïÑÏûàÏùÑ ÎïåÎßå ÏùòÎØ∏ ÏûàÏùå)
    if(!bleLastTs){
      setPill(stBle, false, "BLE: --");
      return;
    }

    const bleStale = (Date.now() - bleLastTs) > BLE_STALE_MS;
    if(bleStale){
      ble = false;
      bleLastTs = 0;
      setPill(stBle, false, "BLE: --");
    }
  }, 1000);

  function canBleControl(){
    const fresh = bleLastTs && (Date.now() - bleLastTs) <= BLE_STALE_MS;
    return mqttOk && !!ble && fresh;
  }

  // ===================== Schedule functions (BÏïà) =====================
  function openSchedule(target, title){
    schedTarget = target;
    $("schedTitle").innerText = `Ïä§ÏºÄÏ§Ñ ÏÑ§Ï†ï - ${title}`;

    // load saved UI values for this remote
    const saved = schedGet(target);
    $("schedStart").value = (saved && saved.start) ? saved.start : "";
    $("schedEnd").value = (saved && saved.end) ? saved.end : "";

    phSync();
    $("schedBackdrop").style.display = "flex";
  }

  function closeSchedule(){
    $("schedBackdrop").style.display = "none";
  }

  function saveSchedule(){
    if(!schedTarget){
      addLog("Schedule: target missing");
      closeSchedule();
      return;
    }
    const start = $("schedStart").value?.trim();
    const end = $("schedEnd").value?.trim();

    if(!start){
      addLog("Schedule: start time required");
      return;
    }

    // persist for UI display
    schedSet(schedTarget, start, end || "");

    const payloadObj = { target: schedTarget, start };
    if(end) payloadObj.end = end;

    const payload = JSON.stringify(payloadObj);
    pub(TOPIC.scheduleSet, payload);
    addLog(`Schedule set -> ${payload}`);

    phSync();
    closeSchedule();
  }

  function clearSchedule(){
    if(!schedTarget){
      addLog("Schedule clear: target missing");
      closeSchedule();
      return;
    }

    // clear UI memory
    schedDel(schedTarget);

    // reset inputs
    $("schedStart").value = "";
    $("schedEnd").value = "";
    phSync();

    const payload = JSON.stringify({ target: schedTarget, disable: true });
    pub(TOPIC.scheduleSet, payload);
    addLog(`Schedule cleared -> ${payload}`);
    closeSchedule();
  }

  // ESCÎ°ú Î™®Îã¨ Îã´Í∏∞
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      const b = $("schedBackdrop");
      if(b && b.style.display === "flex") closeSchedule();
    }
  });

  window.addEventListener('load', ()=>{ connect(); });

  // Clock
  setInterval(()=>{$("clock").innerText=new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});}, 1000);
</script>

<script>
  // Visual pressed feedback for touch/click
  function addPressedFeedback(){
    document.querySelectorAll('button').forEach(btn=>{
      const down = ()=>btn.classList.add('pressed');
      const up = ()=>btn.classList.remove('pressed');
      btn.addEventListener('mousedown', down);
      btn.addEventListener('touchstart', down, {passive:true});
      btn.addEventListener('mouseup', up);
      btn.addEventListener('mouseleave', up);
      btn.addEventListener('touchend', up);
      btn.addEventListener('touchcancel', up);
      // for programmatic clicks: briefly flash
      btn.addEventListener('click', ()=>{
        btn.classList.add('pressed');
        setTimeout(()=>btn.classList.remove('pressed'), 120);
      });
    });
  }
  window.addEventListener('DOMContentLoaded', addPressedFeedback);
</script>

<script>
  // PWA Service Worker registration (DISABLED for debug)
  // if you want it back, restore the original block.
</script>
</body>
</html>
