<!doctype html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
<title>MiBox3 Remote</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1f2430">

<link rel="stylesheet" as="style" crossorigin
  href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
  :root{
    --bgA:#2b2f3a; --bgB:#1f2430;
    --stroke:rgba(255,255,255,.10);
    --text:#f5f7ff; --sub:#c6cee6;
    --greenSoft:rgba(55,255,121,.14);
    --shadow: 0 14px 30px rgba(0,0,0,.35);
    --shadowSoft: 0 10px 22px rgba(0,0,0,.22);
  }
  *{box-sizing:border-box;}
  body{
    margin:0; padding:0;
    font-family:"Pretendard",-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,Roboto,"Noto Sans KR",sans-serif;
    background: radial-gradient(circle at top, var(--bgA) 0, var(--bgB) 60%, #151925 100%);
    color:var(--text);
    display:flex; justify-content:center;
    padding: 10px 0;
  }
  .frame{
    width:360px; max-width:100vw;
    padding:14px 12px 18px;
    border-radius:24px;
    border:1px solid rgba(255,255,255,.12);
    box-shadow: var(--shadow);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    overflow:hidden;
  }
  .topRow{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; margin: 4px 0 10px;
  }
  .title{
    font-size:22px;
    font-weight:900;
    letter-spacing:.02em;
    line-height:1.1;
  }
  .pill{
    height:34px; padding:0 12px; border-radius:999px;
    display:flex; align-items:center;
    font-size:12px; font-weight:800;
    border:1px solid rgba(148,163,184,0.35);
    background: rgba(255,255,255,.06);
    color: var(--sub);
    white-space:nowrap;
    user-select:none;
  }
  .pill.ok{
    border-color: rgba(55,255,121,0.55);
    background: var(--greenSoft);
    color: var(--text);
    box-shadow: 0 0 14px rgba(55,255,121,.25);
  }
  .dpad{
    margin-top: 16px;
    width: 340px;
    margin-left:auto;
    margin-right:auto;
    display:grid;
    grid-template-columns: 110px 110px 110px;
    grid-template-rows: 110px 110px 110px;
    gap: 10px;
    justify-items:center;
    align-items:center;
    transform: translateX(-8px);
  }
  .btn{
    width:110px; height:110px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(180deg,
      rgba(255,255,255,.16) 0%,
      rgba(255,255,255,.08) 35%,
      rgba(0,0,0,.12) 100%);
    box-shadow:
      0 18px 34px rgba(0,0,0,.28),
      inset 0 1px 0 rgba(255,255,255,.25),
      inset 0 -10px 20px rgba(0,0,0,.18);
    color:var(--text);
    font-size:26px;
    font-weight:900;
    cursor:pointer;
    user-select:none;
    transition: transform .12s, filter .15s;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
  .btn:active{ transform: translateY(3px) scale(.985); }
  .btn.sent{ filter: brightness(1.12); }
  .ok{
    background: linear-gradient(180deg, rgba(55,255,121,.32), rgba(0,0,0,.18));
    border-color: rgba(55,255,121,0.55);
  }
  .row2{
    margin-top: 14px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .wide{
    height: 64px;
    border-radius: 16px;
    font-size: 18px;
    width:100%;
  }
  .footer{
    margin-top:12px;
    display:flex;
    justify-content:flex-end;
    font-size:12px;
    color: var(--sub);
  }
</style>
</head>

<body>
<div class="frame">
  <div class="topRow">
    <div class="title">MiBox3 Remote</div>
    <div id="blePill" class="pill">BLE</div>
  </div>

  <div class="dpad">
    <div></div>
    <button class="btn" data-cmd="up">â–²</button>
    <div></div>

    <button class="btn" data-cmd="left">â—€</button>
    <button class="btn ok" data-cmd="ok1">OK</button>
    <button class="btn" data-cmd="right">â–¶</button>

    <div></div>
    <button class="btn" data-cmd="down">â–¼</button>
    <div></div>
  </div>

  <div class="row2">
    <button class="btn wide" data-cmd="back">âŸµ BACK</button>
    <button class="btn wide ok" data-cmd="home">HOME</button>
  </div>

  <div class="row2">
    <button class="btn wide" data-cmd="voldown">ðŸ”‰ VOL -</button>
    <button class="btn wide" data-cmd="volup">ðŸ”Š VOL +</button>
  </div>

  <div class="row2">
    <button class="btn wide" data-cmd="mute">ðŸ”‡ MUTE</button>
    <button class="btn wide" data-cmd="reset">â™» RESET</button>
  </div>

  <div class="footer">
    <div id="dt">--</div>
  </div>
</div>

<script>
/* MQTT */
const MQTT_URL  = "wss://broker.hivemq.com:8884/mqtt";
const TOPIC_CMD    = "tswell/mibox3/cmd";
const TOPIC_STATUS = "tswell/mibox3/status";

const blePill = document.getElementById("blePill");
const dtEl = document.getElementById("dt");

function now(){
  const d = new Date();
  const mo = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  return `${d.getFullYear()}-${mo}-${da} ${hh}:${mm}:${ss}`;
}
setInterval(()=>dtEl.textContent = now(), 1000);
dtEl.textContent = now();

let client = mqtt.connect(MQTT_URL, { reconnectPeriod: 3000 });

client.on("connect", ()=>{
  // âœ… status í† í”½ êµ¬ë…
  client.subscribe(TOPIC_STATUS);
});

client.on("message", (topic, payload)=>{
  if(topic === TOPIC_STATUS){
    try{
      const j = JSON.parse(payload.toString());
      if(j.ble === true){
        blePill.className = "pill ok";
        blePill.textContent = "BLE OK";
      }else{
        blePill.className = "pill";
        blePill.textContent = "BLE OFF";
      }
    }catch(e){
      // parse ì‹¤íŒ¨ì‹œ í‘œì‹œë§Œ OFF
      blePill.className = "pill";
      blePill.textContent = "BLE OFF";
    }
  }
});

function publish(cmd){
  if(!client || !client.connected) return false;
  client.publish(TOPIC_CMD, cmd);
  return true;
}

let lastCmd = "";
let lastTs = 0;
const DEBOUNCE_MS = 280;
const CLICK_MS = 420;

function sendCmd(btn, cmd, e){
  if(e){
    e.preventDefault();
    e.stopPropagation();
  }
  btn.blur();

  const nowTs = Date.now();
  if(cmd === lastCmd && (nowTs - lastTs) < DEBOUNCE_MS) return;
  lastCmd = cmd;
  lastTs = nowTs;

  btn.classList.add("sent");
  setTimeout(()=>btn.classList.remove("sent"), CLICK_MS);

  if(!publish(cmd)) alert("MQTT ì—°ê²°ì´ ì•„ì§ ì•ˆ ëìŠµë‹ˆë‹¤.");
}

document.querySelectorAll("button[data-cmd]").forEach(btn=>{
  const cmd = btn.getAttribute("data-cmd");
  btn.addEventListener("pointerdown", (e)=>sendCmd(btn, cmd, e), {passive:false});
  btn.addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); }, {passive:false});
});
</script>
</body>
</html>
