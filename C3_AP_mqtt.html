<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ESP32 MQTT Dashboard</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
  zoom: 1.05;
}
#logBox {
  white-space: pre-line;
  height: 180px;
  background: #000;
  color: #0f0;
  padding: 10px;
  overflow-y: auto;
  border: 1px solid #333;
  font-family: Consolas, monospace;
  font-size: 0.85rem;
}
.status-label {
  font-size: 1.3rem;
  font-weight: 600;
}
.status-value {
  font-size: 1.6rem;
  font-weight: 700;
}
.led-indicator {
  font-size: 1.8rem;
  font-weight: bold;
  padding: 5px 12px;
  border-radius: 8px;
}
</style>
</head>

<body class="bg-slate-900 text-slate-100">

<div class="max-w-xl mx-auto py-6 px-4">

  <h1 class="text-3xl font-bold mb-8 text-center">ESP32 MQTT Dashboard</h1>

  <!-- STATUS Box -->
  <div class="bg-slate-800 border border-slate-700 rounded-xl p-4 mb-6">
    <div class="mb-3">
      <span class="status-label">ğŸ“¶ SSID</span><br>
      <span id="ssid" class="status-value">--</span>
    </div>

    <div class="mb-3">
      <span class="status-label">ğŸ“¡ RSSI</span><br>
      <span id="rssi" class="status-value">--</span> dBm
    </div>

    <div class="mb-3">
      <span class="status-label">ğŸŒ IP</span><br>
      <span id="ip" class="status-value">--</span>
    </div>

    <div class="mt-4">
      <span class="status-label">ğŸ’¡ LED ìƒíƒœ</span><br>
      <span id="ledState" class="led-indicator bg-slate-700">--</span>
    </div>
  </div>

  <!-- BUTTONS (í•œ ì¤„ ë°°ì—´ / ëª¨ë°”ì¼ ìµœì í™”) -->
  <div class="grid grid-cols-3 gap-3 mb-6">

    <button onclick="sendLED(1)"
      class="bg-green-600 py-3 rounded-lg text-sm sm:text-lg font-bold">
      LED<br>ì¼œê¸°
    </button>

    <button onclick="sendLED(0)"
      class="bg-yellow-600 py-3 rounded-lg text-sm sm:text-lg font-bold">
      LED<br>ë„ê¸°
    </button>

    <button onclick="sendReset()"
      class="bg-red-600 py-3 rounded-lg text-sm sm:text-lg font-bold">
      Soft<br>Reset
    </button>

  </div>

  <!-- LOG BOX -->
  <div id="logBox">[LOG] Readyâ€¦</div>

</div>

<script>
/* ---------------------------------------------------
   MQTT Connect (HiveMQ Public Broker)
--------------------------------------------------- */
let brokerURL = "wss://broker.hivemq.com:8884/mqtt";
let clientId = "esp32_ui_" + Math.random().toString(16).substr(2, 8);
let client = mqtt.connect(brokerURL, { clientId });

function log(msg) {
  const box = document.getElementById("logBox");
  box.textContent += "\n" + msg;
  box.scrollTop = box.scrollHeight;
}

log("[MQTT] Connecting...");

client.on("connect", () => {
  log("[MQTT] Connected");

  client.subscribe("/esp32/status");
  client.subscribe("/esp32/log");
});

/* ---------------------------------------------------
   MQTT On Message
--------------------------------------------------- */
client.on("message", (topic, payload) => {
  const msg = payload.toString();

  if (topic === "/esp32/status") {
    let j = JSON.parse(msg);

    ssid.innerText = j.ssid;
    rssi.innerText = j.rssi;
    ip.innerText = j.ip;

    // LED ìƒíƒœ ì—…ë°ì´íŠ¸
    if (j.led == 1) {
      ledState.innerText = "ON";
      ledState.classList.remove("bg-slate-700");
      ledState.classList.add("bg-green-600");
    } else {
      ledState.innerText = "OFF";
      ledState.classList.remove("bg-green-600");
      ledState.classList.add("bg-slate-700");
    }

    log("[STATUS] " + msg);
  }

  if (topic === "/esp32/log") {
    log("[ESP] " + msg);
  }
});

/* ---------------------------------------------------
   Publish Commands
--------------------------------------------------- */
function sendLED(v) {
  client.publish("/esp32/cmd/led", String(v));
  log("[CMD] LED=" + v);
}

function sendReset() {
  client.publish("/esp32/cmd/reset", "1");
  log("[CMD] RESET");
}

</script>

</body>
</html>
