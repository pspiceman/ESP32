<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ESP32 MQTT Dashboard</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
#logBox {
  white-space: pre-wrap;
  height: 220px;
  background: #000;
  color: #0f0;
  padding: 10px;
  overflow-y: auto;
  border: 1px solid #444;
  font-family: Consolas, monospace;
  font-size: 0.85rem;
}
.value {
  font-size: 1.6rem;
  font-weight: bold;
  padding: 10px;
}
</style>
</head>

<body class="bg-slate-900 text-slate-200">

<div class="max-w-2xl mx-auto py-10 px-4">

  <h1 class="text-3xl font-bold mb-6 text-center">ESP32 MQTT Dashboard</h1>

  <!-- Status -->
  <div class="value bg-slate-800 border border-slate-600 rounded-xl text-center mb-6 p-4">
    SSID: <span id="ssid">--</span><br>
    RSSI: <span id="rssi">--</span> dBm<br>
    IP: <span id="ip">--</span>
  </div>

  <div class="flex justify-center space-x-4 mb-4">
    <button onclick="sendLED(1)" class="bg-green-600 px-5 py-2 rounded">LED ON</button>
    <button onclick="sendLED(0)" class="bg-yellow-600 px-5 py-2 rounded">LED OFF</button>
    <button onclick="sendReset()" class="bg-red-600 px-5 py-2 rounded">Soft Reset</button>
  </div>

  <div id="logBox"></div>

</div>

<script>
/* ---------------------------------------------------
   MQTT Connect (HiveMQ Broker)
--------------------------------------------------- */
let broker = "wss://broker.hivemq.com:8884/mqtt";
let clientID = "esp32_webui_" + Math.random().toString(16).substr(2, 8);
let client = mqtt.connect(broker, { clientId: clientID });

function log(msg){
  let box = document.getElementById("logBox");
  box.textContent += msg + "\n";
  box.scrollTop = box.scrollHeight;
}

log("[MQTT] Connecting...");

/* ---------------------------------------------------
   MQTT On Connect
--------------------------------------------------- */
client.on("connect", function () {
  log("[MQTT] Connected");

  // Subscribe to ESP32 topics
  client.subscribe("esp32/status");
  client.subscribe("esp32/log");
});

/* ---------------------------------------------------
   MQTT On Message
--------------------------------------------------- */
client.on("message", function (topic, msg) {
  let data = msg.toString();

  if (topic === "esp32/status") {
    let obj = JSON.parse(data);
    document.getElementById("ssid").innerText = obj.ssid;
    document.getElementById("rssi").innerText = obj.rssi;
    document.getElementById("ip").innerText = obj.ip;
  }

  if (topic === "esp32/log") {
    log("[ESP] " + data);
  }
});

/* ---------------------------------------------------
   Publish Commands
--------------------------------------------------- */
function sendLED(v){
  client.publish("esp32/cmd/led", v.toString());
  log("[CMD] LED=" + v);
}

function sendReset(){
  client.publish("esp32/cmd/reset", "1");
  log("[CMD] Reset sent");
}
</script>

</body>
</html>
