<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">

<!-- GitHub Pages(HTTPS) → ESP32(HTTP) 요청 허용 -->
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ESP32 Status Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.valueBox {
  font-size: 2rem;
  font-weight: bold;
  text-align: center;
  padding: 10px;
}
</style>
</head>

<body class="bg-slate-900 text-slate-100">

<div class="max-w-2xl mx-auto py-10 px-4">

  <h1 class="text-3xl font-bold mb-6 text-center">ESP32 Status</h1>

  <!-- SSID / RSSI / IP 표시 -->
  <div class="valueBox bg-slate-800 border border-slate-700 rounded-xl mb-6 p-6">
    SSID: <span id="ssidValue">--</span><br>
    RSSI: <span id="rssiValue">--</span> dBm<br>
    IP: <span id="ipValue">--</span>
  </div>

  <!-- 컨트롤 버튼 -->
  <div class="mt-10 flex justify-center space-x-4">
    <button onclick="sendLED(1)"
            class="bg-green-600 hover:bg-green-700 px-5 py-2 rounded font-bold">
      LED ON
    </button>

    <button onclick="sendLED(0)"
            class="bg-yellow-600 hover:bg-yellow-700 px-5 py-2 rounded font-bold">
      LED OFF
    </button>

    <button onclick="sendReset()"
            class="bg-red-600 hover:bg-red-700 px-5 py-2 rounded font-bold">
      Soft Reset
    </button>
  </div>

</div>

<script>
let espIP = null;

/* -----------------------------
   상태 요청
------------------------------*/
async function updateStatus() {
  if (!espIP) return;

  try {
    const r = await fetch(`http://${espIP}/status`, { mode: "cors" });
    const j = await r.json();

    document.getElementById("ssidValue").innerText = j.ssid;
    document.getElementById("rssiValue").innerText = j.rssi;
    document.getElementById("ipValue").innerText = j.ip;

  } catch (e) {
    console.log("[Status Failed]");
  }
}

/* -----------------------------
   LED 제어 (Active LOW)
------------------------------*/
function sendLED(state) {
  if (!espIP) return;
  fetch(`http://${espIP}/led?state=${state}`, { mode: "cors" });
}

/* -----------------------------
   원격 리셋
------------------------------*/
function sendReset() {
  if (!espIP) return;
  fetch(`http://${espIP}/reset`, { mode: "cors" });
}

/* -----------------------------
   자동 IP 탐지
------------------------------*/
async function autoDetectIP() {

  // 마지막 성공한 IP 사용
  let last = localStorage.getItem("esp32_last_ip");
  if (last) {
    espIP = last;
    updateStatus();
    return;
  }

  // 공유기 대역 스캔
  let candidates = [
    "http://192.168.0.255",
    "http://192.168.1.255",
    "http://192.168.31.255",
    "http://192.168.10.255"
  ];

  for (let url of candidates) {
    try {
      let r = await fetch(url + "/esp32-ip", { mode: "cors" });
      let ip = (await r.text()).trim();
      if (ip.startsWith("192.")) {
        espIP = ip;
        localStorage.setItem("esp32_last_ip", ip);
        updateStatus();
        return;
      }
    } catch (e) {}
  }

  console.log("[ESP32 IP Auto Detect Failed]");
}

/* ----------------------------- */

window.onload = () => {
  autoDetectIP();
  setInterval(updateStatus, 3000);  // 3초마다 자동 갱신
};
</script>

</body>
</html>
