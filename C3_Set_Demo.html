<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ESP32+HiveMQ ë°ëª¨ ë³´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root {
      --bg: #f5f5f5;
      --fg: #111827;
      --subtle: #6b7280;
      --muted: #9ca3af;
      --card-bg: #ffffff;
      --metric-bg: #fafafa;
      --shadow: 0 2px 6px rgba(0,0,0,0.08);
      --log-bg: #111827;
      --log-fg: #e5e7eb;
      --border-soft: rgba(0,0,0,0.06);
    }

    body[data-theme="dark"] {
      --bg: #020617;
      --fg: #e5e7eb;
      --subtle: #9ca3af;
      --muted: #6b7280;
      --card-bg: #020617;
      --metric-bg: #020617;
      --shadow: 0 2px 10px rgba(0,0,0,0.55);
      --log-bg: #020617;
      --log-fg: #e5e7eb;
      --border-soft: rgba(148,163,184,0.4);
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--fg);
      margin: 0;
      padding: 16px;
      transition: background 0.25s ease, color 0.25s ease;
    }

    h1 { margin-top: 0; font-size: 1.5rem; }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 12px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      border: 1px solid var(--border-soft);
      transition: background 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
    }

    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      background: #9ca3af;
    }
    .status-ok { background: #22c55e; }
    .status-bad { background: #ef4444; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }

    .metric {
      background: var(--metric-bg);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      border: 1px solid var(--border-soft);
      transition: background 0.25s ease, border-color 0.25s ease;
    }
    .metric-label { font-size: 0.8rem; color: var(--subtle); }
    .metric-value { font-size: 1.3rem; font-weight: 600; margin-top: 4px; }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-right: 8px;
      margin-top: 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.2s ease, color 0.2s ease;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    #btnOn { background: #2ecc71; color: #fff; box-shadow: 0 2px 6px rgba(34,197,94,0.4); }
    #btnOff { background: #e74c3c; color: #fff; box-shadow: 0 2px 6px rgba(239,68,68,0.4); }

    .theme-toggle {
      background: transparent;
      color: var(--subtle);
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 10px;
      font-size: 0.8rem;
      line-height: 1;
      margin: 0;
      margin-top: -4px;
      box-shadow: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .theme-toggle-icon { font-size: 1.1rem; }

    #log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      max-height: 200px;
      overflow-y: auto;
      background: var(--log-bg);
      color: var(--log-fg);
      padding: 8px;
      border-radius: 8px;
      white-space: pre-wrap;
      border: 1px solid var(--border-soft);
      transition: background 0.25s ease, color 0.25s ease, border-color 0.25s ease;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      padding: 2px 4px;
      border-radius: 4px;
      background: rgba(148,163,184,0.15);
    }
  </style>
</head>
<body data-theme="light">
  <header class="page-header">
    <h1>ESP32+HiveMQ ë°ëª¨ ë³´ë“œ</h1>
    <button id="themeToggle" class="theme-toggle" type="button" aria-label="í…Œë§ˆ ì „í™˜">
      <span class="theme-toggle-icon">ğŸŒ</span>
    </button>
  </header>

  <!-- ë¸Œë¡œì»¤/ì¥ë¹„ ìƒíƒœ -->
  <div class="card">
    <div>
      <span id="mqttDot" class="status-dot"></span>
      <strong id="mqttState">MQTT ì—°ê²° ëŒ€ê¸° ì¤‘...</strong>
    </div>
    <div style="margin-top:4px;font-size:0.85rem;color:var(--subtle);">
      ë¸Œë¡œì»¤: <code>broker.hivemq.com</code><br>
      Web: <code>WSS 8884</code> / ESP32: <code>1883</code>
    </div>
    <div style="margin-top:4px;font-size:0.8rem;color:var(--muted);">
      ì¥ë¹„ ìƒíƒœ: <span id="deviceState">ì•Œ ìˆ˜ ì—†ìŒ</span>
    </div>
    <div style="margin-top:4px;font-size:0.8rem;color:var(--muted);">
      ë§ˆì§€ë§‰ ìˆ˜ì‹  ì‹œê°: <span id="lastUpdate">-</span>
    </div>
  </div>

  <!-- ì„¼ì„œê°’/ìƒíƒœ -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">ì„¼ì„œ ìƒíƒœ (esp32c3/status)</h2>
    <div class="grid">
      <div class="metric">
        <div class="metric-label">ì˜¨ë„</div>
        <div class="metric-value"><span id="valTemp">--</span> Â°C</div>
      </div>
      <div class="metric">
        <div class="metric-label">ìŠµë„</div>
        <div class="metric-value"><span id="valHum">--</span> %</div>
      </div>
      <div class="metric">
        <div class="metric-label">COâ‚‚</div>
        <div class="metric-value"><span id="valCo2">--</span> ppm</div>
      </div>
      <div class="metric">
        <div class="metric-label">ì¼ì‚¬ëŸ‰</div>
        <div class="metric-value"><span id="valSolar">--</span> W/mÂ²</div>
      </div>
      <div class="metric">
        <div class="metric-label">LED ìƒíƒœ</div>
        <div class="metric-value"><span id="valLed">--</span></div>
      </div>
      <div class="metric">
        <div class="metric-label">WiFi RSSI</div>
        <div class="metric-value"><span id="valRssi">--</span> dBm</div>
      </div>
    </div>
  </div>

  <!-- LED ì œì–´ -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">LED ì œì–´ (esp32c3/led)</h2>
    <button id="btnOn">LED ON</button>
    <button id="btnOff">LED OFF</button>
    <div id="cmdResult" style="margin-top:8px;font-size:0.8rem;color:var(--subtle);">-</div>
  </div>

  <!-- ë¡œê·¸ -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">ë¡œê·¸</h2>
    <div id="log"></div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    const mqttStateEl   = $("#mqttState");
    const mqttDotEl     = $("#mqttDot");
    const deviceStateEl = $("#deviceState");
    const lastUpdateEl  = $("#lastUpdate");
    const logEl         = $("#log");
    const cmdResultEl   = $("#cmdResult");

    const valTemp  = $("#valTemp");
    const valHum   = $("#valHum");
    const valCo2   = $("#valCo2");
    const valSolar = $("#valSolar");
    const valLed   = $("#valLed");
    const valRssi  = $("#valRssi");

    const btnOn  = $("#btnOn");
    const btnOff = $("#btnOff");

    const themeToggleBtn  = $("#themeToggle");
    const themeToggleIcon = themeToggleBtn.querySelector(".theme-toggle-icon");

    // â”€â”€ ë‹¤í¬/ë¼ì´íŠ¸ í…Œë§ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyTheme(theme) {
      const isDark = theme === "dark";
      document.body.setAttribute("data-theme", theme);
      themeToggleIcon.textContent = isDark ? "ğŸŒ™" : "ğŸŒ";
    }

    (function initTheme() {
      const saved = localStorage.getItem("hivemq-dashboard-theme");
      let theme = "light";
      if (saved === "light" || saved === "dark") {
        theme = saved;
      } else if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
        theme = "dark";
      }
      applyTheme(theme);
    })();

    themeToggleBtn.addEventListener("click", () => {
      const current = document.body.getAttribute("data-theme") || "light";
      const next = current === "dark" ? "light" : "dark";
      localStorage.setItem("hivemq-dashboard-theme", next);
      applyTheme(next);
    });

    // â”€â”€ ë¡œê·¸ ì¶œë ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    }

    function setMqttStatus(ok, text) {
      mqttDotEl.classList.remove("status-ok", "status-bad");
      mqttDotEl.classList.add(ok ? "status-ok" : "status-bad");
      mqttStateEl.textContent = text;
    }

    function setDeviceState(alive) {
      if (alive) {
        deviceStateEl.textContent = "ì˜¨ë¼ì¸";
        deviceStateEl.style.color = "#16a34a";
      } else {
        deviceStateEl.textContent = "ì˜¤í”„ë¼ì¸";
        deviceStateEl.style.color = "#dc2626";
      }
    }

    // ===== MQTT WebSocket: broker.hivemq.com (WSS 8884) =====
    //   â†’ Chromeì—ì„œ ë³´ì•ˆ ì—°ê²° ìš”êµ¬í•˜ëŠ” ê²½ìš°ì—ë„ ë™ì‘
    const brokerUrl = "wss://broker.hivemq.com:8884/mqtt";

    const options = {
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 5000
      // public ë°ëª¨ ë¸Œë¡œì»¤ â†’ username/password ì—†ìŒ
    };

    const client = mqtt.connect(brokerUrl, options);
    let lastDeviceMsgAt = null;

    client.on("connect", () => {
      setMqttStatus(true, "MQTT ì—°ê²° OK (HiveMQ Cloud)");
      log("MQTT ì—°ê²° ì„±ê³µ (HiveMQ Cloud)");

      const topicStatus = "esp32c3/status";
      client.subscribe(topicStatus, (err) => {
        if (err) log("êµ¬ë… ì‹¤íŒ¨: " + err.message);
        else     log("êµ¬ë… ì„±ê³µ: " + topicStatus);
      });
    });

    client.on("reconnect", () => {
      setMqttStatus(false, "MQTT ì¬ì—°ê²° ì‹œë„ ì¤‘...");
      log("ì¬ì—°ê²° ì‹œë„...");
    });

    client.on("error", (err) => {
      setMqttStatus(false, "MQTT ì—ëŸ¬");
      log("ì—ëŸ¬: " + err.message);
    });

    client.on("close", () => {
      setMqttStatus(false, "MQTT ì—°ê²° ëŠê¹€");
      log("MQTT ì—°ê²° ëŠê¹€");
    });

    client.on("message", (topic, payload) => {
      const text = new TextDecoder().decode(payload);
      log(`ìˆ˜ì‹  (${topic}): ${text}`);

      const trimmed = text.trim();
      if (!trimmed.startsWith("{")) {
        // online/offline ê°™ì€ ë¬¸ìì—´ì´ë©´ ë¬´ì‹œ
        return;
      }

      let data;
      try {
        data = JSON.parse(trimmed);
      } catch (e) {
        log("JSON íŒŒì‹± ì‹¤íŒ¨");
        return;
      }

      lastDeviceMsgAt = Date.now();
      setDeviceState(data.alive !== false);

      if ("temp"  in data) valTemp.textContent  = Number(data.temp).toFixed(1);
      if ("hum"   in data) valHum.textContent   = Number(data.hum).toFixed(1);
      if ("co2"   in data) valCo2.textContent   = Number(data.co2).toFixed(0);
      if ("solar" in data) valSolar.textContent = Number(data.solar).toFixed(0);
      if ("led"   in data) valLed.textContent   = data.led ? "ON" : "OFF";
      if ("rssi"  in data) valRssi.textContent  = Number(data.rssi).toFixed(0);

      lastUpdateEl.textContent = new Date().toLocaleString();
    });

    // 10ì´ˆ ì´ìƒ ë©”ì‹œì§€ ì—†ìœ¼ë©´ ì˜¤í”„ë¼ì¸ í‘œì‹œ
    setInterval(() => {
      if (!lastDeviceMsgAt) return;
      const diff = Date.now() - lastDeviceMsgAt;
      if (diff > 10000) {
        setDeviceState(false);
      }
    }, 2000);

    // ===== LED ì œì–´ Publish =====
    function publishLed(cmd) {
      if (!client.connected) {
        cmdResultEl.textContent = "MQTTê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        return;
      }
      const topic = "esp32c3/led";
      client.publish(topic, cmd, { qos: 0, retain: false }, (err) => {
        if (err) {
          cmdResultEl.textContent = "ì „ì†¡ ì‹¤íŒ¨: " + err.message;
          log("LED publish ì‹¤íŒ¨: " + err.message);
        } else {
          cmdResultEl.textContent = `ì „ì†¡ ì™„ë£Œ: ${cmd}`;
          log(`LED ëª…ë ¹ ì „ì†¡ (${topic}): ${cmd}`);
        }
      });
    }

    btnOn.addEventListener("click", () => publishLed("LED_ON"));
    btnOff.addEventListener("click", () => publishLed("LED_OFF"));
  </script>
</body>
</html>



