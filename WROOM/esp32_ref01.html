<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ (MQTT íˆìŠ¤í† ë¦¬)</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
:root{--bg:#0b1020;--card:#131a2b;--txt:#e8eefc;--mut:#9fb2d7;--line:#22314f;--btn-bg:#1b2b4a;--btn-border:#2c3e63}
:root.light{--bg:#f5f7fa;--card:#ffffff;--txt:#0b1020;--mut:#5a6b8a;--line:#ccd4e0;--btn-bg:#e4e8ef;--btn-border:#b0bacb}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--txt);
  font:15px/1.5 system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif;
}
.wrap{max-width:1100px;margin:20px auto;padding:0 12px}
.card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h1{margin:0 0 8px;font-size:26px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
.mut{margin:0 0 4px;color:var(--mut)}
.mut.small{font-size:13px}
.theme-toggle{cursor:pointer;font-size:22px}
.status-block{margin-bottom:4px}
.status-block p{margin:0;font-size:13px;color:var(--mut);}
.state-online{color:#4ade80;}
.state-offline{color:#f97373;}

/* ê¸°ë³¸: ì„¸ë¡œ 2ì¹¸ */
.grid{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:8px;
  margin:10px 0;
}
/* PC/ëŒ€í˜• í™”ë©´ 6ì¹¸ */
@media (min-width:900px){
  .grid{
    grid-template-columns:repeat(6,minmax(0,1fr));
  }
}
/* íƒœë¸”ë¦¿/í° ê°€ë¡œë³´ê¸°ì—ì„œë„ 6ì¹¸ */
@media (orientation:landscape) and (min-width:600px){
  .grid{
    grid-template-columns:repeat(6,minmax(0,1fr));
  }
}

.tile{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.16);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  text-align:center;
}
.tile-label{
  font-size:13px;
  color:var(--mut);
}
.v{
  font-size:24px;
  font-weight:700;
  text-align:center;
  white-space:nowrap; /* ppm ì¤„ë°”ê¿ˆ ë°©ì§€ */
}
@media (min-width:900px){
  .v{font-size:26px;}
}

hr{border:0;border-top:1px solid var(--line);margin:12px 0}
.led{display:flex;align-items:center;gap:8px;margin:10px 0}
.btn{border-radius:99px;border:1px solid var(--btn-border);background:var(--btn-bg);color:var(--txt);padding:6px 14px;font-size:14px;cursor:pointer}
.btn:hover{filter:brightness(1.1)}
.btn.on{border-color:#22c55e}
.btn.off{border-color:#f97373}
.toggle-row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.btn.toggle{font-size:13px;padding:6px 10px}
.collapsible{max-height:0;overflow:hidden;transition:max-height .25s ease,opacity .25s ease;opacity:0}
.collapsible.open{max-height:600px;opacity:1}
.tablewrap{margin-top:6px;overflow:auto;border-radius:10px;border:1px solid var(--line)}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:5px 8px;border-bottom:1px solid #111827;text-align:right;white-space:nowrap}
th:first-child,td:first-child{text-align:left}
thead{background:rgba(15,23,42,.9)}
tbody tr:nth-child(even){background:rgba(15,23,42,.9)}
tbody tr:nth-child(odd){background:rgba(15,23,42,.8)}
.light thead{background:#e5e9f2}
.light tbody tr:nth-child(even){background:#f3f4f7}
.light tbody tr:nth-child(odd){background:#ffffff}
.light th,.light td{border-bottom:1px solid #d1d5db}
.charts{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
.chart{border-radius:10px;border:1px solid var(--line);padding:8px 8px 10px;background:rgba(0,0,0,.18)}
.chart h3{margin:0 0 4px;font-size:14px}
.legend{display:flex;flex-wrap:wrap;gap:6px;font-size:11px;color:var(--mut);margin-bottom:4px}
.legend .item{display:inline-flex;align-items:center;gap:4px}
.legend .swatch{display:inline-block;width:10px;height:10px;border-radius:999px}
.legend .swatch.blue{background:#60a5fa}
.legend .swatch.orange{background:#fb923c}
.canvas-wrap{width:100%;height:120px;border-radius:8px;border:1px solid var(--line);background:#020617;overflow:hidden}
canvas{width:100%;height:100%;display:block}
.bottomRow{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;color:var(--mut);margin-top:10px}
#rssiText{font-size:12px;margin:0}
.timeText{font-size:12px;white-space:nowrap;margin:0 2px 0 0}

/* ë””ë²„ê·¸ ë²„íŠ¼ + íŒ¨ë„ */
.debug-toggle{
  position:fixed;
  right:14px;
  bottom:14px;
  width:32px;
  height:32px;
  border-radius:999px;
  border:1px solid var(--line);
  background:var(--card);
  color:var(--txt);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,.4);
  z-index:9999;
}
.debug-toggle:hover{filter:brightness(1.1);}
.debug-panel{
  position:fixed;
  right:14px;
  bottom:54px;
  width:320px;
  max-height:40vh;
  background:var(--card);
  color:var(--txt);
  border-radius:12px;
  border:1px solid var(--line);
  box-shadow:0 16px 40px rgba(0,0,0,.6);
  display:none;
  flex-direction:column;
  overflow:hidden;
  z-index:9998;
  font-size:11px;
}
.debug-panel.open{display:flex;}
.debug-header{
  display:flex;
  align-items:center;
  padding:6px 10px;
  border-bottom:1px solid var(--line);
  background:rgba(0,0,0,.15);
}
.debug-title{
  font-weight:600;
  font-size:11px;
}
.debug-header-btns{
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:4px;
}
.debug-btn{
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.25);
  color:var(--mut);
  font-size:11px;
  cursor:pointer;
  padding:2px 8px;
}
.debug-btn:hover{
  color:var(--txt);
  background:rgba(255,255,255,.05);
}
.debug-body{
  margin:0;
  padding:6px 8px;
  white-space:pre-wrap;
  word-break:break-all;
  overflow:auto;
  flex:1;
  font-family:ui-monospace,Menlo,Consolas,monospace;
}
</style>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>ESP32 ì„¼ì„œ ëŒ€ì‹œë³´ë“œ <span class="theme-toggle" id="themeToggle">ğŸŒ™</span></h1>
  <p class="mut">AHT25(ì˜¨/ìŠµ) + SCD42(ì˜¨/ìŠµ/COâ‚‚) Â· LEDì œì–´</p>

  <div class="status-block">
    <p id="mqttLine">MQTT: ì—°ê²° ëŒ€ê¸° ì¤‘...</p>
    <p>ë¸Œë¡œì»¤: HiveMQ Cloud</p>
    <p id="devState">ì¥ë¹„ ìƒíƒœ: <span id="devStateVal" class="state-offline">ì˜¤í”„ë¼ì¸</span></p>
  </div>

  <div class="grid">
    <div class="tile"><div class="tile-label">AHT25 ì˜¨ë„</div><div id="aht_t" class="v">--.- Â°C</div></div>
    <div class="tile"><div class="tile-label">AHT25 ìŠµë„</div><div id="aht_h" class="v">-- %</div></div>
    <div class="tile"><div class="tile-label">SCD42 ì˜¨ë„</div><div id="scd_t" class="v">--.- Â°C</div></div>
    <div class="tile"><div class="tile-label">SCD42 ìŠµë„</div><div id="scd_h" class="v">-- %</div></div>
    <div class="tile"><div class="tile-label">COâ‚‚ ê³µê¸°</div><div id="scd_c" class="v">---- ppm</div></div>
    <div class="tile"><div class="tile-label">LED ìƒíƒœ</div><div id="ledTile" class="v">--</div></div>
  </div>

  <hr>
  <div class="led">
    <button id="on"  class="btn on">LED ON</button>
    <button id="off" class="btn off">LED OFF</button>
  </div>

  <hr>
  <div class="toggle-row">
    <button class="btn toggle" id="toggleTable">ğŸ“‹ í…Œì´ë¸” ë³´ê¸°</button>
    <button class="btn toggle" id="toggleGraph">ğŸ“Š ê·¸ë˜í”„ ë³´ê¸°</button>
  </div>

  <div id="tableSection" class="collapsible">
    <div class="tablewrap">
      <table>
        <thead>
          <tr>
            <th>ì‹œê°„</th>
            <th>AHT&nbsp;Â°C</th><th>AHT&nbsp;%</th>
            <th>SCD&nbsp;Â°C</th><th>SCD&nbsp;%</th>
            <th>COâ‚‚</th><th>LED</th>
          </tr>
        </thead>
        <tbody id="logtbl"></tbody>
      </table>
    </div>
  </div>

  <div id="graphSection" class="collapsible">
    <div class="charts">
      <div class="chart">
        <h3>ì˜¨ë„ (Â°C) â€” ìµœê·¼ 60ë¶„</h3>
        <div class="legend">
          <span class="item"><i class="swatch blue"></i>AHT25 ì˜¨ë„</span>
          <span class="item"><i class="swatch orange"></i>SCD42 ì˜¨ë„</span>
        </div>
        <div class="canvas-wrap"><canvas id="chTemp"></canvas></div>
      </div>
      <div class="chart">
        <h3>ìŠµë„ (%) â€” ìµœê·¼ 60ë¶„</h3>
        <div class="legend">
          <span class="item"><i class="swatch blue"></i>AHT25 ìŠµë„</span>
          <span class="item"><i class="swatch orange"></i>SCD42 ìŠµë„</span>
        </div>
        <div class="canvas-wrap"><canvas id="chHum"></canvas></div>
      </div>
      <div class="chart">
        <h3>COâ‚‚ (ppm) â€” ìµœê·¼ 60ë¶„</h3>
        <div class="legend">
          <span class="item"><i class="swatch blue"></i>SCD42 COâ‚‚</span>
        </div>
        <div class="canvas-wrap"><canvas id="chCO2"></canvas></div>
      </div>
    </div>
  </div>

  <div class="bottomRow">
    <p id="rssiText">RSSI: -- [dBm]</p>
    <p class="timeText" id="ts">--:--:--</p>
  </div>
</div></div>

<!-- ë””ë²„ê·¸ íŒ¨ë„ -->
<button id="debugToggle" class="debug-toggle" title="Debug panel">ğŸ</button>
<div id="debugPanel" class="debug-panel">
  <div class="debug-header">
    <span class="debug-title">Debug console</span>
    <div class="debug-header-btns">
      <button id="debugCopy" class="debug-btn" title="ë¡œê·¸ ì „ì²´ ë³µì‚¬">ğŸ“‹ ì „ì²´ë³µì‚¬</button>
      <button id="debugClose" class="debug-btn" title="ë‹«ê¸°">âœ•</button>
    </div>
  </div>
  <pre id="debugLog" class="debug-body"></pre>
</div>

<script>
const $=s=>document.querySelector(s);

/* ===== Debug helper ===== */
const debugPanel   = $('#debugPanel');
const debugToggle  = $('#debugToggle');
const debugClose   = $('#debugClose');
const debugCopyBtn = $('#debugCopy');
const debugLogArea = $('#debugLog');

function dbg(msg){
  if(!debugLogArea) return;
  const t = new Date().toLocaleTimeString();
  debugLogArea.textContent += `[${t}] ${msg}\n`;
  debugLogArea.scrollTop = debugLogArea.scrollHeight;
}

if(debugToggle){
  debugToggle.addEventListener('click',()=>{
    debugPanel.classList.toggle('open');
  });
}
if(debugClose){
  debugClose.addEventListener('click',()=>{
    debugPanel.classList.remove('open');
  });
}
if(debugCopyBtn){
  debugCopyBtn.addEventListener('click', async ()=>{
    const text = debugLogArea ? debugLogArea.textContent : '';
    if(!text) return;
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
      }else{
        const range = document.createRange();
        range.selectNodeContents(debugLogArea);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        document.execCommand('copy');
        sel.removeAllRanges();
      }
      dbg('log copied to clipboard');
    }catch(e){
      dbg('copy failed: '+e);
    }
  });
}
dbg('Dashboard script loaded');

/* ===== í…Œë§ˆ ===== */
const themeToggle=$('#themeToggle');
function applyTheme(t){
  document.documentElement.classList.toggle('light',t==='light');
  themeToggle.textContent=(t==='light')?'â˜€ï¸':'ğŸŒ™';
  renderAllCharts();
  dbg(`Theme set to ${t}`);
}
applyTheme(localStorage.getItem('theme')||'dark');
themeToggle.onclick=()=>{
  const t=document.documentElement.classList.contains('light')?'dark':'light';
  applyTheme(t); localStorage.setItem('theme',t);
};

/* ===== MQTT ê¸°ë³¸ ===== */
const MQTT_BROKER_URL = "wss://6c56aefe0ddb4d57977c735f5070abe8.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_OPTIONS = {
  clean: true,
  connectTimeout: 4000,
  reconnectPeriod: 5000,
  username: "mqtt_ESP32",
  password: "gomqtt_ESP32"
};
const STATUS_TOPIC  = "esp32wr/status";
const LED_TOPIC     = "esp32wr/led";
const HIST_PREFIX   = "esp32wr/history/";

let mqttClient = null;
let lastDeviceMsgAt = 0;
const mqttLine = $('#mqttLine');
const devStateValEl = $('#devStateVal');

function setMqttText(t){ if(mqttLine) mqttLine.textContent = t; dbg(`MQTT: ${t}`); }
function setDevState(isOnline){
  if(!devStateValEl) return;
  devStateValEl.textContent = isOnline ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸';
  devStateValEl.classList.toggle('state-online', isOnline);
  devStateValEl.classList.toggle('state-offline', !isOnline);
}

/* ===== ìœ í‹¸ ===== */
function toBool(v){return v===true||v===1||v==='1'||v==='true'||v==='on'||v==='ON';}
function fmtNow(){
  const d=new Date();
  const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');
  const h=String(d.getHours()).padStart(2,'0'),mi=String(d.getMinutes()).padStart(2,'0'),s=String(d.getSeconds()).padStart(2,'0');
  return `${y}-${m}-${da} ${h}:${mi}:${s}`;
}

/* ===== ìƒë‹¨ íƒ€ì¼ ìƒíƒœ ===== */
function applyStatus(s){
  const aT=Number(s.aht_t), aH=Number(s.aht_h),
        sT=Number(s.scd_t), sH=Number(s.scd_h),
        co=Number(s.co2);
  const led = toBool(s.led);

  if(!Number.isNaN(aT)) $('#aht_t').textContent=aT.toFixed(1)+' Â°C';
  if(!Number.isNaN(aH)) $('#aht_h').textContent=Math.round(aH)+' %';
  if(!Number.isNaN(sT)) $('#scd_t').textContent=sT.toFixed(1)+' Â°C';
  if(!Number.isNaN(sH)) $('#scd_h').textContent=Math.round(sH)+' %';
  if(!Number.isNaN(co)&&co>0) $('#scd_c').textContent=co+' ppm';

  const ledTile=$('#ledTile');
  if(ledTile) ledTile.textContent=led?'ON':'OFF';

  if(typeof s.rssi!=='undefined'){
    $('#rssiText').textContent = `RSSI: ${s.rssi} [dBm]`;
  }

  syncButtons(led);
}

function syncButtons(on){
  const bon=$('#on'), boff=$('#off');
  bon.classList.remove('active','dim'); boff.classList.remove('active','dim');
  if(on){ bon.classList.add('active'); boff.classList.add('dim'); }
  else  { boff.classList.add('active'); bon.classList.add('dim'); }
}

/* ===== í† ê¸€ ì„¹ì…˜ ===== */
const secTable=$('#tableSection');
const secGraph=$('#graphSection');
$('#toggleTable').onclick=()=>{
  const open=secTable.classList.toggle('open');
  $('#toggleTable').textContent=open?'ğŸ“‹ í…Œì´ë¸” ìˆ¨ê¸°ê¸°':'ğŸ“‹ í…Œì´ë¸” ë³´ê¸°';
};
$('#toggleGraph').onclick=()=>{
  const open=secGraph.classList.toggle('open');
  $('#toggleGraph').textContent=open?'ğŸ“Š ê·¸ë˜í”„ ìˆ¨ê¸°ê¸°':'ğŸ“Š ê·¸ë˜í”„ ë³´ê¸°';
  if(open) renderAllCharts();
};

/* ===== íˆìŠ¤í† ë¦¬ (MQTT ê¸°ë°˜) ===== */
let histRecords = [];
let histBuf     = [];

function upsertHistoryFromPayload(jsonText){
  let rec;
  try{
    rec = JSON.parse(jsonText);
  }catch(e){
    dbg('history JSON parse error: '+e);
    return;
  }
  if(!rec) return;

  let label = '';
  let d     = null;
  if(rec.ts){
    const nd = new Date(rec.ts);
    if(!isNaN(nd.getTime())){
      d = nd;
      const hh = String(nd.getHours()).padStart(2,'0');
      const mm = String(nd.getMinutes()).padStart(2,'0');
      label = `${hh}:${mm}`;
    }else{
      label = String(rec.ts);
    }
  }else{
    label = '(no ts)';
  }

  const key  = d ? d.getTime() : Date.now();
  const row  = {
    key,
    ts: d,
    label,
    aht_t: Number(rec.aht_t),
    aht_h: Number(rec.aht_h),
    scd_t: Number(rec.scd_t),
    scd_h: Number(rec.scd_h),
    co2  : Number(rec.co2),
    led  : toBool(rec.led)
  };

  const idx = histRecords.findIndex(r=>r.key===key);
  if(idx>=0) histRecords[idx]=row; else histRecords.push(row);

  histRecords.sort((a,b)=>a.key-b.key);
  if(histRecords.length>60) histRecords = histRecords.slice(-60);

  rebuildTableFromHistory();
  rebuildHistBuf();
  renderAllCharts();
}

function rebuildTableFromHistory(){
  const tb = $('#logtbl');
  if(!tb) return;
  tb.innerHTML = '';
  for(let i=histRecords.length-1;i>=0;i--){
    const r = histRecords[i];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.label}</td>
      <td>${Number.isFinite(r.aht_t)?r.aht_t.toFixed(1):'-'}</td>
      <td>${Number.isFinite(r.aht_h)?Math.round(r.aht_h):'-'}</td>
      <td>${Number.isFinite(r.scd_t)?r.scd_t.toFixed(1):'-'}</td>
      <td>${Number.isFinite(r.scd_h)?Math.round(r.scd_h):'-'}</td>
      <td>${Number.isFinite(r.co2)?Math.round(r.co2):'-'}</td>
      <td>${r.led?'ON':'OFF'}</td>`;
    tb.appendChild(tr);
  }
}

function rebuildHistBuf(){
  histBuf = histRecords.map(r=>({
    aht_t:r.aht_t,
    aht_h:r.aht_h,
    scd_t:r.scd_t,
    scd_h:r.scd_h,
    co2  :r.co2
  }));
}

/* ===== ì°¨íŠ¸ ===== */
const dpr=()=>window.devicePixelRatio||1;
function prepCanvas(c){
  const r=c.getBoundingClientRect();
  const w=r.width,h=r.height;
  const dprv=dpr();
  if(c.width!==w*dprv||c.height!==h*dprv){
    c.width=w*dprv;c.height=h*dprv;
  }
  const ctx=c.getContext('2d');
  ctx.setTransform(dprv,0,0,dprv,0,0);
  return ctx;
}

function drawChart(c,series){
  const ctx=prepCanvas(c); const W=c.clientWidth,H=c.clientHeight;
  const padL=42,padR=10,padT=10,padB=26,plotW=W-padL-padR,plotH=H-padT-padB;
  const light=document.documentElement.classList.contains('light');

  let vmin=Infinity,vmax=-Infinity;
  for(const arr of series){
    for(const v of arr){
      if(!Number.isFinite(v)) continue;
      if(v<vmin) vmin=v;
      if(v>vmax) vmax=v;
    }
  }
  if(!Number.isFinite(vmin)||!Number.isFinite(vmax)||vmin===vmax){
    vmin=0; vmax=1;
  }else{
    const span=vmax-vmin;
    vmin-=span*0.1; vmax+=span*0.1;
  }

  ctx.clearRect(0,0,W,H);
  ctx.fillStyle=light?'#eef1f7':'#020617';ctx.fillRect(0,0,W,H);

  ctx.strokeStyle=light?'#ccd4e0':'#22314f';
  ctx.beginPath();
  for(let g=0;g<=4;g++){
    const y=padT+plotH*g/4;
    ctx.moveTo(padL,y);ctx.lineTo(padL+plotW,y);
  }
  for(let m=0;m<=60;m+=10){
    const x=padL+plotW*(m/60);
    ctx.moveTo(x,padT);ctx.lineTo(x,padT+plotH);
  }
  ctx.stroke();

  ctx.fillStyle=light?'#5a6b8a':'#9fb2d7';
  ctx.font='11px system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='top';
  for(let m=0;m<=60;m+=10){
    const x=padL+plotW*(m/60);
    ctx.fillText((60-m)==0?'ì§€ê¸ˆ':`-${60-m}m`,x,padT+plotH+6);
  }

  ctx.textAlign='right'; ctx.textBaseline='middle';
  const span=vmax-vmin;
  const step=span/4;
  for(let g=0;g<=4;g++){
    const y=padT+plotH*g/4;
    const val=vmax-step*g;
    const txt=(Math.abs(val)<1?val.toFixed(2):val.toFixed(1));
    ctx.fillText(txt, padL-6, y);
  }

  const xAt=i=>padL+plotW*(i/59), yAt=v=>padT+((vmax-v)/(vmax-vmin))*plotH;
  const colors=['#7aa0ff','#fb923c'];
  series.forEach((arr,idx)=>{
    ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle=colors[idx%colors.length];
    let moved=false; const N=arr.length;
    for(let i=0;i<60;i++){
      const j=i-(60-N); const v=(j>=0&&j<N)?arr[j]:NaN; const x=xAt(i);
      if(Number.isFinite(v)){
        const y=yAt(v);
        if(!moved){ctx.moveTo(x,y); moved=true;} else ctx.lineTo(x,y);
      }else{
        moved=false;
      }
    }
    ctx.stroke();
  });
}

function renderAllCharts(){
  if(!$('#graphSection').classList.contains('open')) return;
  const aht_t=histBuf.map(r=>r.aht_t??NaN), scd_t=histBuf.map(r=>r.scd_t??NaN),
        aht_h=histBuf.map(r=>r.aht_h??NaN), scd_h=histBuf.map(r=>r.scd_h??NaN),
        co2  =histBuf.map(r=>r.co2??NaN);
  drawChart(document.getElementById('chTemp'),[aht_t,scd_t]);
  drawChart(document.getElementById('chHum'), [aht_h,scd_h]);
  drawChart(document.getElementById('chCO2'), [co2]);
}

/* ===== LED ì œì–´ ===== */
function publishLed(cmd){
  if(mqttClient && mqttClient.connected){
    mqttClient.publish(LED_TOPIC, cmd, {qos:0, retain:false});
    dbg(`LED via MQTT: ${cmd}`);
  }else{
    dbg('LED: MQTT not connected');
  }
}
$('#on').onclick  = ()=> publishLed("ON");
$('#off').onclick = ()=> publishLed("OFF");

/* ===== ì´ˆê¸° ë¶€íŒ… ===== */
(async()=>{
  dbg('init...');
  setInterval(()=>{ $('#ts').textContent=fmtNow(); },1000);

  setMqttText('MQTT ì ‘ì† ì¤‘...');
  mqttClient = mqtt.connect(MQTT_BROKER_URL, MQTT_OPTIONS);

  mqttClient.on('connect', ()=>{
    setMqttText('MQTT ì—°ê²° OK');
    dbg('connected, subscribing...');
    mqttClient.subscribe(STATUS_TOPIC, err=>{
      if(err) dbg('subscribe status error: '+err);
      else    dbg('subscribed: '+STATUS_TOPIC);
    });
    mqttClient.subscribe(HIST_PREFIX + "#", err=>{
      if(err) dbg('subscribe history error: '+err);
      else    dbg('subscribed: '+HIST_PREFIX+'#');
    });
  });

  mqttClient.on('reconnect', ()=> setMqttText('MQTT ì¬ì—°ê²° ì¤‘...'));
  mqttClient.on('error', (e)=> { setMqttText('MQTT ì—ëŸ¬'); dbg('MQTT error: '+e); });
  mqttClient.on('close', ()=>{
    setMqttText('MQTT ì—°ê²° ëŠê¹€');
    setDevState(false);
    dbg('MQTT closed');
  });

  mqttClient.on('message',(topic,payload)=>{
    const text = new TextDecoder().decode(payload);
    const trimmed = text.trim();
    dbg(`MQTT message: ${topic} = ${trimmed}`);

    if(topic === STATUS_TOPIC){
      lastDeviceMsgAt = Date.now();
      setDevState(true);

      let st = null;
      if(trimmed.startsWith('{')){
        try{ st = JSON.parse(trimmed); }catch(e){ dbg('status JSON parse error: '+e); return; }
      }else{
        return;
      }
      if(!st) return;
      applyStatus(st);
      return;
    }

    if(topic.startsWith(HIST_PREFIX)){
      upsertHistoryFromPayload(trimmed);
      return;
    }
  });

  setInterval(()=>{
    if(!lastDeviceMsgAt){
      setDevState(false);
      return;
    }
    const diff = Date.now()-lastDeviceMsgAt;
    setDevState(diff<=20000);
  },5000);
})();
</script>
</body>
</html>
