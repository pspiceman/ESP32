<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LoRa Mesh + MQTT Monitor</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
:root {
  --bg: #f5f6fa;
  --text: #111;
  --card: #ffffff;
  --mqtt-bg: #d8f8d8;
  --mqtt-fg: #0c6b0c;
  --accent: #3b82f6;
  --border: #cfcfcf;
  --table-alt: #eef1f5;
  --log-bg: #fff;
  --log-fg: #000;
}
[data-theme="dark"] {
  --bg: #0d111d;
  --text: #e9eef6;
  --card: #141b2d;
  --mqtt-bg: #12351a;
  --mqtt-fg: #71ff9d;
  --accent: #76a3ff;
  --border: #2b2f3b;
  --table-alt: #1b2436;
  --log-bg: #000;
  --log-fg: #00ff00;
}
body {
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, sans-serif;
  margin: 0;
  padding: 16px;
}
.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.title {
  font-size: 22px;
  font-weight: 700;
}
.theme-btn {
  font-size: 25px;
  border:none;
  background:none;
  cursor:pointer;
  color:var(--text);
}
.top-row {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:10px;
}
.mqtt-status {
  background:var(--mqtt-bg);
  color:var(--mqtt-fg);
  display:inline-block;
  padding:4px 10px;
  border-radius:8px;
  font-weight:600;
}
.reset-btn {
  padding:6px 10px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-size:13px;
  background:#ef4444;
  color:#fff;
}
.reset-btn:hover { opacity:0.9; }

.card {
  background:var(--card);
  padding:12px;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,0.18);
  margin-top:8px;
}
table {
  width:100%;
  border-collapse:collapse;
  font-size:15px;
}
th,td {
  padding:7px 4px;
  border-bottom:1px solid var(--border);
  text-align:center;
}
tr:nth-child(even){ background:var(--table-alt); }
.lowbat { color:red; font-weight:bold; }
.node-missing { color:#ff3b3b; font-weight:800; }

.debug-bar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:6px;
}
.log-toggle {
  font-size:22px;
  border:none;
  background:none;
  cursor:pointer;
  color:var(--text);
}
.log-box {
  display:none;
  margin-top:10px;
  padding:10px;
  height:220px;
  border-radius:10px;
  overflow-y:auto;
  white-space:pre-line;
  background:var(--log-bg);
  color:var(--log-fg);
  border:1px solid var(--border);
}
.time-text { font-size:12px; opacity:0.8; }
</style>
</head>
<body>

<div class="header">
  <div class="title">LoRa Mesh + MQTT Monitor</div>
  <button class="theme-btn" id="themeBtn">üåô</button>
</div>

<div class="top-row">
  <div class="mqtt-status" id="mqttState">MQTT: Ïó∞Í≤∞ÏïàÎê®</div>
  <button class="reset-btn" onclick="resetESP()">Î¶¨ÏÖã</button>
</div>

<div class="card">
  <table>
    <thead>
      <tr>
        <th>Node</th>
        <th>Bat</th>
        <th>Temp</th>
        <th>RH</th>
        <th>CO‚ÇÇ</th>
        <th>RSSI</th>
        <th>LED</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="debug-bar">
  <button class="log-toggle" onclick="toggleLog()">üêû</button>
  <div id="timeBox" class="time-text">--:--:--</div>
</div>
<div id="logBox" class="log-box"></div>

<script>
// ‚òÖ‚òÖ‚òÖ Ïó¨Í∏∞ ESP32 Í≤åÏù¥Ìä∏Ïõ®Ïù¥ Ïã§Ï†ú IPÎ°ú Î∞îÍøîÏ§ò ‚òÖ‚òÖ‚òÖ
const ESP = "http://192.168.31.200";

let client;
let nodes = {};   // id -> {bat,t,rh,co2,rssi,led,last}

/* Îã§ÌÅ¨Î™®Îìú Í∏∞Î≥∏Í∞í */
document.body.setAttribute("data-theme","dark");
document.getElementById("themeBtn").textContent = "‚òÄÔ∏è";

/* MQTT Ïó∞Í≤∞ */
function connectMQTT() {
  client = mqtt.connect(
    "wss://6c56aefe0ddb4d57977c735f5070abe8.s1.eu.hivemq.cloud:8884/mqtt",
    {
      username:"mqtt_ESP32",
      password:"gomqtt_ESP32",
      reconnectPeriod:3000
    }
  );

  client.on("connect", () => {
    mqttState.innerText = "MQTT: Ïó∞Í≤∞Îê®";
    client.subscribe("lora/node/+/data");
  });

  client.on("close", () => {
    mqttState.innerText = "MQTT: Ïó∞Í≤∞ÏïàÎê®";
  });

  client.on("message", (topic, msg) => {
    const parts = topic.split("/");
    const id = Number(parts[2]);
    if (!id || id === 99) return; // 99Î≤à ÌÖåÏä§Ìä∏ ÎÖ∏ÎìúÎäî Î¨¥Ïãú (ÏûàÎã§Î©¥)

    const data = JSON.parse(msg);

    if (!nodes[id]) nodes[id] = {};
    nodes[id] = { ...nodes[id], ...data, last: Date.now() };

    renderTable();
    addLog(`[MQTT] ${topic} ‚Üí ${msg}`);
  });
}
connectMQTT();

/* Î¶¨ÏÖã: ESP32 /reset Ìò∏Ï∂ú */
function resetESP(){
  try {
    fetch(ESP + "/reset", { method:"POST" })
      .then(()=> addLog("[RESET] " + ESP + "/reset POST sent"))
      .catch(e => addLog("[RESET] error: " + e));
  } catch(e) {
    addLog("[RESET] exception: " + e);
  }
}

/* ÌÖåÏù¥Î∏î Î†åÎçîÎßÅ: ÏûêÎèô ÎÖ∏Îìú ÌÉêÏßÄ + Î≤àÌò∏Ïàú Ï†ïÎ†¨ */
function renderTable(){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  const now = Date.now();
  const ids = Object.keys(nodes)
    .map(x => parseInt(x,10))
    .filter(n => Number.isFinite(n))
    .sort((a,b)=>a-b);

  ids.forEach(id => {
    const d = nodes[id];
    const last = d?.last || 0;
    const missing = (now - last > 8000); // 8Ï¥à Ïù¥ÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏ ÏóÜÏúºÎ©¥ OFFLINE
    const lowbat  = typeof d.bat === "number" && d.bat < 3.0;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="${missing ? 'node-missing' : ''}">${id}</td>
      <td class="${lowbat ? 'lowbat':''}">${d.bat != null ? d.bat : '--'}</td>
      <td>${d.t   != null ? d.t   : '--'}</td>
      <td>${d.rh  != null ? d.rh  : '--'}</td>
      <td>${d.co2 != null ? d.co2 : '--'}</td>
      <td>${d.rssi!= null ? d.rssi: '--'}</td>
      <td>
        <input type="checkbox"
          onchange="sendLED(${id},this.checked)"
          ${d.led ? 'checked' : ''}>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* LED Ï†úÏñ¥ (MQTT) */
function sendLED(id, checked){
  const val = checked ? 1 : 0;
  client.publish(`lora/node/${id}/cmd`, String(val));
  addLog(`[LED] node ${id} -> ${val}`);
}

/* ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ */
function toggleLog(){
  const box=document.getElementById("logBox");
  box.style.display = (box.style.display==="block")?"none":"block";
}
function addLog(t){
  const box=document.getElementById("logBox");
  box.textContent += t + "\n";
  box.scrollTop = box.scrollHeight;
}

/* ÌÖåÎßà ÌÜ†Í∏Ä */
document.getElementById("themeBtn").onclick = () => {
  const dark = document.body.getAttribute("data-theme")==="dark";
  if (dark){
    document.body.removeAttribute("data-theme");
    themeBtn.textContent = "üåô";
  } else {
    document.body.setAttribute("data-theme","dark");
    themeBtn.textContent = "‚òÄÔ∏è";
  }
};

/* ÌôîÎ©¥ ÌïòÎã® ÏãúÍ∞Ñ ÌëúÏãú */
setInterval(()=>{
  const d=new Date();
  timeBox.textContent =
    `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} `+
    `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
},1000);
</script>
</body>
</html>
