<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ESP32 MQTT Dashboard</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
  margin: 0;
  padding: 0;
  font-size: 20px;
}

/* ===== Ïï†ÎãàÎ©îÏù¥ÏÖò ===== */
.fade-in { animation: fadein 0.7s ease-out; }
@keyframes fadein {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* ===== LED ÌëúÏãú ===== */
.status-led {
  display: inline-block;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  margin-right: 6px;
}
.led-connected   { background: #22c55e; }
.led-disconnected { background: #ef4444; }

/* ===== Î°úÍ∑∏ ===== */
#logBox {
  white-space: pre-line;
  height: 220px;
  background: #000;
  color: #0f0;
  padding: 12px;
  overflow-y: auto;
  border: 1px solid #333;
  font-family: Consolas, monospace;
}
#timeBox {
  text-align: right;
  color: #aaa;
  font-size: 1rem;
  margin-top: 6px;
}

/* ===== ÌÉÄÏùº Ïπ¥Îìú ===== */
.info-card {
  background: #1e293b;
  border: 1px solid #334155;
  border-radius: 16px;
  padding: 20px;
  display: flex;
  gap: 16px;
  align-items: center;
  width: 100%;
  height: 130px;
  max-width: 500px;
  margin-left: auto;
  margin-right: auto;
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  transition: transform 0.2s ease, background 0.2s ease;
}
.info-card:hover {
  transform: scale(1.05);
  background: #2b3f52;
}

.info-icon { font-size: 3.3rem; }
.info-title { font-size: 1.7rem; font-weight: 700; }
.info-value { font-size: 2.5rem; font-weight: 900; }

/* ===== Î≤ÑÌäº ===== */
.action-btn {
  padding: 18px 28px;
  border-radius: 16px;
  font-size: 2rem;
  font-weight: 900;
  text-align: center;
  width: 100%;
  max-width: 180px;
  color: white;
  box-shadow: 0 4px 14px rgba(0,0,0,0.25);
  transition: transform 0.15s ease;
}
.action-btn:active { transform: scale(0.92); }

/* ===== Î™®Î∞îÏùº ===== */
@media (max-width: 480px) {
  .title-text { font-size: 3.7rem !important; }
  .grid-cards { grid-template-columns: 1fr 1fr !important; gap: 16px !important; }
  .info-card { height: 140px; }
  .info-title { font-size: 1.9rem; }
  .info-value { font-size: 2.6rem; }
  .info-icon { font-size: 3.7rem; }
}
</style>
</head>

<body class="bg-slate-900 text-slate-100 fade-in">

<div class="w-full mx-auto py-4 px-4">

  <!-- ===== Ï†úÎ™© ===== -->
  <h1 class="text-5xl title-text font-extrabold mb-4 text-center fade-in">
    ESP32 MQTT Dashboard
  </h1>

  <!-- ===== MQTT ÏÉÅÌÉú ÌëúÏãú ===== -->
  <div class="text-center mb-3 fade-in flex justify-center gap-3">
      <span id="mqttLed" class="status-led led-disconnected"></span>
      <span id="mqttStatusText" class="text-xl font-bold">
         MQTT Disconnected
      </span>
  </div>

  <!-- ===== Ïû•ÎπÑ ÏÉÅÌÉú (Ï†úÎ™© Î∞îÎ°ú ÏïÑÎûòÏóê Ï∂îÍ∞Ä) ===== -->
  <div class="text-center mb-6 fade-in flex justify-center gap-3">
      <span id="deviceLed" class="status-led led-disconnected"></span>
      <span id="deviceStatus" class="text-3xl font-extrabold">
         OFF LINE
      </span>
  </div>

  <!-- ===== ÌÉÄÏùº 4Í∞ú ===== -->
  <div class="grid grid-cols-2 gap-6 mb-6 place-items-center grid-cards fade-in">

    <div class="info-card">
      <div class="info-icon">üì∂</div>
      <div>
        <div class="info-title">SSID</div>
        <div id="ssid" class="info-value">--</div>
      </div>
    </div>

    <div class="info-card">
      <div class="info-icon">üì°</div>
      <div>
        <div class="info-title">RSSI</div>
        <div id="rssi" class="info-value">-- dBm</div>
      </div>
    </div>

    <div class="info-card">
      <div class="info-icon">üåê</div>
      <div>
        <div class="info-title">IP</div>
        <div id="ip" class="info-value">--</div>
      </div>
    </div>

    <div class="info-card">
      <div class="info-icon">üí°</div>
      <div>
        <div class="info-title">LED ÏÉÅÌÉú</div>
        <div id="ledState" class="info-value">--</div>
      </div>
    </div>

  </div>

  <!-- ===== Î≤ÑÌäº ===== -->
  <div class="flex justify-center button-row gap-14 my-6 fade-in">

    <button onclick="sendLED(1)"
      class="action-btn bg-green-600">
      ON
    </button>

    <button onclick="sendLED(0)"
      class="action-btn bg-yellow-500">
      OFF
    </button>

    <button onclick="sendReset()"
      class="action-btn bg-red-600">
      RESET
    </button>

  </div>

  <!-- ===== LOG ===== -->
  <div id="logBox" class="fade-in">[LOG] Ready‚Ä¶</div>
  <div id="timeBox">--:--:--</div>

</div>

<script>

/* ================== MQTT Ïó∞Í≤∞ ================== */
let client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt", {
  clientId: "espui_" + Math.random().toString(16).substr(2, 8)
});

/* MQTT ÏÉÅÌÉú ÌëúÏãú */
function setMQTTStatus(connected) {
  const led = document.getElementById("mqttLed");
  const txt = document.getElementById("mqttStatusText");

  if (connected) {
    led.className = "status-led led-connected";
    txt.innerText = "MQTT Connected";
  } else {
    led.className = "status-led led-disconnected";
    txt.innerText = "MQTT Disconnected";
  }
}

/* Ïû•ÎπÑ ÏÉÅÌÉú ÌëúÏãú */
function setDeviceStatus(connected) {
  const led = document.getElementById("deviceLed");
  const txt = document.getElementById("deviceStatus");

  if (connected) {
    led.className = "status-led led-connected";
    txt.innerText = "ON LINE";
  } else {
    led.className = "status-led led-disconnected";
    txt.innerText = "OFF LINE";
  }
}

function log(msg) {
  const box = document.getElementById("logBox");
  box.textContent += "\n" + msg;
  box.scrollTop = box.scrollHeight;
}

client.on("connect", () => {
  setMQTTStatus(true);
  setDeviceStatus(true);
  log("[MQTT] Connected");
  client.subscribe("/esp32/status");
  client.subscribe("/esp32/log");
});

client.on("close", () => {
  setMQTTStatus(false);
  setDeviceStatus(false);
  log("[MQTT] Disconnected");
});

/* ================== MQTT Î©îÏãúÏßÄ ================== */
client.on("message", (topic, payload) => {
  const msg = payload.toString();

  if (topic === "/esp32/status") {
    let j = JSON.parse(msg);

    ssid.innerText = j.ssid;
    rssi.innerText = j.rssi + " dBm";
    ip.innerText = j.ip;

    ledState.innerHTML =
      j.led == 1 ? "<span class='text-green-400 font-extrabold'>ON</span>"
                 : "<span class='text-red-400 font-extrabold'>OFF</span>";

    log("[STATUS] " + msg);
  }

  if (topic === "/esp32/log") log("[ESP] " + msg);
});

/* ================== Î≤ÑÌäº ================== */
function sendLED(v) {
  client.publish("/esp32/cmd/led", String(v));
  log("[CMD] LED=" + v);
}

function sendReset() {
  client.publish("/esp32/cmd/reset", "1");
  log("[CMD] RESET");
}

/* ================== ÏãúÍ≥Ñ ================== */
setInterval(() => {
  timeBox.innerText = new Date().toLocaleString("ko-KR", { hour12: false });
}, 1000);

</script>

</body>
</html>
