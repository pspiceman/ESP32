<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ESP32 MQTT ëŒ€ì‹œë³´ë“œ</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { margin: 0; padding: 0; font-size: 20px; }

/* ìƒíƒœ ì›í˜• LED */
.status-led {
  display: inline-block; width:20px; height:20px;
  border-radius: 50%; margin-right: 6px;
}
.led-connected { background:#22c55e; }
.led-disconnected { background:#ef4444; }

/* GPIO indicator */
.gpio-item{
  display:flex; justify-content:space-between;
  padding:10px 15px; border-bottom:1px solid #334155;
  font-size:1.3rem;
}
.gpio-icon{
  font-size:1.6rem;
  font-weight:900;
}

/* ì •ë³´ ì¹´ë“œ */
.info-card {
  background:#1e293b; border:1px solid #334155; border-radius:18px;
  padding:20px; display:flex; gap:16px; align-items:center;
  width:100%; height:140px;
  box-shadow:0 6px 18px rgba(0,0,0,0.35);
  transition:0.25s ease;
}
.info-card:hover{ transform:scale(1.04); background:#2b3f52; }

.info-icon{ font-size:3.4rem; }
.info-title{ font-size:1.6rem; font-weight:700; }
.info-value{ font-size:2.4rem; font-weight:900; }

/* ë²„íŠ¼ */
.action-btn {
  padding:18px 30px; border-radius:16px;
  font-size:2rem; font-weight:800; width:100%;
  color:white; text-align:center;
  box-shadow:0 4px 14px rgba(0,0,0,0.25);
  transition:0.15s ease;
}
.action-btn:active{ transform:scale(0.92); }

/* ë²„íŠ¼ ê·¸ë£¹ */
.button-panel {
  background:#1e293b; border:1px solid #334155; border-radius:18px;
  padding:25px 20px; width:100%!important;
  box-shadow:0 8px 20px rgba(0,0,0,0.35);
}

/* GPIO ë°•ìŠ¤ */
.gpio-panel{
  background:#1e293b; border:1px solid #334155; border-radius:18px;
  padding:20px 20px; margin-top:25px;
  box-shadow:0 8px 20px rgba(0,0,0,0.3);
}

/* ë¡œê·¸ì°½ */
#logBox{
  white-space:pre-line; height:460px; background:#0a0f16;
  color:#33ff55; padding:16px; overflow-y:auto;
  border-radius:14px; border:1px solid #223344;
  box-shadow:inset0 0 12px rgba(0,0,0,0.6);
  font-family:Consolas, monospace; font-size:1.15rem;
}

#timeBox{ text-align:right; color:#97a5b5; margin-top:6px; font-size:1rem; }

/* ëª¨ë°”ì¼ */
@media (max-width:480px){
  #mainTitle{ font-size:3.4rem !important; }
  .info-card{ height:150px !important; }
}

</style>
</head>

<body class="bg-slate-900 text-slate-100">

<div class="w-full mx-auto py-4 px-4">

  <!-- íƒ€ì´í‹€ -->
  <div class="relative mb-6 px-2 h-16 flex items-center">
    <h1 id="mainTitle"
        class="font-extrabold absolute left-1/2 top-1/2
               -translate-x-1/2 -translate-y-1/2 whitespace-nowrap text-center"
        style="font-size: clamp(3.0rem, 7vw, 5.0rem);">
        ESP32 MQTT ëŒ€ì‹œë³´ë“œ
    </h1>
    <div id="themeToggle"
         class="text-4xl cursor-pointer select-none hover:scale-110 transition ml-auto">
         ğŸŒ™
    </div>
  </div>

  <!-- MQTT + ì¥ë¹„ ìƒíƒœ -->
  <div class="text-center mb-6 flex justify-center gap-10">
      <div>
          <span id="mqttLed" class="status-led led-disconnected"></span>
          <span id="mqttStatusText" class="text-2xl font-extrabold">MQTT Disconnected</span>
      </div>
      <div>
          <span id="deviceLed" class="status-led led-disconnected"></span>
          <span id="deviceStatus" class="text-2xl font-extrabold">OFF LINE(ì¥ë¹„ìƒíƒœ)</span>
      </div>
  </div>

  <!-- ì •ë³´ ì¹´ë“œ -->
  <div class="grid grid-cols-2 gap-6 mb-6 place-items-center">

    <div class="info-card w-full">
      <div class="info-icon">ğŸ“¶</div>
      <div>
        <div class="info-title">SSID</div>
        <div id="ssid" class="info-value">--</div>
      </div>
    </div>

    <div class="info-card w-full">
      <div class="info-icon">ğŸ“¡</div>
      <div>
        <div class="info-title">RSSI</div>
        <div id="rssi" class="info-value">-- dBm</div>
      </div>
    </div>

    <div class="info-card w-full">
      <div class="info-icon">ğŸŒ</div>
      <div>
        <div class="info-title">IP</div>
        <div id="ip" class="info-value">--</div>
      </div>
    </div>

    <div class="info-card w-full">
      <div class="info-icon">ğŸ’¡</div>
      <div>
        <div class="info-title">LED ìƒíƒœ</div>
        <div id="ledState" class="info-value">--</div>
      </div>
    </div>

  </div>

  <!-- ë²„íŠ¼ -->
  <div class="button-panel w-full">
    <div class="flex justify-around w-full gap-4">
      <button onclick="sendLED(1)" class="action-btn bg-green-600">ON</button>
      <button onclick="sendLED(0)" class="action-btn bg-yellow-500">OFF</button>
      <button onclick="sendReset()" class="action-btn bg-red-600">RESET</button>
    </div>
  </div>

  <!-- GPIO íŒ¨ë„ -->
  <div class="gpio-panel w-full">
    <h2 class="text-3xl font-extrabold mb-4 text-center">GPIO ìƒíƒœ</h2>
    <div id="gpioList"></div>
  </div>

  <!-- ë¡œê·¸ -->
  <div id="logBox" class="w-full">[LOG] Ready...</div>
  <div id="timeBox" class="w-full">--:--:--</div>

</div>

<script>
/* MQTT ì—°ê²° */
let client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt", {
  clientId: "espui_" + Math.random().toString(16).substr(2,8)
});

function setMQTTStatus(ok){
  mqttLed.className = "status-led " + (ok?"led-connected":"led-disconnected");
  mqttStatusText.innerText = ok ? "MQTT Connected" : "MQTT Disconnected";
}

function setDeviceStatus(ok){
  deviceLed.className = "status-led " + (ok?"led-connected":"led-disconnected");
  deviceStatus.innerText = ok ? "ON LINE(ì¥ë¹„ìƒíƒœ)" : "OFF LINE(ì¥ë¹„ìƒíƒœ)";
}

function log(msg){
  logBox.textContent += "\n"+msg;
  logBox.scrollTop = logBox.scrollHeight;
}

/* ë§ˆì§€ë§‰ GPIO ì‹œê°„ ì²´í¬ */
let lastStatusTime = 0;

/* MQTT ì—°ê²° */
client.on("connect", ()=>{
  setMQTTStatus(true);
  log("[MQTT] Connected");
  client.subscribe("/esp32/status");
  client.subscribe("/esp32/log");
  client.subscribe("/esp32/gpio");
});

client.on("close", ()=>{
  setMQTTStatus(false);
  log("[MQTT] Disconnected");
});

/* GPIO ë Œë”ë§ í•¨ìˆ˜ (High, Low, Floating) */
function renderGpio(arr){
  let html = "";
  const pins = [0,1,2,3,4,5,6,7,8,9,10,20,21];

  for(let i=0;i<pins.length;i++){
    let icon = "";
    if(arr[i] == 1)
      icon = "<span style='color:red; font-weight:900'>ğŸ”´ HIGH</span>";
    else if(arr[i] == 0)
      icon = "<span style='color:#3b82f6; font-weight:900'>ğŸ”µ LOW</span>";
    else
      icon = "<span style='color:gray; font-weight:900'>âšª FLOATING</span>";

    html += `
      <div class="gpio-item">
         <span class="font-bold">GPIO ${pins[i]}</span>
         <span class="gpio-icon">${icon}</span>
      </div>
    `;
  }
  gpioList.innerHTML = html;
}

/* ë©”ì‹œì§€ ì²˜ë¦¬ */
client.on("message",(topic, payload)=>{
  let msg = payload.toString();

  /* ê¸°ë³¸ ìƒíƒœ */
  if(topic==="/esp32/status"){
    lastStatusTime = Date.now();
    let j = JSON.parse(msg);
    ssid.innerText = j.ssid;
    rssi.innerText = j.rssi + " dBm";
    ip.innerText = j.ip;
    ledState.innerHTML = j.led==1 ? "<span class='text-green-400 font-extrabold'>ON</span>" : "<span class='text-red-400 font-extrabold'>OFF</span>";
    setDeviceStatus(true);
    log("[STATUS] "+msg);
    return;
  }

  /* GPIO ìƒíƒœ */
  if(topic==="/esp32/gpio"){
    lastStatusTime = Date.now();
    let j = JSON.parse(msg);
    renderGpio(j.gpio);
    setDeviceStatus(true);
    log("[GPIO] "+msg);
    return;
  }

  if(topic==="/esp32/log") log("[ESP] "+msg);
});

/* LED ì œì–´ */
function sendLED(v){ client.publish("/esp32/cmd/led", String(v)); }

/* RESET */
function sendReset(){ client.publish("/esp32/cmd/reset", "1"); }

/* ì¥ë¹„ OFFLINE */
setInterval(()=>{
  if(Date.now() - lastStatusTime > 6000){
    setDeviceStatus(false);
  }
}, 2000);

/* ì‹œê³„ */
setInterval(()=>{
  timeBox.innerText = new Date().toLocaleString("ko-KR",{hour12:false});
},1000);

/* í…Œë§ˆ ì „í™˜ */
themeToggle.addEventListener("click",()=>{
  const isDay = document.documentElement.classList.toggle("day");
  themeToggle.textContent = isDay ? "â˜€ï¸" : "ğŸŒ™";
  localStorage.setItem("esp_theme", isDay?"day":"night");
});
</script>

</body>
</html>
