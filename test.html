<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ESP32 MQTT ëŒ€ì‹œë³´ë“œ</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { margin: 0; padding: 0; font-size: 20px; }

/* ----- ìƒíƒœ LED ----- */
.status-led {
  display: inline-block;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  margin-right: 6px;
}
.led-connected { background: #22c55e; }
.led-disconnected { background: #ef4444; }

/* ----- ì •ë³´ íƒ€ì¼ ----- */
.info-card {
  background: #1e293b;
  border: 1px solid #334155;
  border-radius: 18px;
  padding: 20px;
  display: flex;
  gap: 16px;
  align-items: center;
  width: 100%;
  max-width: 500px;
  height: 140px;
  margin-left: auto;
  margin-right: auto;
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  transition: 0.25s ease;
}
.info-card:hover { transform: scale(1.04); background: #2b3f52; }

.info-icon { font-size: 3.4rem; }
.info-title { font-size: 1.6rem; font-weight: 700; }
.info-value { font-size: 2.4rem; font-weight: 900; }

/* ----- ë²„íŠ¼ ----- */
.action-btn {
  padding: 18px 30px;
  border-radius: 16px;
  font-size: 2rem;
  font-weight: 800;
  width: 100%;
  max-width: 180px;
  text-align: center;
  color: white;
  box-shadow: 0 4px 14px rgba(0,0,0,0.25);
  transition: 0.15s ease;
}
.action-btn:active { transform: scale(0.92); }

/* ----- ë²„íŠ¼ íŒ¨ë„ ----- */
.button-panel {
  background: #1e293b;
  border: 1px solid #334155;
  border-radius: 18px;
  padding: 25px 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.35);
}

/* ----- ë¡œê·¸ì°½ ë””ìì¸ (í™•ëŒ€ & ê¾¸ë°ˆ) ----- */
#logBox {
  white-space: pre-line;
  height: 460px;            /* â˜… ê¸°ì¡´ë³´ë‹¤ 2ë°° ê¸¸ê²Œ */
  background: #0a0f16;
  color: #33ff55;
  padding: 16px;
  overflow-y: auto;
  border-radius: 14px;
  border: 1px solid #223344;
  box-shadow: inset 0 0 12px rgba(0,0,0,0.6);
  font-family: Consolas, monospace;
  font-size: 1.15rem;
}

/* ----- ì‹œê³„ ----- */
#timeBox {
  text-align: right;
  color: #97a5b5;
  margin-top: 6px;
  font-size: 1rem;
}

/* ----- Day Mode ----- */
.day body { background: #f4f5f7 !important; color: #1e293b !important; }
.day .info-card { background: white !important; border-color: #cbd5e1 !important; }
.day #logBox { background: white !important; color: black !important; border-color: #cbd5e1 !important; }
.day .button-panel { background: #ffffff !important; border-color: #cbd5e1 !important; }

/* ----- ëª¨ë°”ì¼ ìµœì í™” ----- */
@media (max-width: 480px) {
  #mainTitle { font-size: 3.6rem !important; }
  .info-card { height: 145px !important; }
  .grid-cards { grid-template-columns: 1fr 1fr !important; gap: 12px !important; }
}
</style>
</head>

<body class="bg-slate-900 text-slate-100">

<div class="w-full mx-auto py-4 px-4">

  <!-- ğŸ”¥ ì œëª© ì¤‘ì•™ + í…Œë§ˆ í† ê¸€ ê°™ì€ ë¼ì¸ -->
  <div class="relative mb-6 px-2 h-16 flex items-center">

    <h1 id="mainTitle"
        class="font-extrabold absolute left-1/2 top-1/2
               -translate-x-1/2 -translate-y-1/2 whitespace-nowrap text-center"
        style="font-size: clamp(3.0rem, 7vw, 5.5rem);">
        ESP32 MQTT ëŒ€ì‹œë³´ë“œ
    </h1>

    <div id="themeToggle"
         class="text-4xl cursor-pointer select-none hover:scale-110 transition ml-auto">
         ğŸŒ™
    </div>

  </div>

  <!-- MQTT + ì¥ë¹„ìƒíƒœ í‘œì‹œ -->
  <div class="text-center mb-6 flex justify-center gap-10">

      <div>
          <span id="mqttLed" class="status-led led-disconnected"></span>
          <span id="mqttStatusText" class="text-2xl font-extrabold">
              MQTT Disconnected
          </span>
      </div>

      <div>
          <span id="deviceLed" class="status-led led-disconnected"></span>
          <span id="deviceStatus" class="text-2xl font-extrabold">
              OFF LINE(ì¥ë¹„ìƒíƒœ)
          </span>
      </div>

  </div>

  <!-- ì •ë³´ íƒ€ì¼ 4ê°œ -->
  <div class="grid grid-cols-2 gap-6 mb-6 place-items-center grid-cards">

    <div class="info-card">
      <div class="info-icon">ğŸ“¶</div>
      <div>
        <div class="info-title">SSID</div>
        <div id="ssid" class="info-value">--</div>
      </div>
    </div>

    <div class="info-card">
      <div class="info-icon">ğŸ“¡</div>
      <div>
        <div class="info-title">RSSI</div>
        <div id="rssi" class="info-value">-- dBm</div>
      </div>
    </div>

    <div class="info-card">
      <div class="info-icon">ğŸŒ</div>
      <div>
        <div class="info-title">IP</div>
        <div id="ip" class="info-value">--</div>
      </div>
    </div>

    <div class="info-card">
      <div class="info-icon">ğŸ’¡</div>
      <div>
        <div class="info-title">LED ìƒíƒœ</div>
        <div id="ledState" class="info-value">--</div>
      </div>
    </div>

  </div>

  <!-- â˜… ë²„íŠ¼ íŒ¨ë„(ON/OFF/RESET ë¬¶ìŒ) -->
  <div class="w-full max-w-3xl mx-auto my-6">
    <div class="button-panel">

      <div class="flex justify-center gap-10">
        <button onclick="sendLED(1)" class="action-btn bg-green-600">ON</button>
        <button onclick="sendLED(0)" class="action-btn bg-yellow-500">OFF</button>
        <button onclick="sendReset()" class="action-btn bg-red-600">RESET</button>
      </div>

    </div>
  </div>

  <!-- ë¡œê·¸ -->
  <div id="logBox">[LOG] Ready...</div>
  <div id="timeBox">--:--:--</div>

</div>

<script>
/* MQTT ì—°ê²° */
let client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt", {
  clientId: "espui_" + Math.random().toString(16).substr(2,8)
});

/* MQTT ìƒíƒœ */
function setMQTTStatus(ok) {
  mqttLed.className = "status-led " + (ok ? "led-connected" : "led-disconnected");
  mqttStatusText.innerText = ok ? "MQTT Connected" : "MQTT Disconnected";
}

/* ì¥ë¹„ ìƒíƒœ ONLINE/OFFLINE */
function setDeviceStatus(ok) {
  deviceLed.className = "status-led " + (ok ? "led-connected" : "led-disconnected");
  deviceStatus.innerText = ok ? "ON LINE(ì¥ë¹„ìƒíƒœ)" : "OFF LINE(ì¥ë¹„ìƒíƒœ)";
}

/* ë¡œê·¸ */
function log(msg) {
  logBox.textContent += "\n" + msg;
  logBox.scrollTop = logBox.scrollHeight;
}

/* ESP32 ìƒíƒœ íƒ€ì´ë¨¸ */
let lastStatusTime = 0;

client.on("connect", () => {
  setMQTTStatus(true);
  log("[MQTT] Connected");

  client.subscribe("/esp32/status");
  client.subscribe("/esp32/log");
});

client.on("close", () => {
  setMQTTStatus(false);
  log("[MQTT] Disconnected");
});

/* ë©”ì‹œì§€ ì²˜ë¦¬ */
client.on("message", (topic, payload) => {
  const msg = payload.toString();

  if (topic === "/esp32/status") {

    lastStatusTime = Date.now();  // â˜… ESP ì‘ë‹µì‹œê°„ ê¸°ë¡

    let j = JSON.parse(msg);
    ssid.innerText = j.ssid;
    rssi.innerText = j.rssi + " dBm";
    ip.innerText = j.ip;

    ledState.innerHTML =
      j.led == 1
        ? "<span class='text-green-400 font-extrabold'>ON</span>"
        : "<span class='text-red-400 font-extrabold'>OFF</span>";

    setDeviceStatus(true);
    log("[STATUS] " + msg);
  }

  if (topic === "/esp32/log") log("[ESP] " + msg);
});

/* LED ì œì–´ */
function sendLED(v){ client.publish("/esp32/cmd/led", String(v)); }

/* RESET */
function sendReset(){ client.publish("/esp32/cmd/reset","1"); }

/* ì‹œê³„ */
setInterval(()=>{
  timeBox.innerText = new Date().toLocaleString("ko-KR", {hour12:false});
}, 1000);

/* â˜… ì¥ë¹„ OFFLINE íŒì • (6ì´ˆ ì´ìƒ ì‘ë‹µ ì—†ìŒ) */
setInterval(()=>{
  if (Date.now() - lastStatusTime > 6000){
    setDeviceStatus(false);
  }
}, 2000);

/* ğŸŒ™/â˜€ï¸ í…Œë§ˆ í† ê¸€ */
const themeToggle = document.getElementById("themeToggle");

if (localStorage.getItem("esp_theme") === "day") {
    document.documentElement.classList.add("day");
    themeToggle.textContent = "â˜€ï¸";
}

themeToggle.addEventListener("click", () => {
    const isDay = document.documentElement.classList.toggle("day");
    themeToggle.textContent = isDay ? "â˜€ï¸" : "ğŸŒ™";
    localStorage.setItem("esp_theme", isDay ? "day" : "night");
});
</script>

</body>
</html>
