<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ESP32+HiveMQ ëŒ€ì‹œ ë³´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root {
      --bg: #f5f5f5;
      --fg: #111827;
      --subtle: #6b7280;
      --muted: #9ca3af;
      --card-bg: #ffffff;
      --metric-bg: #fafafa;
      --shadow: 0 2px 6px rgba(0,0,0,0.08);
      --log-bg: #111827;
      --log-fg: #e5e7eb;
      --border-soft: rgba(0,0,0,0.06);
    }

    body[data-theme="dark"] {
      --bg: #020617;
      --fg: #e5e7eb;
      --subtle: #9ca3af;
      --muted: #6b7280;
      --card-bg: #020617;
      --metric-bg: #020617;
      --shadow: 0 2px 10px rgba(0,0,0,0.55);
      --log-bg: #020617;
      --log-fg: #e5e7eb;
      --border-soft: rgba(148,163,184,0.4);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--fg);
      margin: 0;
      padding: 16px;
      transition: background 0.25s ease, color 0.25s ease;
    }

    h1 { margin-top: 0; font-size: 1.5rem; }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 12px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      border: 1px solid var(--border-soft);
      transition: background 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
    }

    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      background: #9ca3af;
    }
    .status-ok { background: #22c55e; }
    .status-bad { background: #ef4444; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }

    .metric {
      background: var(--metric-bg);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      border: 1px solid var(--border-soft);
      transition: background 0.25s ease, border-color 0.25s ease;
    }
    .metric-label { font-size: 0.8rem; color: var(--subtle); }
    .metric-value { font-size: 1.3rem; font-weight: 600; margin-top: 4px; }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-right: 8px;
      margin-top: 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.2s ease, color 0.2s ease;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    #btnOn { background: #2ecc71; color: #fff; box-shadow: 0 2px 6px rgba(34,197,94,0.4); }
    #btnOff { background: #e74c3c; color: #fff; box-shadow: 0 2px 6px rgba(239,68,68,0.4); }

    .led-control-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 16px;
      flex-wrap: wrap;
    }
    .led-buttons button {
      min-width: 96px;
      justify-content: center;
    }
    .led-inline-status {
      display: inline-flex;
      align-items: baseline;
      font-size: 0.9rem;
    }
    .led-inline-status-label {
      margin-right: 4px;
      color: var(--subtle);
    }
    .led-inline-status-value {
      font-weight: 700;
    }


    .theme-toggle {
      background: transparent;
      color: var(--subtle);
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 10px;
      font-size: 0.8rem;
      line-height: 1;
      margin: 0;
      margin-top: -4px;
      box-shadow: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle-icon {
      font-size: 1.1rem;
    }

    #log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      max-height: 200px;
      overflow-y: auto;
      background: var(--log-bg);
      color: var(--log-fg);
      padding: 8px;
      border-radius: 8px;
      white-space: pre-wrap;
      border: 1px solid var(--border-soft);
      transition: background 0.25s ease, color 0.25s ease, border-color 0.25s ease;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      padding: 2px 4px;
      border-radius: 4px;
      background: rgba(148,163,184,0.15);
    }
  </style>
</head>
<body data-theme="light">
  <header class="page-header">
    <h1>ESP32+HiveMQ ëŒ€ì‹œ ë³´ë“œ</h1>
    <button id="themeToggle" class="theme-toggle" type="button" aria-label="í…Œë§ˆ ì „í™˜">
      <span class="theme-toggle-icon">ğŸŒ</span>
    </button>
  </header>

  <!-- ë¸Œë¡œì»¤/ì¥ë¹„ ìƒíƒœ -->
  <div class="card">
    <div>
      <span id="mqttDot" class="status-dot"></span>
      <strong id="mqttState">MQTT ì—°ê²° ëŒ€ê¸° ì¤‘...</strong>
    </div>
    <div style="margin-top:4px;font-size:0.85rem;color:var(--subtle);">
      ë¸Œë¡œì»¤: 
      <code>broker.hivemq.com</code><br>
      Web: WSS 8884 / ESP32: TLS 8883
    </div>
    <div style="margin-top:4px;font-size:0.8rem;color:var(--muted);">
      ì¥ë¹„ ìƒíƒœ: <span id="deviceState">ì•Œ ìˆ˜ ì—†ìŒ</span>
    </div>
    <div style="margin-top:4px;font-size:0.8rem;color:var(--muted);">
      ë§ˆì§€ë§‰ ìˆ˜ì‹  ì‹œê°: <span id="lastUpdate">-</span>
    </div>
  </div>

  <!-- ì„¼ì„œê°’/ìƒíƒœ -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">ì„¼ì„œ ìƒíƒœ (esp32wr/status)</h2>
    <div class="grid">
      <div class="metric">
        <div class="metric-label">AHT ì˜¨ë„</div>
        <div class="metric-value"><span id="valAhtT">--</span> Â°C</div>
      </div>
      <div class="metric">
        <div class="metric-label">AHT ìŠµë„</div>
        <div class="metric-value"><span id="valAhtH">--</span> %</div>
      </div>
      <div class="metric">
        <div class="metric-label">SCD ì˜¨ë„</div>
        <div class="metric-value"><span id="valScdT">--</span> Â°C</div>
      </div>
      <div class="metric">
        <div class="metric-label">SCD ìŠµë„</div>
        <div class="metric-value"><span id="valScdH">--</span> %</div>
      </div>
      <div class="metric">
        <div class="metric-label">COâ‚‚</div>
        <div class="metric-value"><span id="valCo2">--</span> ppm</div>
      </div>
      <div class="metric">
        <div class="metric-label">WiFi RSSI</div>
        <div class="metric-value"><span id="valRssi">--</span> dBm</div>
      </div>
    </div>
  </div>

  <!-- LED ì œì–´ -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">LED ì œì–´ (esp32wr/led)</h2>
    <div class="led-control-row">
      <div class="led-buttons">
        <button id="btnOn">LED ON</button>
        <button id="btnOff">LED OFF</button>
      </div>
      <div class="led-inline-status">
        <span class="led-inline-status-label">LED ìƒíƒœ</span>
        <span id="valLed" class="led-inline-status-value">--</span>
      </div>
    </div>
    <div id="cmdResult" style="margin-top:4px;font-size:0.8rem;color:var(--subtle);">-</div>
  </div>

  <!-- ë¡œê·¸ -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">ë¡œê·¸</h2>
    <div id="log"></div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    const mqttStateEl   = $("#mqttState");
    const mqttDotEl     = $("#mqttDot");
    const deviceStateEl = $("#deviceState");
    const lastUpdateEl  = $("#lastUpdate");
    const logEl         = $("#log");
    const cmdResultEl   = $("#cmdResult");

    const valAhtT  = $("#valAhtT");
    const valAhtH  = $("#valAhtH");
    const valScdT  = $("#valScdT");
    const valScdH  = $("#valScdH");
    const valCo2   = $("#valCo2");
    const valLed   = $("#valLed");
    const valRssi  = $("#valRssi");

    const btnOn  = $("#btnOn");
    const btnOff = $("#btnOff");

    const themeToggleBtn  = $("#themeToggle");
    const themeToggleIcon = themeToggleBtn.querySelector(".theme-toggle-icon");

    // â”€â”€ í…Œë§ˆ ì ìš© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyTheme(theme) {
      const isDark = theme === "dark";
      document.body.setAttribute("data-theme", theme);
      themeToggleIcon.textContent = isDark ? "ğŸŒ™" : "ğŸŒ";
    }

    (function initTheme() {
      const saved = localStorage.getItem("hivemq-dashboard-theme");
      let theme = "light";
      if (saved === "light" || saved === "dark") {
        theme = saved;
      } else if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
        theme = "dark";
      }
      applyTheme(theme);
    })();

    themeToggleBtn.addEventListener("click", () => {
      const current = document.body.getAttribute("data-theme") || "light";
      const next = current === "dark" ? "light" : "dark";
      localStorage.setItem("hivemq-dashboard-theme", next);
      applyTheme(next);
    });

    // â”€â”€ ë¡œê·¸ ì¶œë ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setMqttStatus(ok, text) {
      mqttDotEl.classList.remove("status-ok", "status-bad");
      if (ok) mqttDotEl.classList.add("status-ok");
      else    mqttDotEl.classList.add("status-bad");
      mqttStateEl.textContent = text;
    }

    function setDeviceState(alive) {
      if (alive) {
        deviceStateEl.textContent = "ì˜¨ë¼ì¸";
        deviceStateEl.style.color = "#16a34a";
      } else {
        deviceStateEl.textContent = "ì˜¤í”„ë¼ì¸";
        deviceStateEl.style.color = "#dc2626";
      }
    }

    // â”€â”€ HiveMQ Cloud WebSocket ì—°ê²° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const brokerUrl = "wss://6c56aefe0ddb4d57977c735f5070abe8.s1.eu.hivemq.cloud:8884/mqtt";

    const options = {
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 5000,
      username: "mqtt_ESP32",
      password: "gomqtt_ESP32"
    };

    const client = mqtt.connect(brokerUrl, options);

    let lastDeviceMsgAt = null;

    client.on("connect", () => {
      setMqttStatus(true, "MQTT ì—°ê²° OK (HiveMQ Cloud)");
      log("MQTT(HiveMQ Cloud) ì—°ê²° ì„±ê³µ");

      const topicStatus = "esp32wr/status";
      client.subscribe(topicStatus, (err) => {
        if (err) log("êµ¬ë… ì‹¤íŒ¨: " + err.message);
        else     log("êµ¬ë… ì„±ê³µ: " + topicStatus);
      });
    });

    client.on("reconnect", () => {
      setMqttStatus(false, "MQTT ì¬ì—°ê²° ì‹œë„ ì¤‘...");
      log("ì¬ì—°ê²° ì‹œë„...");
    });

    client.on("error", (err) => {
      setMqttStatus(false, "MQTT ì—ëŸ¬");
      log("ì—ëŸ¬: " + err.message);
    });

    client.on("close", () => {
      setMqttStatus(false, "MQTT ì—°ê²° ëŠê¹€");
      log("MQTT ì—°ê²° ëŠê¹€");
    });

    // â”€â”€ ì„¼ì„œ ë¼ì¸ í…ìŠ¤íŠ¸(AHT:..|SCD:..í˜•ì‹) íŒŒì‹± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyStatusLine(line) {
      // ì˜ˆ: AHT:23.4Â°C 45% | SCD:24.0Â°C 40% CO2:1112ppm | LED:OFF | RSSI: -48 [dBm]
      const ahtMatch = /AHT:\s*([0-9.\-]+)Â°C\s+([0-9.\-]+)%/.exec(line);
      const scdMatch = /SCD:\s*([0-9.\-]+)Â°C\s+([0-9.\-]+)%/.exec(line);
      const co2Match = /CO2:\s*([0-9.\-]+)ppm/.exec(line);
      const ledMatch = /LED:\s*(ON|OFF)/i.exec(line);
      const rssiMatch = /RSSI:\s*([\-0-9]+)/i.exec(line);

      if (ahtMatch) {
        valAhtT.textContent = parseFloat(ahtMatch[1]).toFixed(1);
        valAhtH.textContent = parseFloat(ahtMatch[2]).toFixed(0);
      }
      if (scdMatch) {
        valScdT.textContent = parseFloat(scdMatch[1]).toFixed(1);
        valScdH.textContent = parseFloat(scdMatch[2]).toFixed(0);
      }
      if (co2Match) {
        valCo2.textContent = parseInt(co2Match[1],10);
      }
      if (ledMatch) {
        valLed.textContent = ledMatch[1].toUpperCase();
      }
      if (rssiMatch) {
        valRssi.textContent = parseInt(rssiMatch[1],10);
      }

      lastUpdateEl.textContent = new Date().toLocaleString();
      setDeviceState(true);
    }

    // â”€â”€ MQTT ë©”ì‹œì§€ ìˆ˜ì‹  í•¸ë“¤ëŸ¬ (JSON + í…ìŠ¤íŠ¸ ëª¨ë‘ ì§€ì›) â”€â”€â”€â”€â”€â”€â”€â”€
    client.on("message", (topic, payload) => {
      const text = new TextDecoder().decode(payload);
      log(`ìˆ˜ì‹  (${topic}): ${text}`);

      lastDeviceMsgAt = Date.now();
      setDeviceState(true);

      const trimmed = text.trim();

      // 1) JSON í˜•ì‹ì¸ ê²½ìš°
      if (trimmed.startsWith("{")) {
        let data;
        try {
          data = JSON.parse(trimmed);
        } catch (e) {
          log("JSON íŒŒì‹± ì‹¤íŒ¨");
          return;
        }

        if ("aht_t" in data && data.aht_t != null) valAhtT.textContent = Number(data.aht_t).toFixed(1);
        if ("aht_h" in data && data.aht_h != null) valAhtH.textContent = Number(data.aht_h).toFixed(0);
        if ("scd_t" in data && data.scd_t != null) valScdT.textContent = Number(data.scd_t).toFixed(1);
        if ("scd_h" in data && data.scd_h != null) valScdH.textContent = Number(data.scd_h).toFixed(0);
        if ("co2"   in data && data.co2   != null) valCo2.textContent  = Number(data.co2).toFixed(0);

        if ("led" in data && data.led != null) {
          const s = String(data.led).toLowerCase();
          valLed.textContent = (s === "on") ? "ON" : "OFF";
        }
        if ("rssi" in data && data.rssi != null) {
          valRssi.textContent = Number(data.rssi).toFixed(0);
        }

        lastUpdateEl.textContent = new Date().toLocaleString();
        return;
      }

      // 2) JSONì´ ì•„ë‹ˆë¼ë©´, ì§ë ¬ í¬ë§· ë¼ì¸ìœ¼ë¡œ ê°„ì£¼í•˜ê³  íŒŒì‹±
      applyStatusLine(trimmed);
    });

    // heartbeat íƒ€ì„ì•„ì›ƒ â€“ 10ì´ˆ ì´ìƒ ë©”ì‹œì§€ ì—†ìœ¼ë©´ ì˜¤í”„ë¼ì¸ìœ¼ë¡œ í‘œì‹œ
    setInterval(() => {
      if (!lastDeviceMsgAt) return;
      const diff = Date.now() - lastDeviceMsgAt;
      if (diff > 10000) {
        setDeviceState(false);
      }
    }, 2000);

    // ===== LED ì œì–´ Publish =====
    function publishLed(cmd) {
      if (!client.connected) {
        cmdResultEl.textContent = "MQTTê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        return;
      }
      const topic = "esp32wr/led";
      client.publish(topic, cmd, { qos: 0, retain: false }, (err) => {
        if (err) {
          cmdResultEl.textContent = "ì „ì†¡ ì‹¤íŒ¨: " + err.message;
          log("LED publish ì‹¤íŒ¨: " + err.message);
        } else {
          cmdResultEl.textContent = `ì „ì†¡ ì™„ë£Œ: ${cmd}`;
          log(`LED ëª…ë ¹ ì „ì†¡ (${topic}): ${cmd}`);
        }
      });
    }

    btnOn.addEventListener("click", () => publishLed("ON"));
    btnOff.addEventListener("click", () => publishLed("OFF"));
  </script>
</body>
</html>
