<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>LoRa Mesh Gateway Monitor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>

/* ‚úÖ UI/CSS Í∑∏ÎåÄÎ°ú */
:root {
  --bg-color:#0b1020; --card-bg:#141a30; --accent:#37ff79;
  --accent-soft:rgba(55,255,121,0.15); --text-main:#f5f7ff;
  --text-sub:#9fa6c3; --border-subtle:#252b45; --danger:#ff4c4c; --ok:#37ff79;
}
*{box-sizing:border-box;}
body{
  margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;
  background:radial-gradient(circle at top,#202b4d 0,#050814 46%,#02030a 100%);
  color:var(--text-main);transition:background .25s ease,color .25s ease;font-size:16px;
}
body.theme-light{
  --bg-color:#f4f6ff;--card-bg:#ffffff;--accent:#16a34a;--accent-soft:rgba(22,163,74,0.12);
  --text-main:#111827;--text-sub:#6b7280;--border-subtle:#cbd5f5;--danger:#dc2626;--ok:#16a34a;
  background:radial-gradient(circle at top,#e5edff 0,#f9fafb 45%,#e5e7eb 100%);
}
.page{max-width:1100px;margin:0 auto;padding:16px 10px 24px;}
.header-row{display:flex;flex-direction:column;gap:8px;margin-bottom:14px;}
.title-row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
.title-area{display:flex;align-items:flex-start;gap:10px;}
.title-badge{
  width:8px;height:32px;border-radius:999px;
  background:linear-gradient(180deg,var(--accent),transparent);
  box-shadow:0 0 12px rgba(55,255,121,0.7);
}
body.theme-light .title-badge{box-shadow:0 0 10px rgba(22,163,74,0.6);}
.title-text{display:flex;flex-direction:column;gap:4px;}
.title-main{font-size:22px;font-weight:700;letter-spacing:0.02em;}
.title-sub{font-size:14px;color:var(--text-sub);}
.status-chips{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-start;}
.theme-toggle{
  border-radius:999px;padding:6px 10px;border:1px solid rgba(148,163,184,0.65);
  background:rgba(15,23,42,0.9);color:#e5e7eb;font-size:15px;
  display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:all .18s;min-width:40px;
}
body.theme-light .theme-toggle{background:#f3f4ff;color:#111827;border-color:#cbd5f5;}
.chip{
  border-radius:999px;padding:4px 10px;font-size:12px;display:inline-flex;align-items:center;gap:6px;
  border:1px solid var(--border-subtle);background:rgba(10,14,30,0.9);color:var(--text-sub);
}
body.theme-light .chip{background:#ffffff;color:var(--text-sub);border-color:#d4d4ff;}
.chip-label{font-size:11px;text-transform:uppercase;letter-spacing:0.09em;}
.chip-value{font-size:12px;font-weight:500;color:var(--text-main);}
.chip-dot{width:6px;height:6px;border-radius:999px;background:var(--danger);box-shadow:0 0 10px rgba(255,76,76,0.7);}
.chip-dot.on{background:var(--accent);box-shadow:0 0 10px rgba(55,255,121,0.9);}
.chip.ok{border-color:rgba(55,255,121,0.6);background:var(--accent-soft);color:var(--ok);padding:3px 12px;}

.device-conn-pill{
  border-radius:999px;padding:3px 14px;font-size:11px;border:1px solid var(--border-subtle);
  background:rgba(10,14,30,0.9);color:var(--text-sub);cursor:default;
  display:inline-flex;align-items:center;gap:12px;justify-content:center;
}
.device-conn-pill.online{
  background:var(--accent-soft);border-color:rgba(55,255,121,0.9);
  color:var(--ok);box-shadow:0 0 10px rgba(55,255,121,0.7);
}
.device-conn-pill.offline{
  background:rgba(127,29,29,0.30);border-color:rgba(239,68,68,0.95);
  color:#fecaca;box-shadow:0 0 8px rgba(239,68,68,0.8);
}
.device-conn-pill.waiting{
  background:rgba(59,130,246,0.15);
  border-color:rgba(59,130,246,0.8);
  color:#bfdbfe;
  box-shadow:0 0 10px rgba(59,130,246,0.45);
}
body.theme-light .device-conn-pill.online{background:rgba(22,163,74,0.12);}
body.theme-light .device-conn-pill.offline{background:rgba(248,113,113,0.12);}
body.theme-light .device-conn-pill.waiting{background:rgba(147,197,253,0.15);}
.wifi-rssi{font-size:12px;color:#cbd5e1;opacity:0.95;white-space:nowrap;font-weight:600;}
body.theme-light .wifi-rssi{color:#6b7280;opacity:0.9;}

.card{
  background:radial-gradient(circle at top left, rgba(55,255,121,0.12) 0, rgba(20,26,48,0.98) 42%, rgba(5,8,20,0.98) 100%);
  border-radius:18px;padding:12px 10px 14px;border:1px solid rgba(95,120,200,0.28);
  box-shadow:0 16px 26px rgba(0,0,0,0.5),0 0 0 1px rgba(5,10,24,0.7);
  position:relative;overflow:hidden;
}
body.theme-light .card{
  background:linear-gradient(180deg,#ffffff,#eef2ff);
  border-color:#d4d4ff;box-shadow:0 14px 30px rgba(15,23,42,0.12);
}
.card-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;position:relative;z-index:1;}
.card-title{font-size:14px;font-weight:600;text-transform:uppercase;letter-spacing:0.14em;color:#c7d0ff;}
body.theme-light .card-title{color:#4b5563;}
.tag-pill{
  font-size:11px;text-transform:uppercase;letter-spacing:0.12em;padding:5px 10px;border-radius:999px;
  border:1px solid rgba(95,120,200,0.7);background:rgba(8,10,24,0.9);color:#d4dcff;
  display:inline-flex;align-items:center;gap:6px;
}
body.theme-light .tag-pill{background:#eef2ff;border-color:#a5b4fc;color:#312e81;}
.tag-pill span.dot{width:6px;height:6px;border-radius:999px;background:#4ec9ff;box-shadow:0 0 12px rgba(78,201,255,0.9);}
.tag-pill.reset-pill{cursor:pointer;transition:transform .12s, box-shadow .12s, filter .12s;}
.tag-pill.reset-pill:hover{filter:brightness(1.1);transform:translateY(-0.5px);box-shadow:0 0 12px rgba(248,250,252,0.5);}

.device-status-card{
  margin-top:4px;padding:8px 9px;border-radius:14px;border:1px solid rgba(70,100,210,0.4);
  background:radial-gradient(circle at top left, rgba(55,255,121,0.08) 0, rgba(8,12,24,0.98) 55%);
  display:flex;align-items:center;justify-content:space-between;gap:6px;font-size:12px;position:relative;z-index:1;
}
body.theme-light .device-status-card{background:linear-gradient(180deg,#ffffff,#eef2ff);border-color:#d4d4ff;}
.device-status-left{display:flex;flex-direction:column;gap:2px;}
.dev-status-title{font-size:13px;font-weight:600;color:#dfe6ff;}
body.theme-light .dev-status-title{color:#1f2937;}
.dev-status-sub{font-size:11px;color:var(--text-sub);}
.device-status-right{display:flex;align-items:center;gap:6px;}
.status-dot{width:9px;height:9px;border-radius:999px;background:var(--danger);box-shadow:0 0 12px rgba(255,76,76,0.9);}
.status-dot.ok{background:var(--accent);box-shadow:0 0 12px rgba(55,255,121,0.95);}
.status-label{font-size:13px;font-weight:600;}
.uptime-text{font-size:11px;color:var(--text-sub);}

.table-wrap{
  position:relative;border-radius:14px;overflow-x:auto;overflow-y:hidden;border:1px solid rgba(52,72,140,0.7);
  background:radial-gradient(circle at top, rgba(40,52,120,0.45) 0, #050716 40%, #02030a 100%);
  box-shadow:inset 0 0 0 1px rgba(5,10,24,0.8);margin-top:10px;
}
body.theme-light .table-wrap{background:linear-gradient(180deg,#ffffff,#eef2ff);border-color:#d4d4ff;box-shadow:inset 0 0 0 1px rgba(99,102,241,0.15);}
table{width:100%;border-collapse:collapse;font-size:13px;table-layout:fixed;}
thead{background:linear-gradient(180deg, rgba(13,18,40,0.96), rgba(5,7,18,0.98));}
body.theme-light thead{background:linear-gradient(180deg,#f8fafc,#eef2ff);}
th,td{padding:3px 1px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:clip;}
th{font-weight:600;color:#c9d3ff;border-bottom:1px solid rgba(60,84,160,0.8);line-height:1.2;}
body.theme-light th{color:#111827;border-bottom:1px solid rgba(99,102,241,0.25);}
th .unit{display:block;font-size:11px;color:var(--text-sub);}
tbody tr:nth-child(even){background:rgba(10,14,32,0.9);}
tbody tr:nth-child(odd){background:rgba(5,8,22,0.9);}
body.theme-light tbody tr:nth-child(even){background:rgba(239,246,255,0.9);}
body.theme-light tbody tr:nth-child(odd){background:#ffffff;}
.node-id{font-weight:600;font-size:13px;color:#e8ecff;}
body.theme-light .node-id{color:#111827;}
.badge{display:inline-block;font-size:13px;color:var(--text-main);background:transparent;border:none;padding:0;}
.badge-null{display:inline-block;font-size:13px;color:var(--text-sub);background:transparent;border:none;padding:0;}
.rss{font-size:12px;color:var(--text-sub);}

body.theme-light .btn-led{background:#eef2ff;color:#111827;border-color:#a5b4fc;}
body.theme-light .btn-led[data-on="1"]{background:rgba(22,163,74,0.12);color:#065f46;border-color:rgba(22,163,74,0.8);box-shadow:0 0 10px rgba(22,163,74,0.25);}
body.theme-light .btn-led[disabled]{background:#f3f4f6;color:#6b7280;border-color:#d1d5db;}
.btn-led{
  all:unset;display:inline-flex;align-items:center;justify-content:center;
  min-width:34px;height:20px;border-radius:999px;border:1px solid rgba(80,100,220,0.7);
  background:rgba(10,14,34,0.9);cursor:pointer;font-size:12px;color:#c9d3ff;position:relative;overflow:hidden;
}
.btn-led[data-on="1"]{
  border-color:rgba(55,255,121,0.8);
  background:radial-gradient(circle at 20% 0, rgba(55,255,121,0.5), rgba(8,14,32,0.98));
  color:#eafff4;box-shadow:0 0 16px rgba(55,255,121,0.8);
}
.btn-led[disabled]{
  opacity:0.65;
  cursor:not-allowed;
  filter:grayscale(0.15);
}

.legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;font-size:12px;color:var(--text-sub);}
.legend-item{display:inline-flex;align-items:center;gap:4px;}
.rect{width:10px;height:10px;border-radius:4px;}
.rect-ok{background:rgba(55,255,121,0.35);border:1px solid rgba(55,255,121,0.9);}
.rect-off{background:rgba(255,76,76,0.2);border:1px solid rgba(255,76,76,0.9);}
.rect-na{background:rgba(148,163,184,0.15);border:1px solid rgba(148,163,184,0.7);}

.metric-mini{margin-top:6px;display:flex;flex-wrap:wrap;gap:6px;font-size:12px;color:var(--text-sub);align-items:center;}
.metric-item{padding:4px 6px;border-radius:999px;border:1px solid rgba(70,90,160,0.8);background:rgba(4,7,18,0.96);font-size:12px;}
body.theme-light .metric-item{background:#ffffff !important;border-color:rgba(99,102,241,0.25) !important;color:#111827 !important;box-shadow:0 4px 10px rgba(15,23,42,0.06) !important;}

.btn-log{
  margin-left:auto;border-radius:999px;padding:4px 9px;border:1px solid rgba(60,80,150,0.8);
  background:rgba(5,10,24,0.95);color:var(--text-sub);font-size:12px;
  display:inline-flex;align-items:center;gap:5px;cursor:pointer;transition:all .12s;
}
.btn-log.active{
  background:linear-gradient(135deg,#3b82f6,#22c55e);
  color:#f9fbff;box-shadow:0 0 12px rgba(34,197,94,0.8);border-color:transparent;
}
body.theme-light .btn-log{background:#ffffff !important;border-color:rgba(99,102,241,0.25) !important;color:#111827 !important;box-shadow:0 4px 10px rgba(15,23,42,0.06) !important;}
body.theme-light .btn-log.active{color:#ffffff !important;border-color:transparent !important;box-shadow:0 6px 14px rgba(34,197,94,0.25) !important;}

.log-box{
  margin-top:6px;padding:6px 7px;border-radius:10px;background:rgba(3,6,18,0.96);
  border:1px solid rgba(40,60,120,0.7);max-height:120px;overflow:auto;font-size:12px;display:none;
}
body.theme-light .log-box{background:#ffffff !important;border-color:rgba(99,102,241,0.18) !important;}
.log-line{margin-bottom:2px;color:#9fa8d1;}
body.theme-light .log-line{color:#374151 !important;}
.log-line span.time{color:#6b7280;margin-right:4px;}


@media (max-width: 430px){
  table{font-size:12px;}
  th{letter-spacing:0.02em;}
  th .unit{font-size:9px;}
  th,td{padding:2px 1px;}

  /* ‚úÖ Ï†ÑÏ≤¥ Ìè≠Ïù¥ ÎÑìÏñ¥ÏßÄÏßÄ ÏïäÎèÑÎ°ù 'Ï¢ÅÍ≤å' Ïû¨Î∞∞Î∂Ñ + Last OKÎßå ÏÇ¥Ïßù ÌôïÎ≥¥ */
  th:nth-child(1), td:nth-child(1){width:34px;}  /* Node */
  th:nth-child(2), td:nth-child(2){width:44px;}  /* Bat */
  th:nth-child(3), td:nth-child(3){width:44px;}  /* Temp */
  th:nth-child(4), td:nth-child(4){width:34px;}  /* RH */
  th:nth-child(5), td:nth-child(5){width:34px;}  /* Vib */
  th:nth-child(6), td:nth-child(6){width:46px;}  /* LED */
  th:nth-child(7), td:nth-child(7){width:46px;}  /* RSSI */
  th:nth-child(8), td:nth-child(8){width:52px;}  /* Last OK (K Î≥¥Ïù¥Í≤å ÏµúÏÜå ÌôïÎ≥¥) */

  /* Ìó§Îçî ÏûòÎ¶º Î∞©ÏßÄ */
  th{overflow:visible;text-overflow:clip;}
}
  th{letter-spacing:0.04em;}
  th .unit{font-size:10px;}
}


/* ‚úÖ Battery voltage highlight */
.bat-warn{ color:#f59e0b; font-weight:800; }
.bat-low{  color:#ef4444; font-weight:900; }
body.theme-light .bat-warn{ color:#d97706; }
body.theme-light .bat-low{  color:#dc2626; }

</style>
</head>
<body>

<div class="page">
  <div class="header-row">
    <div class="title-row">
      <div class="title-area">
        <div class="title-badge"></div>
        <div class="title-text">
          <div class="title-main">LoRa Mesh Gateway Monitor</div>
          <div class="title-sub">Î™®Îì† Mesh ÎÖ∏ÎìúÏùò ÏÉÅÌÉú Î™®ÎãàÌÑ∞ÎßÅ &amp; LED Ï†úÏñ¥</div>
        </div>
      </div>
      <button id="themeToggle" class="theme-toggle" type="button">
        <span class="icon" id="themeIcon">üåô</span>
      </button>
    </div>

    <div class="status-chips">
      <div class="chip">
        <span class="chip-label">MQTT</span>
        <span class="chip-dot" id="mqttDot"></span>
        <span class="chip-value" id="mqttState">Ïó∞Í≤∞ÏïàÎê®</span>
      </div>

      <div class="chip">
        <button id="deviceConn" type="button" class="device-conn-pill offline">
          <span class="conn-text">OFF LINE</span>
          <span id="wifiRssiText" class="wifi-rssi">- dBm</span>
        </button>
      </div>

      <div class="chip" id="nodeCountChip">
        <span class="chip-label">NODES</span>
        <span class="chip-value"><span id="nodeCount">0</span>Í∞ú</span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="card-title">Nodes Overview</div>
      <div class="tag-pill reset-pill" id="resetPill" onclick="openResetDialog()">
        <span class="dot"></span><span>RESET</span>
      </div>
    </div>

    <div class="device-status-card">
      <div class="device-status-left">
        <div class="dev-status-title">Device Status</div>
        <div class="dev-status-sub" id="devStatusSub">ÎßàÏßÄÎßâ Ìå®ÌÇ∑: -</div>
      </div>
      <div class="device-status-right">
        <div class="status-dot" id="devStatusDot"></div>
        <div>
          <div class="status-label" id="devStatusLabel">Idle</div>
          <div class="uptime-text" id="uptimeLabel">Uptime: -</div>
        </div>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Node</th>
            <th>Bat<span class="unit">[V]</span></th>
            <th>Temp<span class="unit">[¬∞C]</span></th>
            <th>RH<span class="unit">[%]</span></th>
            <th>Vib<span class="unit">[mm]</span></th>
            <th>LED</th>
            <th>RSSI<span class="unit">[dBm]</span></th>
            <th>Last OK<span class="unit">[s]</span></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="legend">
      <div class="legend-item"><div class="rect rect-ok"></div>Ï†ïÏÉÅ ÎÖ∏Îìú</div>
      <div class="legend-item"><div class="rect rect-off"></div>ÏùëÎãµ ÏóÜÏùå / INIT</div>
      <div class="legend-item"><div class="rect rect-na"></div>ÏÑºÏÑú Í∞í ÏóÜÏùå(NA)</div>
    </div>

    <div class="metric-mini">
      <div class="metric-item" id="metricOk">OK ÎÖ∏Îìú: 0</div>
      <div class="metric-item" id="metricFail">Fail ÎÖ∏Îìú: 0</div>
      <div class="metric-item" id="metricNA">ÏÑºÏÑú NA ÎÖ∏Îìú: 0</div>
      <button id="btnLog" class="btn-log" type="button">
        <span class="icon">üêû</span><span class="label">Î°úÍ∑∏</span>
      </button>
    </div>

    <div class="log-box" id="logBox"></div>
  </div>
</div>

<div id="resetModal" class="modal-backdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;z-index:999;">
  <div class="modal-box" style="background:#020617;border-radius:14px;padding:18px 18px 14px;border:1px solid rgba(148,163,184,0.6);max-width:320px;width:80%;color:#e5e7eb;box-shadow:0 18px 40px rgba(0,0,0,0.7);">
    <div class="modal-title" style="font-size:14px;margin-bottom:14px;">RESET Î™ÖÎ†πÏùÑ Ï†ÑÏÜ°ÌïòÍ≤†ÏäµÎãàÍπå?</div>
    <div class="modal-actions" style="display:flex;justify-content:flex-end;gap:8px;">
      <button class="modal-btn" type="button" onclick="closeResetDialog()" style="border-radius:999px;padding:6px 14px;font-size:13px;border:1px solid rgba(148,163,184,0.8);background:transparent;color:#e5e7eb;cursor:pointer;">Ï∑®ÏÜå</button>
      <button class="modal-btn primary" type="button" onclick="confirmReset()" style="border-radius:999px;padding:6px 14px;font-size:13px;border:1px solid rgba(52,211,153,0.85);background:#16a34a;color:#ecfdf5;cursor:pointer;">Ï†ÑÏÜ°</button>
    </div>
  </div>
</div>


<script>

/* ========= UPDATED LOGIC (EMPTY TABLE ON RELOAD + IGNORE RETAINED) ========= */
const MQTT_URL = "wss://broker.hivemq.com:8884/mqtt";
const ROUTER_ID = 50;

const GW_TIMEOUT_MS = 12000;
const NODE_TIMEOUT_MS   = 60000;
const ROUTER_TIMEOUT_MS = 60000;

const TOPIC_TELEM_SUB      = "tswell/lora/node/+/telemetry";
const TOPIC_LEDSTATE_SUB   = "tswell/lora/node/+/led_state";
const TOPIC_LED_CMD_PREFIX = "tswell/lora/node/";
const TOPIC_GW_CMD         = "tswell/lora/gateway/cmd";
const TOPIC_WIFI_RSSI      = "tswell/lora/gateway/wifi_rssi";

let client;
let nodes = {};
let seenOrder = [];
let lastPacket = 0;
let lastGwSeenMs = 0;
let ledPending = {};

let lastPacketCached = false;

let isReload = false;
let ignoreRetained = false;
let liveStarted = false;

const startTime = Date.now();

const mqttDot   = document.getElementById("mqttDot");
const mqttState = document.getElementById("mqttState");
const nodeCountEl = document.getElementById("nodeCount");
const nodeCountChip = document.getElementById("nodeCountChip");
const deviceConn = document.getElementById("deviceConn");
const wifiRssiText = document.getElementById("wifiRssiText");
// ‚úÖ Ï¥àÍ∏∞ÏóêÎäî RSSI Í≥µÎûÄ(ÍπúÎπ°ÏûÑ Ï†úÍ±∞)
wifiRssiText.textContent = "";
const connTextEl = document.querySelector("#deviceConn .conn-text");

const devStatusDot  = document.getElementById("devStatusDot");
const devStatusLabel= document.getElementById("devStatusLabel");
const devStatusSub  = document.getElementById("devStatusSub");
const uptimeLabel   = document.getElementById("uptimeLabel");

const metricOk   = document.getElementById("metricOk");
const metricFail = document.getElementById("metricFail");
const metricNA   = document.getElementById("metricNA");

const logBox  = document.getElementById("logBox");
const btnLog  = document.getElementById("btnLog");
const themeToggle = document.getElementById("themeToggle");
const themeIcon   = document.getElementById("themeIcon");
const resetModal  = document.getElementById("resetModal");

// log
function addLog(msg){
  const now = new Date();
  const time = now.toLocaleTimeString();
  const div = document.createElement("div");
  div.className = "log-line";
  div.innerHTML = `<span class="time">[${time}]</span>${msg}`;
  logBox.appendChild(div);
  logBox.scrollTop = logBox.scrollHeight;
}
function toggleLog(){
  const visible = (logBox.style.display === "block");
  logBox.style.display = visible ? "none" : "block";
  btnLog.classList.toggle("active", !visible);
}
btnLog.addEventListener("click", toggleLog);

// theme
function applyTheme(theme){
  const isLight = (theme === "light");
  document.body.classList.toggle("theme-light", isLight);
  themeIcon.textContent = isLight ? "‚òÄÔ∏è" : "üåô";
}
function toggleTheme(){
  const isLight = document.body.classList.contains("theme-light");
  const next = isLight ? "dark" : "light";
  localStorage.setItem("lora-theme", next);
  applyTheme(next);
}
themeToggle.addEventListener("click", toggleTheme);
applyTheme(localStorage.getItem("lora-theme") || "dark");

function isAlive(id, last_ok_ms){
  if(typeof last_ok_ms !== "number") return false;
  const now = Date.now();
  const tout = (id === ROUTER_ID) ? ROUTER_TIMEOUT_MS : NODE_TIMEOUT_MS;
  return ((now - last_ok_ms) < tout);
}

function touchOrder(id){
  if(!seenOrder.includes(id)) seenOrder.push(id);
}

function connectMQTT(){
  client = mqtt.connect(MQTT_URL, { reconnectPeriod:3000 });

  client.on("connect", ()=>{
    mqttState.textContent = "Ïó∞Í≤∞Îê®";
    mqttDot.classList.add("on");

    client.subscribe(TOPIC_TELEM_SUB);
    client.subscribe(TOPIC_LEDSTATE_SUB);
    client.subscribe(TOPIC_WIFI_RSSI);

    addLog("[MQTT] connected");
    addLog("[MQTT] subscribed: telemetry + led_state + wifi_rssi");
  });

  client.on("close", ()=>{
    mqttState.textContent = "Ïó∞Í≤∞ÏïàÎê®";
    mqttDot.classList.remove("on");
    addLog("[MQTT] disconnected");
  });

  client.on("message", (topic, msg, packet)=>{
    const now = Date.now();

    if(ignoreRetained && packet && packet.retain){
      return;
    }

    if(isReload && packet && !packet.retain){
      if(!liveStarted){
        liveStarted = true;
        addLog("[LIVE] first live packet -> start rendering rows");
      }
      ignoreRetained = false;
    }

    if(topic === TOPIC_WIFI_RSSI){
      const rssi = Number(msg.toString());
      wifiRssiText.textContent = Number.isFinite(rssi) ? `${rssi} dBm` : ``;
      lastGwSeenMs = now;
      updateDeviceStatus();
      return;
    }

    if(isReload && !liveStarted){
      return;
    }

    if(topic.endsWith("/led_state")){
      const parts = topic.split("/");
      const id = Number(parts[3]);
      if(!id) return;

      touchOrder(id);

      const val = Number(msg.toString());
      const ledVal = val ? 1 : 0;

      nodes[id] = nodes[id] || {};
      nodes[id].led_confirm = ledVal;
      nodes[id].last_led_ms = now;

      if(ledPending[id] && ledPending[id].target === ledVal){
        addLog(`[LED DONE][STATE] node ${id} applied=${ledVal}`);
        delete ledPending[id];
      }

      renderTable();
      updateDeviceStatus();
      return;
    }

    if(topic.endsWith("/telemetry")){
      try{
        const parts = topic.split("/");
        const id = Number(parts[3]);
        if(!id) return;

        touchOrder(id);

        const data = JSON.parse(msg.toString());
        const ledVal = (typeof data.led === "number") ? (data.led ? 1 : 0) : 0;

        lastPacket = now;
        lastGwSeenMs = now;
        lastPacketCached = false;

        nodes[id] = nodes[id] || {};
        nodes[id].bat  = (typeof data.vbat === "number") ? data.vbat : null;
        nodes[id].t    = (typeof data.t    === "number") ? data.t    : null;
        nodes[id].rh   = (typeof data.h    === "number") ? data.h    : null;
        nodes[id].vib  = (typeof data.vib  === "number") ? data.vib  : null;
        nodes[id].led  = ledVal;
        nodes[id].rssi = (typeof data.rssi === "number") ? data.rssi : null;
        nodes[id].last_ok_ms = now;

        renderTable();
        updateDeviceStatus();
      }catch(e){
        addLog("[MQTT] telemetry parse error: " + e);
      }
    }
  });
}

(function boot(){
  let navType = "navigate";
  try{
    const nav = performance.getEntriesByType("navigation");
    if(nav && nav.length) navType = nav[0].type;
  }catch(e){}

  nodes = {};
  seenOrder = [];
  lastPacket = 0;
  lastGwSeenMs = 0;
  lastPacketCached = false;

  if(navType === "reload"){
    isReload = true;
    ignoreRetained = true;
    liveStarted = false;
    addLog("[BOOT] reload -> EMPTY table (rows=0), ignore retained, wait live");
  }else{
    // ‚úÖ Î∏åÎùºÏö∞Ï†Ä ÏÉàÎ°ú Ïó¥Í∏∞ÏóêÏÑúÎèÑ cached/retained Í∞í ÌëúÏãú Î∞©ÏßÄ
    isReload = true;
    ignoreRetained = true;
    liveStarted = false;
    addLog("[BOOT] open -> EMPTY table (rows=0), ignore retained, wait live");
  }

  renderTable();
  updateDeviceStatus();
  connectMQTT();
})();

function renderTable(){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  const ids = seenOrder.slice().sort((a,b)=>a-b);
  nodeCountEl.textContent = ids.length;
  nodeCountChip.classList.toggle("ok", ids.length>0);

  let okCount=0, failCount=0, naCount=0;
  const now = Date.now();

  ids.forEach(id=>{
    const n = nodes[id] || {};
    const alive = isAlive(id, n.last_ok_ms);

    if(typeof n.last_ok_ms === "number"){
      if(alive) okCount++; else failCount++;
    }else{
      failCount++;
    }
    if(n.t==null || n.rh==null || n.vib==null) naCount++;

    const tr = document.createElement("tr");
    
    let batClass = "";
    if(n.bat!=null){
      if(n.bat <= 3.00) batClass = "bat-low";
      else if(n.bat < 3.30) batClass = "bat-warn";
    }
    tr.innerHTML = `
      <td><span class="node-id">${id}</span></td>
      <td class="${batClass}">${n.bat!=null ? n.bat.toFixed(2) : `<span class="badge-null">NA</span>`}</td>
      <td>${n.t!=null ? n.t.toFixed(1) : `<span class="badge-null">NA</span>`}</td>
      <td>${n.rh!=null ? n.rh : `<span class="badge-null">NA</span>`}</td>
      <td>${n.vib!=null ? n.vib : `<span class="badge-null">NA</span>`}</td>
      <td>${renderLedButton(id, n)}</td>
      <td class="rss">${n.rssi!=null ? n.rssi : "-"}</td>
      <td>${(typeof n.last_ok_ms==="number") ? (Math.floor((now-n.last_ok_ms)/1000)+" s") : "-"}</td>
    `;
    tbody.appendChild(tr);
  });

  metricOk.textContent   = "OK ÎÖ∏Îìú: " + okCount;
  metricFail.textContent = "Fail ÎÖ∏Îìú: " + failCount;
  metricNA.textContent   = "ÏÑºÏÑú NA ÎÖ∏Îìú: " + naCount;
}

function renderLedButton(id, n){
  const ledBase = (typeof n.led_confirm === "number") ? (n.led_confirm ? 1 : 0) :
                  (typeof n.led === "number") ? (n.led ? 1 : 0) : 0;

  const pend = ledPending[id];
  let displayLed = ledBase;
  let label = ledBase ? "ON" : "OFF";
  let disabled = "";

  if(pend){
    displayLed = pend.target;
    label = pend.target ? "ON‚Ä¶" : "OFF‚Ä¶";
    disabled = "disabled";
  }
  return `<button class="btn-led" data-on="${displayLed?1:0}" ${disabled} onclick="onLedClick(${id},${ledBase})">${label}</button>`;
}

function onLedClick(id, ledBase){
  if(ledPending[id]) return;
  const next = (ledBase === 1) ? 0 : 1;
  sendLED(id, next===1);
}

function sendLED(id, checked){
  if(!client || !client.connected){
    alert("MQTT ÎØ∏Ïó∞Í≤∞");
    addLog("[LED] MQTT not connected");
    return;
  }
  const topic = TOPIC_LED_CMD_PREFIX + id + "/led";
  const payload = checked ? "1" : "0";

  ledPending[id] = { target: checked ? 1 : 0, ts: Date.now() };
  client.publish(topic, payload);

  addLog(`[LED CMD] publish -> ${topic} : ${payload}`);
  renderTable();
  updateDeviceStatus();

  setTimeout(()=>{
    const p = ledPending[id];
    if(!p) return;
    const age = Date.now() - p.ts;
    if(age >= 12000){
      addLog(`[LED CMD] pending timeout node ${id} -> follow led_state`);
      delete ledPending[id];
      renderTable();
      updateDeviceStatus();
    }
  }, 12500);
}

function updateDeviceStatus(){
  const now = Date.now();
  const onlineMqtt = (client && client.connected);

  const seen = Math.max(lastGwSeenMs || 0, lastPacket || 0);
  const hasAnySeen = (seen > 0);
  const gwAlive = (hasAnySeen && (now - seen) < GW_TIMEOUT_MS);

  if(!onlineMqtt){
    deviceConn.classList.remove("online","waiting");
    deviceConn.classList.add("offline");
    connTextEl.textContent = "OFF LINE";
    wifiRssiText.textContent = "";
  }else if(onlineMqtt && !gwAlive){
    // ‚úÖ GW Ìå®ÌÇ∑Ïù¥ Ïïà Îì§Ïñ¥Ïò§Î©¥ 'Waiting'ÏùÑ Ïì∞ÏßÄ ÏïäÍ≥† OFF LINEÏúºÎ°ú ÌëúÏãú (ÏöîÍµ¨ÏÇ¨Ìï≠)
    deviceConn.classList.remove("online","waiting");
    deviceConn.classList.add("offline");
    connTextEl.textContent = "OFF LINE";
    wifiRssiText.textContent = "";
  }else{
    deviceConn.classList.remove("offline","waiting");
    deviceConn.classList.add("online");
    connTextEl.textContent = "GATEWAY";
  }

  let lastStr = "-";
  if(lastPacket>0){
    const diffSec = Math.floor((now-lastPacket)/1000);
    lastStr = diffSec + "Ï¥à Ï†Ñ";
  }
  devStatusSub.textContent = "ÎßàÏßÄÎßâ Ìå®ÌÇ∑: " + lastStr;

  const upSec = Math.floor((now - startTime)/1000);
  uptimeLabel.textContent = "Uptime: " + upSec + " s";

  const ids = Object.keys(nodes).map(x=>Number(x)).filter(x=>x);
  const anyOk = ids.some(id => isAlive(id, nodes[id].last_ok_ms));

  if(anyOk){
    devStatusDot.classList.add("ok");
    devStatusLabel.textContent = "Nodes Active";
  }else{
    devStatusDot.classList.remove("ok");
    devStatusLabel.textContent = "No Active Node";
  }
}

// Reset
function openResetDialog(){
  if(!client || !client.connected){
    alert("MQTT ÎØ∏Ïó∞Í≤∞");
    addLog("[RESET] MQTT not connected");
    return;
  }
  resetModal.style.display = "flex";
}
function closeResetDialog(){ resetModal.style.display = "none"; }
function confirmReset(){
  closeResetDialog();
  client.publish(TOPIC_GW_CMD, "reset");
  addLog(`[RESET] publish -> ${TOPIC_GW_CMD} : reset`);
}

setInterval(()=>{
  renderTable();
  updateDeviceStatus();
}, 1000);
/* ========= END UPDATED LOGIC ========= */
</script>
</body>
</html>
